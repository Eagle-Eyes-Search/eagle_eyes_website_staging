// Centralized function to handle all redirect logic
function checkUserFormStatusAndRedirect() {
    // Only proceed if user is signed in
    if (firebase.auth().currentUser) {
        firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
            const hostURL = window.getHostUrl();
            // Call the Cloud Function to check if the user has filled in a form
            $.ajax({
                url: hostURL + '/has_user_already_filled_in_form',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    console.log("Got reply from has_user_already_filled_in_form:", data);
                    
                    let response;
                    try {
                        response = typeof data === 'string' ? JSON.parse(data) : data;
                    } catch (e) {
                        console.error("Error parsing response:", e);
                        response = { form: null };
                    }
                    
                    // Check if form exists
                    const hasFilledForm = response.form && Object.keys(response.form).length > 0;
                    console.log("Has user filled in form?", hasFilledForm);
                    
                    if (hasFilledForm) {
                        console.log("User already filled in form, redirecting to account.html");
                        window.location.href = 'account.html';
                    } else {
                        console.log("User has NOT filled in form, redirecting to create-account.html");
                        window.location.href = 'create-account.html';
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error checking user form status:", textStatus, errorThrown);
                }
            });
        }).catch(function(error) {
            console.error("Error getting ID token:", error);
        });
    }
}

// Ensure this function is called when auth state changes
firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        // User is signed in
        console.log("User is signed in");
        globalUser = user;
        
        // Hide login button, show signed-in info
        $("#login-button").hide();
        $("#signed-in-info").show();
        $("#user-email").text(user.email);
        
        // Check if we need to redirect the user based on form status
        checkUserFormStatusAndRedirect();
    } else {
        // User is signed out
        console.log("User is signed out");
        globalUser = null;
        
        // Show login button, hide signed-in info
        $("#login-button").show();
        $("#signed-in-info").hide();
    }
}); 