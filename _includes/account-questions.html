<section id="form">
    <p style="text-align: center;"><i>* required information</i></p>
    <form id="fields">
        <!-- First question only -->
        <label class="required" style="display: block; margin-bottom: 10px;"><b>What are you signing up for?</b></label>
        <div class="radio-group" style="margin-bottom: 20px; display: block;">
            <div class="radio-container" style="display: flex; align-items: center; margin-bottom: 12px; position: relative;">
                <input type="radio" id="trial" name="signup_type" value="trial" required style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; position: static !important; width: 20px !important; height: 20px !important; margin-right: 10px !important; cursor: pointer !important; -webkit-appearance: radio !important; -moz-appearance: radio !important; appearance: radio !important; border: 1px solid #333 !important; border-radius: 50% !important; box-shadow: none !important; outline: none !important; z-index: 999 !important; vertical-align: middle !important; margin-top: 0 !important; margin-bottom: 0 !important;" onchange="handleSignupTypeChange(this)">
                <label for="trial_option" style="display: inline-block; cursor: pointer; margin-left: 5px !important; z-index: 1 !important; vertical-align: middle !important;">I'd like to request a 30-day free trial of the software for my team.</label>
            </div>
            <div class="radio-container" style="display: flex; align-items: center; margin-bottom: 12px; position: relative;">
                <input type="radio" id="download" name="signup_type" value="download" required style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; position: static !important; width: 20px !important; height: 20px !important; margin-right: 10px !important; cursor: pointer !important; -webkit-appearance: radio !important; -moz-appearance: radio !important; appearance: radio !important; border: 1px solid #333 !important; border-radius: 50% !important; box-shadow: none !important; outline: none !important; z-index: 999 !important; vertical-align: middle !important; margin-top: 0 !important; margin-bottom: 0 !important;" onchange="handleSignupTypeChange(this)">
                <label for="existing_license" style="display: inline-block; cursor: pointer; margin-left: 5px !important; z-index: 1 !important; vertical-align: middle !important;">My team already has a license, I would like to download the software myself.</label>
            </div>
            <div class="radio-container" style="display: flex; align-items: center; margin-bottom: 12px; position: relative;">
                <input type="radio" id="purchase" name="signup_type" value="purchase" required style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; position: static !important; width: 20px !important; height: 20px !important; margin-right: 10px !important; cursor: pointer !important; -webkit-appearance: radio !important; -moz-appearance: radio !important; appearance: radio !important; border: 1px solid #333 !important; border-radius: 50% !important; box-shadow: none !important; outline: none !important; z-index: 999 !important; vertical-align: middle !important; margin-top: 0 !important; margin-bottom: 0 !important;" onchange="handleSignupTypeChange(this)">
                <label for="new_license" style="display: inline-block; cursor: pointer; margin-left: 5px !important; z-index: 1 !important; vertical-align: middle !important;">I would like to buy a new license.</label>
            </div>
        </div>

        <!-- Rest of the form in a container that's initially hidden -->
        <div id="additional-fields" style="display: none;">
            <!-- Common fields -->
            <label for="name" style="display: block; margin-bottom: 10px;"><b>Title or rank:</b> (Optional)</label>
            <input type="text" id="name" name="name" placeholder="" style="margin-bottom: 15px; margin-top: 0px;" required>

            <label for="name" class="required" style="display: block; margin-bottom: 10px;"><b>First name:</b></label>
            <input type="text" id="name" name="name" placeholder="Enter your first name" style="margin-bottom: 15px; margin-top: 0px;" required>

            <label for="name" class="required" style="display: block; margin-bottom: 10px;"><b>Last name:</b></label>
            <input type="text" id="name" name="name" placeholder="Enter your last name" style="margin-bottom: 15px; margin-top: 0px;" required>

            <!-- Dynamic content containers -->
            <div id="download-questions" style="display: none;">
                {% include account-questions-download.html %}
            </div>

            <div id="trial-questions" style="display: none;">
                {% include account-questions-trial.html %}
            </div>

            <div id="purchase-questions" style="display: none;">
                {% include account-questions-purchase.html %}
            </div>
            <!-- Terms and newsletter section -->
            <div class="checkboxes">
                <div class="checkbox-container" style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="agree_terms" name="agree_terms" required style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; position: static !important; width: 20px !important; height: 20px !important; margin-right: 10px !important; cursor: pointer !important; -webkit-appearance: checkbox !important; -moz-appearance: checkbox !important; appearance: checkbox !important; border: 1px solid #333 !important; box-shadow: none !important; outline: none !important; z-index: 999 !important; vertical-align: middle !important; margin-top: 0 !important; margin-bottom: 0 !important;">
                    <label for="agree_terms" style="display: inline-block; cursor: pointer; vertical-align: middle !important;"><span class="checkbox-label required">I have read and agree to our Privacy Policy.</span></label>
                </div>
                <div class="checkbox-container" style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="agree_terms" name="agree_terms" required style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; position: static !important; width: 20px !important; height: 20px !important; margin-right: 10px !important; cursor: pointer !important; -webkit-appearance: checkbox !important; -moz-appearance: checkbox !important; appearance: checkbox !important; border: 1px solid #333 !important; box-shadow: none !important; outline: none !important; z-index: 999 !important; vertical-align: middle !important; margin-top: 0 !important; margin-bottom: 0 !important;">
                    <label for="agree_terms" style="display: inline-block; cursor: pointer; vertical-align: middle !important;"><span class="checkbox-label required">I have read and agree to the Terms of Use.</span></label>
                </div>
                <div class="checkbox-container" style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="receive_newsletter" name="receive_newsletter" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; position: static !important; width: 20px !important; height: 20px !important; margin-right: 10px !important; cursor: pointer !important; -webkit-appearance: checkbox !important; -moz-appearance: checkbox !important; appearance: checkbox !important; border: 1px solid #333 !important; box-shadow: none !important; outline: none !important; z-index: 999 !important; vertical-align: middle !important; margin-top: 0 !important; margin-bottom: 0 !important;">
                    <label for="receive_newsletter" style="display: inline-block; cursor: pointer; vertical-align: middle !important;"><span class="checkbox-label">I want to receive updates about Eagle Eyes Search.</span></label>
                </div>
            </div>
        </div>
    </form>
</section>

<script>
    // This line enables Jekyll to pass the clickable parameter when including this file
    const formType = '{{ include.form_type }}';
    var formData = {};
    
    var useLocalFirebaseEmulator = getIsEmulatorFromURL();  // When running local emulator with "firebase emulators:start", set this to "true
    var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
    


    function getIsEmulatorFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        // return urlParams.get('is_emulator') === 'true';
        // Case insensitive
        return urlParams.get('is_emulator')?.toLowerCase() === 'true';
    }

    function requestErrorHandler(jqXHR, textStatus, errorThrown) {
        $("#hang-on-message").hide();
        console.log("Error: " + errorThrown);
        console.log("Status: " + textStatus);
        console.log("Response: " + jqXHR.responseText);
        showError("Error: " + errorThrown + " Status: " + textStatus + " Response: " + jqXHR.responseText);
    }

    function showError(message) {
        // Show an error message to the user
        var errorBox = document.createElement('div');
        errorBox.classList.add('error-box');
        // Width 80% of the screen
        errorBox.style.width = '80%';
        // Center horizontally
        errorBox.style.margin = '0 auto';

        errorBox.textContent = message;
        // Append to end of 'end-of-page' div
        // document.getElementById('end-of-page').appendChild(errorBox);
        document.body.appendChild(errorBox);

        // Show the "try again" button (try-again-button) (just make it not hidden)
        // $('#try-again-button').css('display', 'block');

        // Scroll to the bottom of the page
        window.scrollTo(0, document.body.scrollHeight);
    }

    function populateForm(formData) {
        // Get all form inputs
        var formInputs = document.querySelectorAll('input[type=text], input[type=email], input[type=password], input[type=checkbox], input[type=radio], select, textarea');
        
        // Iterate through each input in the form
        for (var i = 0; i < formInputs.length; i++) {
            var input = formInputs[i];

            // Check if the input's name exists in the formData
            if (formData.hasOwnProperty(input.name)) {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    // Set the checked property based on formData
                    input.checked = formData[input.name];
                } else {
                    // Set the value property based on formData
                    input.value = formData[input.name];
                }
            }
        }
    }
    
    function clickButton() {
        console.log('form type is: ' + formType);
        hasFormBeenShown = $("#form").is(":visible");
        console.log("Form has been shown?: " + hasFormBeenShown);

        if (formType == 'signup' && !hasFormBeenShown) {
            requestDownload();
        } else {
            if (!validateForm()) {
                console.log("Form validation failed");
                $("#status").html("Please complete all required fields").show();
                return false; // Prevent form submission if validation fails
            }
            if (formType == 'register' || formType == 'trial') {
                console.log('launching processRegisterForm');
                processRegisterForm();
            } else if (formType == 'signup' && hasFormBeenShown) {
                if (hasFormBeenShown) {
                    console.log('launching processSignupForm');
                    processSignupForm();
                }
                requestDownload();
            } else {
                console.log("Unknown form type: " + formType);
            }
        }
    }

    function validateForm() {
        var isValid = true;
        var requiredFields = document.querySelectorAll('#fields [required]');
        var radioGroups = {};

        requiredFields.forEach(function(field) {
            // Only process fields that have the 'required' attribute
            if (field.hasAttribute('required')) {
                if (field.type === 'radio') {
                    if (!radioGroups[field.name]) {
                        radioGroups[field.name] = [];
                    }
                    radioGroups[field.name].push(field);
                } else if (field.type === 'checkbox' && !field.checked) {
                    isValid = false;
                    field.nextElementSibling.style.color = 'red'; // Highlight invalid checkboxes
                } else if (field.type !== 'checkbox' && field.type !== 'radio') {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.style.borderColor = 'red'; // Highlight invalid text inputs
                    } else {
                        field.style.borderColor = ''; // Reset text input highlight
                    }
                }
            }
        });

        // Validate radio button groups
        Object.keys(radioGroups).forEach(function(groupName) {
            var group = radioGroups[groupName];
            var groupIsValid = group.some(function(radio) {
                return radio.checked;
            });

            if (!groupIsValid) {
                isValid = false;
                group.forEach(function(radio) {
                    radio.nextElementSibling.style.color = 'red'; // Highlight invalid radio group
                });
            } else {
                group.forEach(function(radio) {
                    radio.nextElementSibling.style.color = ''; // Reset radio group highlight
                });
            }
        });

        return isValid;
    }

    function processRegisterForm() {
        // Add "processing" class to the submit button
        $("#submitButton").addClass('processing');

        // Pack the form data into an object
        var formInputs = document.querySelectorAll('input[name], select[name], textarea[name]');
        formInputs.forEach(function(input) {
            if (input.type === 'checkbox') {
                formData[input.name] = input.checked ? 'yes' : 'no';
            } else if (input.type === 'radio') {
                if (input.checked) {
                    formData[input.name] = input.value;
                }
            } else {
                formData[input.name] = input.value;
            }
        });

        console.log(formData);


        // Remove empty keys or invalid entries
        for (var key in formData) {
            if (formData[key] === null || formData[key] === undefined || formData[key].trim() === "") {
                delete formData[key];
            }
        }

        if (formType == 'trial') {
            // Add the trial type to the form data
            formData['trial_request'] = true;
        } else {
            formData['trial_request'] = false;
        }

        console.log(formData);

        var fetch_url = hostURL + '/submit_register_form';

        console.log("Fetch URL: " + fetch_url);

        globalUser.getIdToken(true).then(function (idToken) {

            $.ajax({
                url: fetch_url,
                data: JSON.stringify(formData),
                type: 'POST', // Changed from 'method' to 'type' for clarity, though both are acceptable. Use 'POST' since you're sending a body.
                contentType: 'application/json', // This sets the Content-Type header to application/json
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function (data) {
                    console.log("Success" + data);

                    // Remove "processing" class to the submit button
                    $("#submitButton").removeClass('processing');

                    // Show user message with link and ask them if they want to download
                    // If yes, then redirect to the link
                    // If no, then do nothing

                    // Hide the download button/div after submitting form
                    $("#form-container").hide();
                    $("#signin").hide();
                    $("#post-form").show();
                },
                error: function() {
                    // Remove "processing" class to the submit button
                    $("#submitButton").removeClass('processing');
                    requestErrorHandler();
                }
            });
        });
    }

    // On load - check whether to show the emulator info box
    $(document).ready(function () {
        if (useLocalFirebaseEmulator) {
            $('#using-emulator-info').show();
        }
    });
    
    function processSignupForm() {
        // Add "processing" class to the submit button
        $("#submitButton").addClass('processing');
        var formInputs = document.querySelectorAll('input[name], select[name], textarea[name]');
        formInputs.forEach(function(input) {
            if (input.type === 'checkbox') {
                formData[input.name] = input.checked ? 'yes' : 'no';
            } else if (input.type === 'radio') {
                if (input.checked) {
                    formData[input.name] = input.value;
                }
            } else {
                formData[input.name] = input.value;
            }
        });
        // Remove empty keys or invalid entries
        for (var key in formData) {
            if (formData[key] === null || formData[key] === undefined || formData[key].trim() === "") {
                delete formData[key];
            }
        }
    }

    // Add this to your existing JavaScript
    function handleSignupTypeChange(radio) {
        const additionalFields = document.getElementById('additional-fields');
        const downloadQuestions = document.getElementById('download-questions');
        const trialQuestions = document.getElementById('trial-questions');
        const purchaseQuestions = document.getElementById('purchase-questions');

        // First, show the additional fields
        additionalFields.style.display = 'block';

        // Then, show/hide the appropriate question set
        switch(radio.value) {
            case 'trial':
                purchaseQuestions.style.display = 'none';
                downloadQuestions.style.display = 'none';
                trialQuestions.style.display = 'block';
                break;
            case 'download':
                trialQuestions.style.display = 'none';
                purchaseQuestions.style.display = 'none';
                downloadQuestions.style.display = 'block';
                break;
            case 'purchase':
                trialQuestions.style.display = 'none';
                downloadQuestions.style.display = 'none';
                purchaseQuestions.style.display = 'block';
                break;
        }

        // Smooth scroll to the additional fields
        additionalFields.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Add this to ensure the form state is correct on page load
    document.addEventListener('DOMContentLoaded', function() {
        const selectedOption = document.querySelector('input[name="signup_type"]:checked');
        if (selectedOption) {
            handleSignupTypeChange(selectedOption);
        }
    });

</script>