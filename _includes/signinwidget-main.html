<!-- Modern Sign In Widget -->
<div class="signin-container">
    <div class="signin-box">
        <button onclick="toggleSignIn()" class="close-button">&times;</button>
        <h2>Sign In</h2>
        <p class="subtext">Access your Eagle Eyes account</p>
        
        <!-- Google Sign In Button -->
        <button id="googleSignIn" class="signin-button google">
            <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg" class="google-icon">
                <path fill="#4285F4" d="M17.64 9.205c0-.639-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 01-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z"/>
                <path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/>
                <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
            </svg>
            Sign in with Google
        </button>

        <!-- Microsoft Sign In Button -->
        <button id="microsoftSignIn" class="signin-button microsoft">
            <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" class="microsoft-icon">
                <rect x="0" y="0" width="22" height="22" fill="#F25022" />
                <rect x="26" y="0" width="22" height="22" fill="#7FBA00" />
                <rect x="0" y="26" width="22" height="22" fill="#00A4EF" />
                <rect x="26" y="26" width="22" height="22" fill="#FFB900" />
            </svg>
            Sign in with Microsoft
        </button>

        <!-- Email Sign In Form -->
        <div class="email-signin">
            <div class="divider">
                <span>or</span>
            </div>
            
            <form id="emailSignInForm" class="email-form">
                <div class="form-group">
                    <label for="email">Email address</label>
                    <input type="email" id="email" name="email" required placeholder="Enter your email">
                </div>
                <button type="submit" class="signin-button email">
                    Sign in with Email
                </button>
            </form>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message"></div>
    </div>
</div>

<style>
    .signin-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px 20px;
    }

    .signin-box {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 40px;
        width: 100%;
        max-width: 400px;
    }

    .signin-box h2 {
        margin: 0 0 8px 0;
        font-size: 24px;
        color: #333;
        text-align: center;
    }

    .subtext {
        color: #666;
        text-align: center;
        margin-bottom: 24px;
    }

    .signin-button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .signin-button.google {
        background-color: white;
        border: 1px solid #ddd;
        color: #333;
    }

    .signin-button.google:hover {
        background-color: #f8f8f8;
    }
    
    .signin-button.microsoft {
        background-color: white;
        border: 1px solid #ddd;
        color: #333;
        margin-top: 12px;
    }

    .signin-button.microsoft:hover {
        background-color: #f8f8f8;
    }

    .google-icon {
        width: 18px;
        height: 18px;
    }
    
    .microsoft-icon {
        width: 18px;
        height: 18px;
    }

    .divider {
        display: flex;
        align-items: center;
        text-align: center;
        margin: 24px 0;
    }

    .divider::before,
    .divider::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid #ddd;
    }

    .divider span {
        padding: 0 10px;
        color: #666;
        font-size: 14px;
    }

    .email-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group label {
        font-size: 14px;
        color: #333;
        font-weight: 500;
    }

    .form-group input {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.2s;
    }

    .form-group input:focus {
        outline: none;
        border-color: #1e90ff;
    }

    .signin-button.email {
        background-color: #1e90ff;
        color: white;
    }

    .signin-button.email:hover {
        background-color: #1873cc;
    }

    .status-message {
        margin-top: 16px;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
        display: none;
    }

    .status-message.success {
        background-color: #e6f4ea;
        color: #1e8e3e;
        display: block;
    }

    .status-message.error {
        background-color: #fce8e6;
        color: #d93025;
        display: block;
    }

    .close-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: #666;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        line-height: 1;
        transition: color 0.2s;
    }

    .close-button:hover {
        color: #333;
    }
</style>

<script>
    // SignInWidget class to handle sign in events
    class SignInWidget {
        constructor() {
            this.googleButton = document.getElementById('googleSignIn');
            this.microsoftButton = document.getElementById('microsoftSignIn');
            this.emailForm = document.getElementById('emailSignInForm');
            this.emailInput = document.getElementById('email');
            this.statusMessage = document.getElementById('statusMessage');
            this.setupEventListeners();
        }
  
        setupEventListeners() {
            // Google Sign-In
            this.googleButton.addEventListener('click', () => this.signInWithGoogle());
            // Microsoft Sign-In
            this.microsoftButton.addEventListener('click', () => this.signInWithMicrosoft());
            // Email Sign-In
            this.emailForm.addEventListener('submit', (e) => this.signInWithEmail(e));
        }
  
        async signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await firebase.auth().signInWithPopup(provider);
                this.handleSignInSuccess(result.user);
            } catch (error) {
                this.showError("Google sign-in failed. Please try again.");
            }
        }
  
        async signInWithMicrosoft() {
            try {
                console.log("Starting Microsoft sign-in process...");
                const provider = new firebase.auth.OAuthProvider('microsoft.com');
                
                // Set minimal required scopes for Microsoft auth
                provider.addScope('openid');
                provider.addScope('profile');
                provider.addScope('email');
                
                // Set tenant ID if available (may be needed for organizational accounts)
                // provider.setCustomParameters({
                //     tenant: 'TENANT_ID' // Replace with your Microsoft tenant ID if using organizational accounts
                // });
                
                // Use simple parameters for standard accounts
                provider.setCustomParameters({
                    prompt: 'login',
                    login_hint: ''
                });
                
                console.log("Microsoft provider configured with basic scopes, attempting sign-in...");
                
                // Use popup for immediate feedback
                const result = await firebase.auth().signInWithPopup(provider);
                console.log("Microsoft sign-in successful:", result.user);
                this.handleSignInSuccess(result.user);
            } catch (error) {
                console.error("Microsoft sign-in error:", error);
                
                // Show more helpful error messages based on the error code
                switch(error.code) {
                    case 'auth/popup-blocked':
                        this.showError("Pop-up was blocked. Please allow pop-ups for this site.");
                        break;
                    case 'auth/popup-closed-by-user':
                        this.showError("Sign-in was cancelled. Please try again.");
                        break;
                    case 'auth/account-exists-with-different-credential':
                        this.showError("An account already exists with the same email address but different sign-in credentials.");
                        break;
                    case 'auth/unauthorized-domain':
                        this.showError("This domain is not authorized for OAuth operations. Please contact support.");
                        break;
                    case 'auth/operation-not-allowed':
                        this.showError("Microsoft authentication is not enabled. Please contact support.");
                        break;
                    default:
                        this.showError("Microsoft sign-in failed: " + (error.message || "Please try again."));
                }
            }
        }
  
        async signInWithEmail(e) {
            e.preventDefault();
            const email = this.emailInput.value.trim();
            if (!email) {
                this.showError("Please enter your email address.");
                return;
            }
            const returnURL = window.location.href;
            const actionCodeSettings = {
                url: returnURL,
                handleCodeInApp: true
            };
            try {
                window.localStorage.setItem('emailForSignIn', email);
                await firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings);
                this.showSuccess('Sign-in link sent to ' + email + '. Check your inbox.');
            } catch (error) {
                this.showError("Failed to send sign-in link. Please try again.");
            }
        }
  
        handleSignInSuccess(user) {
            console.log("Sign-in successful:", user);
            const event = new CustomEvent('signInComplete', { detail: { user } });
            document.dispatchEvent(event);
        }
  
        showSuccess(message) {
            this.statusMessage.textContent = message;
            this.statusMessage.className = 'status-message success';
        }
  
        showError(message) {
            this.statusMessage.textContent = message;
            this.statusMessage.className = 'status-message error';
        }
  
        completeEmailLinkSigninIfApplicable() {
            if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    email = window.prompt("Please provide your email for confirmation");
                }
                firebase.auth().signInWithEmailLink(email, window.location.href)
                    .then((result) => {
                        window.localStorage.removeItem('emailForSignIn');
                        this.handleSignInSuccess(result.user);
                    })
                    .catch((error) => {
                        console.error("Error during email link sign-in:", error);
                        this.showError("Error during email sign-in. Please try again.");
                    });
            }
        }
    }
  
    document.addEventListener('DOMContentLoaded', () => {
        // Try to get redirect result first, before initializing widget
        firebase.auth().getRedirectResult().then((result) => {
            if (result && result.user) {
                console.log("Redirect sign-in successful", result.user);
                // Create widget and handle sign-in
                const signInWidget = new SignInWidget();
                signInWidget.handleSignInSuccess(result.user);
            } else {
                // Normal initialization if not from redirect
                const signInWidget = new SignInWidget();
                signInWidget.completeEmailLinkSigninIfApplicable();
            }
        }).catch((error) => {
            console.error("Error with redirect sign-in:", error);
            // Initialize widget even if there was an error
            const signInWidget = new SignInWidget();
            signInWidget.completeEmailLinkSigninIfApplicable();
            if (error.code) {
                signInWidget.showError("Sign-in failed. Please try again.");
            }
        });
    });
</script> 