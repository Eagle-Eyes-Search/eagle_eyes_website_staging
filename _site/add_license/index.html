<!DOCTYPE html>
<html>


<head>
	<meta charset="UTF-8" />
	<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0" name="viewport">

	<!-- Open Graph -->
	<meta property="og:title" content="Eagle Eyes" />
	<meta property="og:url" content="https://www.eagleeyessearch.com/" />
	<meta property="og:type" content="website" />
	<meta property="og:image" content="https://eagleeyessearch.com/images/eagle_eyes_logo_2.png" />
	<meta property="og:description" content="The Future of Aerial Search" />

	<!-- Twitter Theme -->
	<meta name="twitter:widgets:theme" content="light">
	
	<!-- Title &amp; Favicon -->
	<title>Eagle Eyes Search</title>
	<link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
	<link rel="manifest" href="images/favicon/site.webmanifest">
	<link rel="mask-icon" href="images/favicon/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">

	<!-- Font -->
	<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CHind+Madurai:400,500&amp;subset=latin-ext" rel="stylesheet">
	
	<!-- Css -->
	<link rel="stylesheet" href="css/core.min.css" />
	<link rel="stylesheet" href="css/skin.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	<link rel="shortcut icon" type="image/png" href="images/eagle_eyes_icon_rounded_filtered.png">
	<link rel="stylesheet" href="css/custom-styling.css" />

    <style>
        .content-grid-3 {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
    </style>

	<!--[if lt IE 9]>
    	<script type="text/javascript" src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	
	<!-- Enable Fathom -->
	<script src="https://cdn.usefathom.com/script.js" data-site="QAODRYUQ" defer></script>
	
	<!-- Hotjar Tracking Code for Site 5045439 (name missing) -->
	<script>
		(function(h,o,t,j,a,r){
			h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
			h._hjSettings={hjid:5045439,hjsv:6};
			a=o.getElementsByTagName('head')[0];
			r=o.createElement('script');r.async=1;
			r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
			a.appendChild(r);
		})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
	</script>
	<script>
	$(document).ready(function() {
		$('nav.overlay-navigation a').click(function() {
			$('.overlay-navigation-wrapper').hide(); // this will hide the element
			$('body').css('overflow', 'auto');
			$('html').css('overflow', 'auto');
			$('body').removeClass('no-scroll');
			$('html').removeClass('no-scroll');
			// Hacky stuff
			// or
			//$('.v-align-middle').removeClass('v-align-middle'); // this will remove the class
		});
	});
	</script>

</head>

<head>
  <!-- Add necessary meta tags and other head elements here -->

  <style>
    .banner {
      position: relative;
      height: 100px; /* Adjust as needed */
      width: 100%;
      overflow: hidden; /* to contain the pseudo element */
    }
  
    .banner::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('/images/eagle_eyes_website_header_bg.jpg') no-repeat center;
      background-size: cover;
      filter: brightness(50%);
      z-index: 1; /* to ensure it's below other content */
    }
  
    .banner-text, .banner-img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2; /* to ensure it's above the background */
    }
   .banner-link img {
      width: 100px; /* adjust as per requirement */
      height: 50px;
       align-content: flex-start;
       z-index: 2;
       position: absolute;
       top: 20%;
    }
  
    /* Modern looking font */
    .lead {
      width: 80%;
      margin: auto;
      font: 1.2em/1.5em "Hind Madurai", sans-serif;
    }
    </style>
</head>

<body class="shop home-page">
  <div class="banner">
    <a class="banner-link" href="/">
      <img src="/images/back_to_eagleeyes.png"/>
    </a>
    <!-- <div class="banner-text">Eagle Eyes Scan</div> -->
    <img class="banner-img" src="/images/eagle_eyes_flat_logo_2.png" style="width:30%"/>
  </div>
    
  <section class="content evensection">
      <div class="lead">
        <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Eagle Eyes License (Admin)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/form_buttons_and_boxes.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="/shared.js"></script>
</head>
<body>
    <style>
        .container {
            width: 80%;
            margin: auto;
            display: flex;
            flex-wrap: wrap; /* Allows content to wrap onto the next line if needed */
        }
    
        .form-section {
            flex: 1 1 50%; /* Each section takes up half of the container width */
            padding: 10px;
        }

        .last-four-container {
            display: flex;
            justify-content: space-between; /* Distributes space evenly between the children */
            width: 100%; /* Takes full width of the container */
        }

        .last-four-container .form-section, .last-four-container .submit-section {
            flex: 1; /* Each child will take equal space */
            margin: 0 10px; /* Adds margin between the form sections */
        }

        .submit-section {
            display: flex;
            align-items: center; /* Centers the button vertically */
            justify-content: center; /* Centers the button horizontally */
        }

        label, input, select, textarea {
            display: block;
            width: 100%;
            margin-bottom: 10px;
        }

        input[type="text"], input[type="password"], select, textarea {
            padding: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        .radio-container {
            margin-top: 5px;
            display: flex;
            align-items: center;
        }

        .radio-container input[type="radio"] {
            margin-right: 5px;
        }

        .radio-container label {
            font-size: 0.9em;
        }
    </style>

    <section id="signin">
        <div class="info-box" id="using-emulator-info" style="display: none;">Using local Firebase emulator</div>
        <h1>Add a License</h1>
        <h3> Step 1: Sign in </h3>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<!-- Include form_buttons_and_boxes.scss (it's in scss/form_buttons_and_boxes.scss) but we need to get it in liquid -->
<style src="/css/form_buttons_and_boxes.css"></style>
<link rel="stylesheet" href="/css/form_buttons_and_boxes.css">


<script>

    class SigninWidget {
        constructor(
            firebaseConfig,
            useLocalFirebaseEmulator = false,

        ) {
            this.useLocalFirebaseEmulator = useLocalFirebaseEmulator;
            this.firebaseConfig = firebaseConfig;
            firebase.initializeApp(firebaseConfig);
            // Upon initialization, call the function to initialize Firebase
            
            this._user = null;

            // Check if user is still signed in from a previous session
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    this._user = user;
                    console.log("User is signed in", user);
                    this.updateUserDisplay(user);
                    this.fireSigninEvent(user);
                } else {
                    console.log("No user is signed in.");
                    this.completeEmailLinkSigninIfApplicable();
                }
            });


        }


        signInWithGoogle() {
            var provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            firebase.auth().signInWithPopup(provider).then((result) => {
                this._user = result.user;
                this.updateUserDisplay(this._user);
                this.fireSigninEvent(this._user);
            }).catch((error) => {
                console.error('Error during Google sign in: ', error);
            });
        }

        signInWithEmailLink(returnURL = null) {
            if (!returnURL) {
                returnURL = window.location.href;
            }
            var email = document.getElementById('email').value;
            var baseURL = window.location.origin;
            console.log('baseURL: ', baseURL);
            console.log('window.location.href: ', window.location.href);
            console.log('returnURL: ', returnURL);
            var actionCodeSettings = {
                // Make sure this URL is the URL of the page where you will handle the sign-in link
                // url: `${baseURL}/get_licensed/?machine_id=${machineId}`,
                // Get the full url including args that this page was loaded with
                // url: window.location.href,
                // url: `${baseURL}/get_scan`,
                url: returnURL,
                handleCodeInApp: true
            };

            console.log("Sending action code to email: ", email, " with settings: ", actionCodeSettings);
            firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);

                    // Now, replace sign-in-div with an info box telling the user to check their email
                    var signInDiv = document.getElementById('sign-in-div');
                    signInDiv.innerHTML = 'Sign-in link sent to ' + email +
                        ".  Be sure to check your spam folder if you don't see it in your inbox." +
                        "<br/><br/>You can now close this tab.";

                    // And give it a light-blue background to draw attention
                    signInDiv.classList.add('info-box');

                    console.log('Sign-in email sent to ' + email);
                    // alert('Sign-in email sent to ' + email + ".  Be sure to check your spam folder if you don't see it in your inbox.");
                })
                .catch((error) => {
                    console.error('Error sending sign-in email: ', error);
                    // Append the error message in a div to the end of the body
                    var errorDiv = document.createElement('div');
                    errorDiv.innerHTML = 'Error sending sign-in email: ' + error.message;
                    errorDiv.classList.add('error-box');
                    document.body.appendChild(errorDiv);

                });

        }

        // Call this function on the page where users are redirected after clicking the sign-in link
        completeEmailLinkSigninIfApplicable() {
            // If user is not already signed in and the URL has a sign-in link
            if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
                console.log('Email link sign-in detected');
                // Get the email if it's saved in local storage
                var email = window.localStorage.getItem('emailForSignIn');
                console.log('... with email: ', email);
                if (!email) {
                    // User opened the link on a different device. You will need to prompt them for their email
                    email = window.prompt('Please provide your email for confirmation');
                }

                firebase.auth().signInWithEmailLink(email, window.location.href)
                    .then((result) => {
                        console.log('Email Link sign in successful: ', JSON.stringify(result));
                        window.localStorage.removeItem('emailForSignIn'); // Clear the email from local storage

                        // var destringifiedUser = JSON.parse(JSON.stringify(result.user));
                        // console.log("destringifiedUser: ", JSON.stringify(destringifiedUser));
                        // User is signed in
                        this._user = result.user;
                        console.log('User signed in: ', this._user);
                        this.updateUserDisplay(this._user);
                        this.fireSigninEvent(this._user);
                        // checkLicence(); // Call checkLicence after successful login

                        // Optional: Redirect to another page after successful sign in
                    })
                    .catch((error) => {
                        console.error('Error during Email Link sign in: ', error);

                        // Make the sign-in div an error class and display the error
                        var signInDiv = document.getElementById('sign-in-div');
                        signInDiv.innerHTML = 'Error during Email Link sign in.  Most likely, the link has been used already or is expired.  Please try again, and contact info@eagleeyessearch.com if you continue to have trouble.';
                        signInDiv.classList.add('error-box');
                        // And add a button to reload the page without the user info attached
                        signInDiv.innerHTML += '<br/><button onclick="location.reload()"  class="non_important_button">Reload</button>';

                    });
            }
        }

        fireSigninEvent(user) {
            console.log('Firing signInComplete event with user: ', user);
            const event = new CustomEvent('signInComplete', { detail: { user: user } });
            document.dispatchEvent(event);
        }

        updateUserDisplay(user) {

            document.getElementById('user-info').innerHTML = 'Signed in as: ' + user.email + ' ( ' + user.displayName + ' )';
            // Give it that nice blue background by turning it into a .info-box
            document.getElementById('user-info').classList.add('info-box');
            document.getElementById('sign-in-div').style.display = 'none';
            // document.getElementById('user-info').innerHTML += '<br/><button onclick="location.reload()"  class="non_important_button">Change user</button>';
            // Need to sign-out now
            document.getElementById('user-info').innerHTML += '<br/><button onclick="signOutAndChangeUser()"  class="non_important_button">Change user</button>';
        }


        getUser() {
            return this._user;
        }
    }


    function signOutAndChangeUser() {
        firebase.auth().signOut().then(() => {
            console.log('User signed out.');
            // Reset the user display or redirect to the login page
            location.reload()
        }).catch((error) => {
            console.error('Sign out error', error);
        });
    }

    const signinWidget = new SigninWidget(
        {
            apiKey: "AIzaSyAL9w9qClktCNFM1XSfo_HB59nU6zHI0bk",
            authDomain: "eagleeyessearch.firebaseapp.com",
            projectId: "eagleeyessearch",
            storageBucket: "eagleeyessearch.appspot.com",
            messagingSenderId: "983592831720",
            appId: "1:983592831720:web:57b3880d0185ea3110575d",
            measurementId: "G-J057SPR81M"
        },
        false
    );

    function getIsEmulatorFromURL() {
        // Just see if there's an "is_emulator=true" in the URL
        var url = new URL(window.location.href);
        var isEmulator = url.searchParams.get("is_emulator");

        return isEmulator === "true";
    }

    function getHostUrl(){
                
        var useLocalFirebaseEmulator = getIsEmulatorFromURL();  // When running local emulator with "firebase emulators:start", set this to "true
        // var useLocalFirebaseEmulator = true;  // When running local emulator with "firebase emulators:start", set this to "true
        var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
        console.log('useLocalFirebaseEmulator: ', useLocalFirebaseEmulator);
        console.log('hostURL: ', hostURL);
        
        return hostURL;
    }

    // document.addEventListener("DOMContentLoaded", function () {
    //     // Initialize menus to be hidden
    //     var menus = document.getElementsByClassName('menu-content');
    //     for (var i = 0; i < menus.length; i++) {
    //         menus[i].style.display = "none";
    //     }
    //     // onSelectLicenceToken();
    //     completeSignInWithEmailLinkIfApplicable();
    //     return;
    // });


    function showEmailInputBtn() {
        // Show the email sign-in form
        document.getElementById('email-sign-in-form').style.display = 'block';
        // Hide the initial button
        document.getElementById('showEmailInputBtn').style.display = 'none';
        // And the google-sign-in button
        document.getElementById('google-sign-in-btn').style.display = 'none';
        // Focus on the email input for user convenience
        document.getElementById('email').style.display = 'block'; // Make sure email input is visible
        document.getElementById('email').focus();
    }

</script>

<div id='sign-in-div'>


    <button id="google-sign-in-btn" onclick="signinWidget.signInWithGoogle()">Sign in with Google</button>
    or

    <div id="email-sign-in-form" style="display:none;">
        <input type="email" id="email" placeholder="Email" style="display:none;width:80%">

        <!-- Add a cancel button that just reloads this page from scratch -->
        <button onclick="location.reload()" class="non_important_button">Cancel</button>

        <button id="sendSignInLinkBtn" onclick="signinWidget.signInWithEmailLink()">Send Sign in Link</button>
    </div>
    <button id="showEmailInputBtn" onclick="showEmailInputBtn()">Sign In With Email</button>
    <!-- <script>
    document.addEventListener("DOMContentLoaded", function () {
        // Event listener for the button to show email input
        document.getElementById('showEmailInputBtn').addEventListener('click', function () {
            // Show the email sign-in form
            document.getElementById('email-sign-in-form').style.display = 'block';
            // Hide the initial button
            this.style.display = 'none';
            // And the google-sign-in button
            document.getElementById('google-sign-in-btn').style.display = 'none';
            // Focus on the email input for user convenience
            document.getElementById('email').style.display = 'block'; // Make sure email input is visible
            document.getElementById('email').focus();
        });

        // Attach the signInWithEmailLink function to the Send SignIn Link button
        // document.getElementById('sendSignInLinkBtn').addEventListener('click', function () {
        //     signInWithEmailLink();
        // });
    });

</script> -->
</div>
<p id="user-info"></p>
    </section>

    <section id="form" hidden>
        <h3>Welcome admin. Enter Licensing details below</h3>
        <span id="place_to_view"></span>
        <form onsubmit="event.preventDefault(); handleForm();">
            <div class="container">
                <div class="form-section">
                    <label for="extra_security_password"><b>Admin Password: </b></label>
                    <input type="password" placeholder="Enter Admin Password" id="extra_security_password" name="extra_security_password" required>
                </div>
                <div class="form-section">
                    <label for="license_name"><b>License Name: (optional)</b></label>
                    <input type="text" placeholder="Enter License Name" id="license_name" name="license_name">
                </div>
                <div style="text-align: left;">
                    <div class="form-section">
                        <fieldset>
                            <legend><b>How to assign emails?</b></legend>
                            <div class="radio-container">
                                <input type="radio" id="same_license" name="sameLicenseIdValue" value="true" required checked>
                                <label for="same_license">Assign all emails to the same license ID</label>
                            </div>
                            <div class="radio-container">
                                <input type="radio" id="separate_license" name="sameLicenseIdValue" value="false" required>
                                <label for="separate_license">Create a separate license ID for each email address</label>
                            </div>
                        </fieldset>
                    </div>
                </div>
                <div class="form-section">
                    <label for="emails"><b>Emails: (required)</b></label>
                    <textarea id="emails" name="emails" rows="2" placeholder="joe@example.com, bob@example.com" required></textarea>
                </div>
                <div class="form-section">
                    <label for="domains"><b>Domains: (optional)</b></label>
                    <input type="text" placeholder="examplecountysar.org,someotherdomain.com" id="domains" name="domains">
                </div>

                <!-- New flex container for the last four sections -->
                <div class="last-four-container">
                    <div class="form-section">
                        <fieldset>
                            <legend><b>User Type:</b></legend>
                            <div class="radio-container">
                                <input type="radio" id="volunteer" name="userType" value="volunteer" required>
                                <label for="volunteer">Volunteer</label>
                            </div>
                            <div class="radio-container">
                                <input type="radio" id="general" name="userType" value="general" required checked>
                                <label for="general">General</label>
                            </div>
                            <div class="radio-container">
                                <input type="radio" id="special" name="userType" value="special" required>
                                <label for="special">Special</label>
                            </div>
                        </fieldset>
                    </div>
                    <div class="form-section">
                        <fieldset>
                            <legend><b>License Duration:</b></legend>
                            <select id="licenseDurationSelect" name="license_duration" required></select>
                            <input type="text" id="customDaysInput" placeholder="Enter custom days" style="display:none;">
                        </fieldset>
                    </div>
                    <div class="form-section">
                        <label for="number_of_keys"><b>Number of Keys:</b></label>
                        <input type="number" placeholder="Enter Number of Keys" id="number_of_keys" name="number_of_keys" value="1" required>
                    </div>
                    <div class="submit-section">
                        <button type="submit" id="createLicenseButton">Create license</button>
                    </div>
                </div>
            </div>
        </form>
    </section>
    <div id="creationStatus"></div>

    <script>

        var useLocalFirebaseEmulator = getIsEmulatorFromURL();  // When running local emulator with "firebase emulators:start", set this to "true
        var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
        console.log('useLocalFirebaseEmulator: ' + useLocalFirebaseEmulator);
        var fireStoreLink;
        if (useLocalFirebaseEmulator){
            fireStoreLink = 'http://localhost:4000/firestore/default/data/licenses/';
        } else {
            fireStoreLink = 'https://console.firebase.google.com/u/0/project/eagleeyessearch/firestore/databases/-default-/data/~2Flicenses~2F';
        }
        $('#place_to_view').html('<a href="' + fireStoreLink + ' " target="_blank">View Licenses</a>');

        $(document).ready(function() {
            // Populate license duration select
            const licenseOptions = [
                { value: 'no_license', text: 'No License' },
                { value: 'two_weeks', text: 'Intro License: Pro - 2 Weeks' },
                { value: 'one_month', text: 'Pro - 1 Month' },
                { value: 'three_months', text: 'Pro - 3 Months' },
                { value: 'one_year', text: 'Pro - 1 Year' },
                { value: 'custom', text: 'Custom'},
                { value: 'live', text: 'Live' }
            ];
    
            const $licenseDurationSelect = $('#licenseDurationSelect');
            $.each(licenseOptions, function(index, option) {
                $licenseDurationSelect.append($('<option>', {
                    value: option.value,
                    text: option.text
                }));
            });

            $licenseDurationSelect.on('change', function() {
                if ($(this).val() === 'custom') {
                    $('#customDaysInput').show();
                } else {
                    $('#customDaysInput').hide();
                }
            });
    
            // Listener for sign-in completion
            document.addEventListener('signInComplete', function (e) {
                var globalUser = e.detail.user;
                globalUser.getIdToken(true).then(function (idToken) {
                    var requestURL = getHostUrl() + '/is_logged_in_user_admin';
                    $.ajax({
                        url: requestURL,
                        type: 'POST',
                        contentType: 'application/json',
                        headers: {
                            'Authorization': 'Bearer ' + idToken
                        },
                        success: function (data) {
                            var isAdmin = JSON.parse(data).is_admin;
                            if (isAdmin) {
                                $('#form').show();
                            } else {
                                $('#creationStatus').text('Access denied. You are not authorized to add licenses.');
                                $('#form').hide();
                            }
                        },
                        error: function () {
                            alert('Failed to verify admin status.');
                        }
                    });
                });
            });
        });
    
        function handleForm() {
            event.preventDefault();
            const licenseName = $('#license_name').val();
            const emails = $('#emails').val().split(/,\s*/);
            const domains = $('#domains').val().split(/,\s*/);
            const userType = $('input[name="userType"]:checked').val();
            const licenseDuration = $('#licenseDurationSelect').val();
            const numberOfKeys = parseInt($('#number_of_keys').val(), 10);
            const extraSecurityPassword = $('#extra_security_password').val();
            const sameLicenseIdValue = $('input[name="sameLicenseIdValue"]:checked').val();
            const sameLicenseId = sameLicenseIdValue === 'true';
            console.log(sameLicenseIdValue);

            // Calculate expiry timestamp based on selected license duration
            let expiryTimestamp = null;
            let tier = null;
            if (licenseDuration !== 'live') {
                const now = moment();
                switch (licenseDuration) {
                    case 'two_weeks':
                        expiryTimestamp = now.add(14, 'days').unix();
                        tier = 'SAR';
                        break;
                    case 'one_month':
                        expiryTimestamp = now.add(1, 'month').unix();
                        tier = 'SAR';
                        break;
                    case 'three_months':
                        expiryTimestamp = now.add(3, 'months').unix();
                        tier = 'SAR';
                        break;
                    case 'one_year':
                        expiryTimestamp = now.add(1, 'year').unix();
                        tier = 'SAR';
                        break;
                    case 'custom':
                        const customDays = parseInt($('#customDaysInput').val(), 10);
                        expiryTimestamp = now.add(customDays, 'days').unix();
                        tier = 'SAR';
                        break;
                    case 'live':
                        expiryTimestamp = null;
                        tier = 'Live';
                        break;
                }
            }

            const data = {
                license_name: licenseName,
                emails: emails,
                domains: domains,
                user_type: userType,
                license_duration: licenseDuration,
                tier: tier,
                n_tokens: numberOfKeys,
                expiry_timestamp: expiryTimestamp,
                extra_security_password: extraSecurityPassword,
                same_license_id: sameLicenseId
            };

            sendLicenseData(data);
        }

    function sendLicenseData(data) {
        const globalUser = firebase.auth().currentUser;
        // Add processing class to button
        $('#createLicenseButton').addClass('processing');
        statusSpan = $('#creationStatus');
        globalUser.getIdToken(true).then(function (idToken) {
            $.ajax({
                url: getHostUrl() + '/add_new_license',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function (response) {
                    console.log("License created successfully:", response);
                    licenseData = JSON.parse(response);
                    // license_id=license_id,
                    // new_license=new_license_json_dict,  # Or None if no new license was created
                    // users_added=emails,
                    // if (decodedJson) {
                    //     $('#creationStatus').html('<p>License Key: ' + decodedJson.license_key + '</p>');
                    // } else {
                    //     $('#creationStatus').html('<p>User Verfied</p>');
                    // }
                    // Just directly post response
                    var AllLicenseData = {};
                    var licenseObjectData = {};
                    for (const key in licenseData) {
                        if (licenseData.hasOwnProperty(key)) {
                            const license = licenseData[key];
                            const licenseId = license['license_id'];
                            const licenseInfo = license['new_license'];
                            var expiryDateStr;
                            // if (licenseData[1].expiry_timestamp === null) {
                            if (licenseInfo===null || licenseInfo?.expiry_timestamp === null) {
                                expiryDateStr = 'No Expiry';
                            } else {
                                expiryDateStr = new Date(licenseInfo.expiry_timestamp * 1000).toLocaleString();
                            }
                            
                            if (useLocalFirebaseEmulator){
                                linkToViewFirestore = 'http://localhost:4000/firestore/default/data/licenses/'+licenseId;
                            } else {
                                linkToViewFirestore = 'https://console.firebase.google.com/u/0/project/eagleeyessearch/firestore/databases/-default-/data/~2Flicenses~2F' + licenseId;
                            }
                            licenseObjectData = JSON.stringify(license, null, 2) + '</pre>\nExpiry: ' + expiryDateStr + '\n<a href="' + linkToViewFirestore + '" target="_blank">View License in Firestore</a>';
                            AllLicenseData[key] = licenseObjectData;
                        }
                    }
                    licenseDataDisplay = 'License(s) created successfully:';
                    for (key in AllLicenseData) {
                        licenseDataDisplay += '\n<pre>'
                        licenseDataDisplay += AllLicenseData[key];
                    }
                    console.log(licenseDataDisplay);
                    statusSpan.html(licenseDataDisplay).removeClass('error-box').addClass('info-box');
                    // Make button normal again
                    $('#createLicenseButton').removeClass('processing')
                },
                error: function (xhr, status, error) {
                    console.log("Error creating license:", xhr.responseText);
                    statusSpan.html('<p>Error creating license: ' + xhr.responseText + '</p>');
                    // Add .error-box class
                    statusSpan.removeClass('info-box').addClass('error-box');
                    // Remove processing class from button
                    $('#createLicenseButton').removeClass('processing')
                }
            });
        });
    }
    </script>
    
</body>

      </div>
  </section>
  
</body>
</html>
