---
layout: main
title: Account Management - Eagle Eyes
---
<style>
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    .table th {
        text-align: left;
        padding: 12px;
        font-weight: 500;
        color: #666;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    .table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 15px;
    }
    .table tr:last-child td {
        border-bottom: none;
    }
    .table tr:hover td {
        background-color: #f9f9f9;
    }
    .loading-spinner {
        text-align: center;
        padding: 20px;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    h4 {
        margin-bottom: 15px;
        color: #333;
    }
    .download-link {
        color: #1e90ff;
        text-decoration: none;
        font-weight: 500;
    }
    .download-link:hover {
        text-decoration: underline;
    }
    .table th:nth-child(1) { width: 40%; }  /* Platform - wider to fit text */
    .table th:nth-child(2) { width: 18%; }  /* Version - slightly narrower */
    .table th:nth-child(3) { width: 22%; }  /* Release Date - slightly narrower */
    .table th:nth-child(4) { width: 20%; }  /* Download - slightly narrower */
</style>

<div class="section-block bkg-grey-ultralight" style="padding: 120px 0 30px 0;">
    <div class="row">
        <div class="column width-12">
            <div class="centered">
                <h2 class="mb-10">Account</h2>
                <div style="display: flex; justify-content: flex-start; align-items: center; gap: 20px;">
                    <div id="userEmailDisplay" style="color: #666; font-size: 16px;"></div>
                    <div id="signOutContainer" style="display: none;">
                        <a href="#" id="signOutButton" class="button small rounded" style="padding: 8px 15px; font-size: 14px;">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-block" style="padding-top: 20px;">
    <div class="row">
        <div class="column width-8 offset-2">
            <!-- Sign in button (will trigger overlay) -->
            <div id="signinButtonSection" style="display: none; text-align: center; margin-bottom: 40px;">
                <p style="margin-bottom: 20px;">Sign in to access your downloads.</p>
                <button id="accountSignInButton" class="button" onclick="toggleSignIn()">Sign In or Create Account</button>
            </div>

            <!-- Account content section -->
            <div id="accountContent" style="display: none;">
                <div class="box rounded xlarge bkg-white shadow">
                    <div class="box-content">
                        <div class="row">
                            <div class="column width-12">
                                <h3 class="mb-30">Downloads</h3>
                                
                                <div class="mb-50">
                                    <h4>Eagle Eyes Pilot</h4>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Platform</th>
                                                <th>Version</th>
                                                <th>Release Date</th>
                                                <th>Download</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pilotDownloads">
                                            <tr>
                                                <td colspan="4" style="text-align: center;">Loading available downloads...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mb-50">
                                    <h4>Eagle Eyes Scan</h4>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Platform</th>
                                                <th>Version</th>
                                                <th>Release Date</th>
                                                <th>Download</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scanDownloads">
                                            <tr>
                                                <td colspan="4" style="text-align: center;">Loading available downloads...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <h3 class="mb-30">Licenses</h3>
                                <div id="licensesContent" class="mb-30">
                                    <div class="loading-spinner" style="display: none;">
                                        <div class="spinner"></div>
                                    </div>
                                    <div id="licensesList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Keep this sign-in overlay in account.html -->
<div id="signin-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000;">
    <div style="position: relative; width: 100%; height: 100%;">
        {% include signinwidget-main.html %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const signinButtonSection = document.getElementById('signinButtonSection');
        const accountContent = document.getElementById('accountContent');
        const userEmail = document.getElementById('userEmailDisplay');
        const signOutContainer = document.getElementById('signOutContainer');
        const signOutButton = document.getElementById('signOutButton');

        // Show sign-in button by default until we confirm a user is signed in
        signinButtonSection.style.display = 'block';
        
        // Listen for auth state changes
        document.addEventListener('authStateChanged', function(e) {
            const user = e.detail.user;
            if (user) {
                // User is signed in
                signinButtonSection.style.display = 'none';
                userEmail.textContent = `Logged in as: ${user.email}`;
                signOutContainer.style.display = 'block';
                
                // Check if the user should be on this page
                checkUserStatus(user);
            } else {
                // User is signed out
                signinButtonSection.style.display = 'block';
                accountContent.style.display = 'none';
                userEmail.textContent = '';
                signOutContainer.style.display = 'none';
            }
        });

        // Initial auth state check
        if (firebase.auth().currentUser) {
            const user = firebase.auth().currentUser;
            signinButtonSection.style.display = 'none';
            userEmail.textContent = `Logged in as: ${user.email}`;
            signOutContainer.style.display = 'block'; // Show the sign-out button
            // Instead of directly showing the account content, check if the user filled the form
            checkUserStatus(user);
        }

        // Handle sign out
        if (signOutButton) {
            signOutButton.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent the default link behavior
                
                firebase.auth().signOut().then(function() {
                    // Sign-out successful - the auth state listener will handle UI updates
                    console.log('User signed out successfully');
                    
                    // Optionally reload the page for a clean state
                    window.location.reload();
                }).catch(function(error) {
                    // An error happened
                    console.error('Error signing out:', error);
                });
            });
        }

        // Keep this event handler for backward compatibility
        document.addEventListener('signInComplete', function(e) {
            const user = e.detail.user;
            toggleSignIn(); // Hide the overlay
        });
    });


    async function fetchAvailableDownloads() {
        try {
            const user = firebase.auth().currentUser;
            
            if (!user) {
                throw new Error('No user logged in');
            }

            console.log('Fetching available downloads...');
            console.log('User email:', user.email);

            // First, get the list of available files from Firebase Storage
            const pilotFiles = await listFilesInDirectory('pilot-releases/current');
            const scanFiles = await listFilesInDirectory('scan_releases/current');

            console.log('Available Pilot files:', pilotFiles);
            console.log('Available Scan files:', scanFiles);

            // Get Pilot downloads
            const pilotDownloads = document.getElementById('pilotDownloads');
            pilotDownloads.innerHTML = '';

            if (pilotFiles.length === 0) {
                pilotDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">No Pilot downloads available.</td></tr>';
            } else {
                for (const file of pilotFiles) {
                    try {
                        // Use the structured data directly
                        const fileName = file.name;
                        const version = file.version || 'Unknown';
                        const platform = file.platform || 'Unknown';
                        const releaseDate = file.releaseDate ? new Date(file.releaseDate).toLocaleDateString() : '2024-03-20';
                        
                        const filePath = `pilot-releases/current/${fileName}`;
                        const downloadUrl = await generateDownloadLink(filePath, user);
                        
                        pilotDownloads.innerHTML += `
                            <tr>
                                <td>${platform}</td>
                                <td>${version}</td>
                                <td>${releaseDate}</td>
                                <td><a href="${downloadUrl}" class="download-link" onclick="trackDownload('pilot', '${fileName}')">Download</a></td>
                            </tr>
                        `;
                    } catch (error) {
                        console.error(`Error processing pilot file ${file}:`, error);
                        pilotDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
                    }
                }
            }

            // Get Scan downloads
            const scanDownloads = document.getElementById('scanDownloads');
            scanDownloads.innerHTML = '';

            if (scanFiles.length === 0) {
                scanDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">No Scan downloads available.</td></tr>';
            } else {
                for (const file of scanFiles) {
                    try {
                        // Use the structured data directly
                        const fileName = file.name;
                        const version = file.version || 'Unknown';
                        const platform = file.platform || 'Unknown';
                        const releaseDate = file.releaseDate ? new Date(file.releaseDate).toLocaleDateString() : '2024-03-20';
                        
                        const filePath = `scan_releases/current/${fileName}`;
                        const downloadUrl = await generateDownloadLink(filePath, user);
                        
                        scanDownloads.innerHTML += `
                            <tr>
                                <td>${platform}</td>
                                <td>${version}</td>
                                <td>${releaseDate}</td>
                                <td><a href="${downloadUrl}" class="download-link" onclick="trackDownload('scan', '${fileName}')">Download</a></td>
                            </tr>
                        `