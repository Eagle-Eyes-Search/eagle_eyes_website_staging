---
layout: main
title: Account Management - Eagle Eyes
---
<style>
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    .table th {
        text-align: left;
        padding: 12px;
        font-weight: 500;
        color: #666;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    .table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 15px;
    }
    .table tr:last-child td {
        border-bottom: none;
    }
    .table tr:hover td {
        background-color: #f9f9f9;
    }
    .loading-spinner {
        text-align: center;
        padding: 20px;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    h4 {
        margin-bottom: 15px;
        color: #333;
    }
    .download-link {
        color: #1e90ff;
        text-decoration: none;
        font-weight: 500;
    }
    .download-link:hover {
        text-decoration: underline;
    }
    .table th:nth-child(1) { width: 40%; }  /* Platform - wider to fit text */
    .table th:nth-child(2) { width: 18%; }  /* Version - slightly narrower */
    .table th:nth-child(3) { width: 22%; }  /* Release Date - slightly narrower */
    .table th:nth-child(4) { width: 20%; }  /* Download - slightly narrower */
    
    /* License sections styles from license-table.html */
    .license-sections h4 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .mt-50 {
      margin-top: 50px;
    }
    
    /* Grid layouts */
    #licenseGrid, #tokensGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      width: 100%;
    }
    
    /* Card styles - shared across both sections */
    .license-card, .token-card {
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .license-card:hover, .token-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .license-header, .token-header {
      background-color: #f8f8f8;
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    
    .license-header-left, .token-header-left {
      flex: 1;
    }
    
    .license-header-right, .token-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      text-align: right;
    }
    
    .license-title, .token-title {
      font-size: 16px;
      font-weight: 500;
      margin: 0;
      color: #333;
    }
    
    .license-subtitle, .token-subtitle {
      font-size: 14px;
      color: #666;
      margin: 5px 0 0 0;
    }
    
    .license-meta, .token-meta {
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .license-meta:last-child, .token-meta:last-child {
      margin-bottom: 0;
    }
    
    .license-meta-highlight, .token-meta-highlight {
      font-weight: 500;
      color: #333;
    }
    
    .license-body, .token-body {
      padding: 15px;
    }
    
    /* Token-specific styles */
    .token-license-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .token-license-item:last-child {
      border-bottom: none;
    }
    
    .token-license-info {
      display: flex;
      flex-direction: column;
    }
    
    .token-license-id {
      font-weight: 500;
      font-size: 14px;
      color: #333;
    }
    
    .token-license-expiry {
      font-size: 13px;
      color: #666;
      margin-top: 3px;
    }
    
    .copy-button {
      padding: 6px 12px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .copy-button:hover {
      background-color: #e5e5e5;
    }
    
    .copy-button.copied {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    
    /* License-specific styles */
    .license-users-label {
      font-weight: 500;
      color: #666;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .license-users-list {
      font-size: 14px;
      color: #333;
      max-height: 80px;
      overflow-y: auto;
      padding-right: 5px;
      line-height: 1.5;
    }
    
    .license-empty, .token-empty {
      padding: 15px;
      text-align: center;
      color: #666;
      font-style: italic;
    }
    
    /* For mobile */
    @media (max-width: 480px) {
      #licenseGrid, #tokensGrid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .license-card, .token-card {
        border-radius: 6px;
      }
      
      .license-header, .token-header {
        padding: 12px;
        flex-direction: column;
      }
      
      .license-header-right, .token-header-right {
        margin-top: 10px;
        align-items: flex-start;
        text-align: left;
      }
      
      .license-body, .token-body {
        padding: 12px;
      }
    }

    /* Download card styles */
    #pilotGrid, #scanGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      width: 100%;
    }

    .download-card {
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .download-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .download-header {
      background-color: #f8f8f8;
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .download-title {
      font-size: 16px;
      font-weight: 500;
      margin: 0;
      color: #333;
    }

    .download-body {
      padding: 15px;
    }

    .download-meta {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .download-meta-label {
      color: #666;
      font-size: 14px;
    }

    .download-meta-value {
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    .download-button {
      display: block;
      text-align: center;
      padding: 10px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 4px;
      color: #1e90ff;
      text-decoration: none;
      font-weight: 500;
      margin-top: 15px;
      transition: background-color 0.2s;
    }

    .download-button:hover {
      background-color: #e5e5e5;
      text-decoration: none;
    }

    .no-downloads {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .empty-card {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 30px 20px;
      text-align: center;
      color: #888;
      font-size: 15px;
      font-style: italic;
      background-color: #f9f9f9;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 20px;
    }
</style>

<div class="section-block bkg-grey-ultralight" style="padding: 120px 0 30px 0;">
    <!-- Add the test user banner right at the top -->
    <div id="test-user-banner" style="display: none; position: sticky; top: 0; left: 0; width: 100%; background-color: #4CAF50; color: white; padding: 10px 0; text-align: center; z-index: 1000; margin-bottom: 20px;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <span><strong>Development Mode</strong></span>
            <button id="test-user-login" class="button small rounded" style="background-color: white; color: #4CAF50; border: none; padding: 8px 15px; font-size: 14px; cursor: pointer;">Sign in as Test User</button>
        </div>
    </div>
    
    <div class="row">
        <div class="column width-12">
            <div class="centered">
                <h2 class="mb-10">Account</h2>
                <div style="display: flex; justify-content: flex-start; align-items: center; gap: 20px;">
                    <div id="userEmailDisplay" style="color: #666; font-size: 16px;"></div>
                    <div id="signOutContainer" style="display: none;">
                        <a href="#" id="signOutButton" class="button small rounded" style="padding: 8px 15px; font-size: 14px;">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification banner moved outside and below the grey section -->
<div class="row">
    <div class="column width-12">
        <div id="notification-banner" style="display: none; width: 100%; background-color: #3498db; color: white; padding: 12px 20px; text-align: center; border-radius: 4px; margin: 10px auto 20px; position: relative; max-width: 1140px;">
            <div style="max-width: 90%; margin: 0 auto; font-size: 16px;" id="notification-text">
                Important message for Eagle Eyes users will appear here.
            </div>
            <button id="close-notification" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: white; font-size: 18px; cursor: pointer; padding: 5px;">Ã—</button>
        </div>
    </div>
</div>

<!-- Add the license purchase suggestion here -->
<div class="section-block" style="padding-top: 0; padding-bottom: 0;">
    <div class="row">
        <div class="column width-8 offset-2 center">
            <p style="color: #666; font-size: 16px; margin-bottom: 20px;">
                Looking to buy a new license? <a href="pricing.html" style="color: #1e90ff; text-decoration: none; font-weight: 500;">See our pricing</a>.
            </p>
        </div>
    </div>
</div>

<div class="section-block" style="padding-top: 20px;">
    <div class="row">
        <div class="column width-8 offset-2">
            <!-- Sign in button (will trigger overlay) -->
            <div id="signinButtonSection" style="display: block; text-align: center; margin-bottom: 40px;">
                <p style="margin-bottom: 20px;">Sign in to access your downloads.</p>
                <button id="accountSignInButton" class="button" onclick="toggleSignIn()">Sign In or Create Account</button>
            </div>

            <!-- Account content section -->
            <div id="accountContent" style="display: none;">
                <div class="box rounded xlarge bkg-white shadow">
                    <div class="box-content">
                        <div class="row">
                            <div class="column width-12">
                                <h3 class="mb-30">Available Downloads</h3>
                                
                                <div class="mb-50">
                                    <h4>Eagle Eyes Pilot</h4>
                                    <!-- Add spinner container -->
                                    <div id="pilotSpinner" class="loading-spinner">
                                        <div class="spinner"></div>
                                    </div>
                                    <!-- Use a grid for cards instead of a table -->
                                    <div id="pilotGrid" style="display: none;"></div>
                                    <div id="pilotEmpty" style="display: none;">
                                        <div class="empty-card">
                                            No Pilot downloads available.
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-50">
                                    <h4>Eagle Eyes Scan</h4>
                                    <!-- Add spinner container -->
                                    <div id="scanSpinner" class="loading-spinner">
                                        <div class="spinner"></div>
                                    </div>
                                    <!-- Use a grid for cards instead of a table -->
                                    <div id="scanGrid" style="display: none;"></div>
                                    <div id="scanEmpty" style="display: none;">
                                        <div class="empty-card">
                                            No Scan downloads available.
                                        </div>
                                    </div>
                                </div>

                                <h3 class="mb-30">My Licenses</h3>
                                
                                <div id="licensesContent">
                                    <div class="license-sections">
                                        <!-- SECTION 1: MY PURCHASED LICENSES -->
                                        <div id="purchasedLicenseContainer" class="mb-50">
                                            <h4>My Purchased Licenses</h4>
                                            <div id="licenseSpinner" class="loading-spinner">
                                        <div class="spinner"></div>
                                    </div>
                                            
                                            <!-- Card-based grid layout for licenses -->
                                            <div id="licenseGrid" style="display: none;"></div>
                                            
                                            <div id="licenseError" style="display: none;">
                                                <div class="empty-card" style="border-color: #ffcccc; background-color: #fff8f8; color: #cc0000;">
                                                    Error loading license data. Please try again later.
                                </div>
                            </div>
                                            <div id="licenseEmpty" style="display: none;">
                                                <div class="empty-card">
                                                    No licenses found.
                        </div>
                    </div>
                </div>

                                        <!-- SECTION 2: MY DEVICES -->
                                        <div id="deviceTokensContainer">
                                            <h4>My Devices</h4>
                                            <div id="tokensSpinner" class="loading-spinner">
                                                <div class="spinner"></div>
            </div>
                                            
                                            <!-- Card-based grid layout for device tokens -->
                                            <div id="tokensGrid" style="display: none;"></div>
                                            
                                            <div id="tokensError" style="display: none;">
                                                <div class="empty-card" style="border-color: #ffcccc; background-color: #fff8f8; color: #cc0000;">
                                                    Error loading device data. Please try again later.
                                                </div>
                                            </div>
                                            <div id="tokensEmpty" style="display: none;">
                                                <div class="empty-card">
                                                    No devices found.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Keep this sign-in overlay in account.html -->
<div id="signin-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; width: 100%; height: 100%;">
        {% include signinwidget-main.html %}
    </div>
</div>

<script>
    /***********************************************
     * INITIALIZATION AND EVENT LISTENERS
     ***********************************************/
    
    // Wait for DOM to load - ONE unified listener
    document.addEventListener('DOMContentLoaded', function() {
        const signinButtonSection = document.getElementById('signinButtonSection');
        const accountContent = document.getElementById('accountContent');
        const userEmail = document.getElementById('userEmailDisplay');
        const signOutContainer = document.getElementById('signOutContainer');
        const signOutButton = document.getElementById('signOutButton');

        // Set up the test user banner if in emulator mode
        setupTestUserBanner();
        
        // Add notification banner examples
        // Add event listener for close button
        document.getElementById('close-notification').addEventListener('click', hideNotification);
        
        // Show a sample notification (uncomment any of these to test)
        // showNotification('Welcome to your Eagle Eyes account! Check out our new features.', 'info', true);
        
        // Other examples you can uncomment to test:
        // showNotification('Your license has been successfully activated!', 'success', true);
        // showNotification('Your license will expire in 15 days. <a href="pricing.html" style="color: white; text-decoration: underline;">Renew now</a> to avoid interruption.', 'warning', true);
        // showNotification('There was a problem processing your recent request. Please try again later.', 'error', true);
        // showNotification('System maintenance scheduled for Sunday, 2AM-4AM EST.', 'info', false);

        // Listen for auth state changes
        document.addEventListener('authStateChanged', function(e) {
            const user = e.detail.user;
            if (user) {
                // User is signed in
                signinButtonSection.style.display = 'none';
                userEmail.textContent = `Logged in as: ${user.email}`;
                signOutContainer.style.display = 'block';
                
                // Check if the user should be on this page
                redirectOrNot(user);
            } else {
                // User is signed out
                signinButtonSection.style.display = 'block';
                accountContent.style.display = 'none';
                userEmail.textContent = '';
                signOutContainer.style.display = 'none';
            }
        });

        // Initial auth state check
        if (firebase.auth().currentUser) {
            const user = firebase.auth().currentUser;
            signinButtonSection.style.display = 'none';
            userEmail.textContent = `Logged in as: ${user.email}`;
            signOutContainer.style.display = 'block'; // Show the sign-out button
            // Instead of directly showing the account content, check if the user filled the form
            redirectOrNot(user);
        }

        // Handle sign out
        if (signOutButton) {
            signOutButton.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent the default link behavior
                
                firebase.auth().signOut().then(function() {
                    // Sign-out successful - the auth state listener will handle UI updates
                    console.log('User signed out successfully');
                    
                    // Optionally reload the page for a clean state
                    window.location.reload();
                }).catch(function(error) {
                    // An error happened
                    console.error('Error signing out:', error);
                });
            });
        }

        // Keep this event handler for backward compatibility
        document.addEventListener('signInComplete', function(e) {
            const user = e.detail.user;
            toggleSignIn(); // Hide the overlay
        });
    });

    /***********************************************
     * AUTHENTICATION & USER MANAGEMENT
     ***********************************************/
    
    // Function to set up test user banner
    function setupTestUserBanner() {
        console.log('Checking if we are in emulator mode');
        const urlParams = new URLSearchParams(window.location.search);
        const isEmulator = urlParams.get('is_emulator') === 'true';
        
        if (isEmulator) {
            // Show the test user banner
            const banner = document.getElementById('test-user-banner');
            if (banner) banner.style.display = 'block';
            
            // Set up the test user login button
            const testUserBtn = document.getElementById('test-user-login');
            if (testUserBtn) {
                testUserBtn.addEventListener('click', function() {
                    // Test user credentials
                    const testEmail = 'test@example.com';
                    const testPassword = 'password123';
                    
                    // Try to sign in first
                    firebase.auth().signInWithEmailAndPassword(testEmail, testPassword)
                        .then((userCredential) => {
                            console.log('Test user signed in successfully');
                        })
                        .catch((error) => {
                            // If sign-in fails, create the user first
                            if (error.code === 'auth/user-not-found') {
                                console.log('Test user not found, creating account...');
                                firebase.auth().createUserWithEmailAndPassword(testEmail, testPassword)
                                    .then((userCredential) => {
                                        console.log('Test user created and signed in successfully');
                                    })
                                    .catch((createError) => {
                                        console.error('Error creating test user:', createError);
                                    });
                            } else {
                                console.error('Error signing in with test user:', error);
                            }
                        });
                });
            }
        }
    }
    
    // Function to toggle the sign-in overlay
    function toggleSignIn() {
        const overlay = document.getElementById('signin-overlay');
        overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
        document.body.style.overflow = overlay.style.display === 'block' ? 'hidden' : 'auto';
    }

    // Function to trigger the overlay sign-in
    function triggerSignInOverlay() {
        // This should use the same mechanism that the navbar sign-in button uses
        // If there's a global function or event, call it here
        if (typeof showSignInOverlay === 'function') {
            showSignInOverlay();
        } else if (typeof openSignInModal === 'function') {
            openSignInModal();
        } else {
            // Fallback: dispatch a custom event that the navbar might be listening for
            document.dispatchEvent(new CustomEvent('openSignInOverlay'));
            
            // If all else fails, try to click the navbar sign-in button programmatically
            const navSignInButton = document.querySelector('.nav-signin-button, .signin-button, #navSignInButton');
            if (navSignInButton) {
                navSignInButton.click();
            } else {
                console.error('Could not find a way to trigger the sign-in overlay. Please check your implementation.');
            }
        }
    }
    
    // Check if user has filled out the required forms
    function redirectOrNot(user) {
        // Get URL parameters first
        const urlParams = new URLSearchParams(window.location.search);
        const reason = urlParams.get('reason');
        
        checkUserAccountStatus(user)
        .then(function(result) {
            const status = result.userStatus;
            console.log("User account status:", status);

            // Handle different scenarios based on reason parameter
            switch(reason) {
                case 'trial':
                    handleTrialRedirect(status);
                    break;
                
                case 'purchase':
                    handlePurchaseRedirect(status);
                    break;
                
                default:
                    handleDefaultRedirect(status);
                    break;
            }

            // If we haven't redirected, show the account content
            if (!document.hidden) {
                $("#accountContent").show();
                fetchAvailableDownloads();
                console.log("Fetching license overview");
                fetchLicenseOverview();
                fetchLicenseTokensOverview();
            }
        })
        .catch(function(error) {
            console.error("Error checking user account status:", error);
            $("#signinButtonSection").show();
        });
    }

    // Helper function to handle trial redirects/notifications
    function handleTrialRedirect(status) {
        switch(status) {
            case 'pending':
                showNotification(
                    'We weren\'t able to process your trial request automatically, as your account is still awaiting approval from an earlier request. ' +
                    'If you have any questions or feel something might\'ve gone off track, just reach out to us at ' +
                    '<a href="mailto:info@eagleeyessearch.com" style="color: white; text-decoration: underline;">info@eagleeyessearch.com</a>. ' +
                    'We\'re happy to help!',
                    'warning',
                    true
                );
                break;
            
            case 'approved':
                showNotification(
                    'We weren\'t able to process your trial request automatically, as it looks like you already have an account with us. ' +
                    'Just send us a quick note at <a href="mailto:info@eagleeyessearch.com" style="color: white; text-decoration: underline;">' +
                    'info@eagleeyessearch.com</a> to request your trial, and we\'ll get back to you shortly.',
                    'warning',
                    true
                );
                break;
            
            default:
                // Redirect to user-form.html with reason parameter preserved
                redirectToUserForm('trial');
                break;
        }
    }

    // Helper function to handle purchase redirects/notifications
    function handlePurchaseRedirect(status) {
        switch(status) {
            case 'pending':
                showNotification(
                    'Your account is still awaiting approval from an earlier request. ' +
                    'If you have any questions or feel something might\'ve gone off track, just reach out to us at ' +
                    '<a href="mailto:info@eagleeyessearch.com" style="color: white; text-decoration: underline;">info@eagleeyessearch.com</a>. ' +
                    'We\'re happy to help!',
                    'warning',
                    true
                );
                break;
            
            case 'approved':
                showNotification(
                    'To do: forward to purchase site',
                    'info',
                    true
                );
                break;
            
            default:
                // Redirect to user-form.html with reason parameter preserved
                redirectToUserForm('purchase');
                break;
        }
    }

    // Helper function to handle default redirects (no reason parameter)
    function handleDefaultRedirect(status) {
        if (status !== 'pending' && status !== 'approved' && status !== 'unverified') {
            redirectToUserForm();
        }
        // Otherwise do nothing and let the account page load
    }

    // Helper function to handle redirects to user-form.html
    function redirectToUserForm(reason = '') {
        let url = 'user-form.html';
        
        // Add reason parameter if provided
        if (reason) {
            url += `?reason=${reason}`;
        }
        
        // Preserve emulator parameter if present
        window.location.href = getUrlWithEmulatorParam(url);
    }

    /***********************************************
     * SOFTWARE DOWNLOADS MANAGEMENT
     ***********************************************/

    // Fetch available software downloads for both Pilot and Scan
    async function fetchAvailableDownloads() {
        try {
            const user = firebase.auth().currentUser;
            
            if (!user) {
                throw new Error('No user logged in');
            }

            console.log('Fetching available downloads...');
            console.log('User email:', user.email);

            // Show spinners and hide grids initially
            document.getElementById('pilotSpinner').style.display = 'block';
            document.getElementById('pilotGrid').style.display = 'none';
            document.getElementById('pilotEmpty').style.display = 'none';
            document.getElementById('scanSpinner').style.display = 'block';
            document.getElementById('scanGrid').style.display = 'none';
            document.getElementById('scanEmpty').style.display = 'none';

            // First, get the list of available files from Firebase Storage
            const pilotFiles = await listFilesInDirectory('pilot-releases/current');
            const scanFiles = await listFilesInDirectory('scan_releases/current');

            console.log('Available Pilot files:', pilotFiles);
            console.log('Available Scan files:', scanFiles);

            // Render Pilot downloads as cards
            const pilotGrid = document.getElementById('pilotGrid');
            pilotGrid.innerHTML = '';

            if (pilotFiles.length === 0) {
                document.getElementById('pilotEmpty').style.display = 'block';
            } else {
                for (const file of pilotFiles) {
                    try {
                        // Use the structured data directly
                        const fileName = file.name;
                        const version = file.version || 'Unknown';
                        const platform = file.platform || 'Unknown';
                        const releaseDate = file.releaseDate ? new Date(file.releaseDate).toLocaleDateString() : '2024-03-20';
                        
                        const filePath = `pilot-releases/current/${fileName}`;
                        const downloadUrl = await generateDownloadLink(filePath, user);
                        
                        // Create a card for each download
                        const card = document.createElement('div');
                        card.className = 'download-card';
                        
                        // Card header with platform as clickable title
                        const header = document.createElement('div');
                        header.className = 'download-header';
                        
                        const title = document.createElement('h4');
                        title.className = 'download-title';
                        title.textContent = `Eagle Eyes Pilot - ${platform}`;
                        header.appendChild(title);
                        card.appendChild(header);
                        
                        // Card body with details
                        const body = document.createElement('div');
                        body.className = 'download-body';
                        
                        // Version
                        const versionRow = document.createElement('div');
                        versionRow.className = 'download-meta';
                        
                        const versionLabel = document.createElement('span');
                        versionLabel.className = 'download-meta-label';
                        versionLabel.textContent = 'Version:';
                        
                        const versionValue = document.createElement('span');
                        versionValue.className = 'download-meta-value';
                        versionValue.textContent = version;
                        
                        versionRow.appendChild(versionLabel);
                        versionRow.appendChild(versionValue);
                        body.appendChild(versionRow);
                        
                        // Release date
                        const dateRow = document.createElement('div');
                        dateRow.className = 'download-meta';
                        
                        const dateLabel = document.createElement('span');
                        dateLabel.className = 'download-meta-label';
                        dateLabel.textContent = 'Release Date:';
                        
                        const dateValue = document.createElement('span');
                        dateValue.className = 'download-meta-value';
                        dateValue.textContent = releaseDate;
                        
                        dateRow.appendChild(dateLabel);
                        dateRow.appendChild(dateValue);
                        body.appendChild(dateRow);
                        
                        // Add download link row showing the filename
                        const downloadRow = document.createElement('div');
                        downloadRow.className = 'download-meta';
                        downloadRow.style.marginTop = '15px';
                        downloadRow.style.display = 'flex';
                        downloadRow.style.justifyContent = 'space-between';
                        downloadRow.style.alignItems = 'center';
                        
                        const downloadLabel = document.createElement('span');
                        downloadLabel.className = 'download-meta-label';
                        downloadLabel.textContent = 'Download link:';
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.href = downloadUrl;
                        downloadLink.textContent = fileName;
                        downloadLink.className = 'download-link';
                        downloadLink.onclick = function() {
                            trackDownload('pilot', fileName);
                        };
                        
                        downloadRow.appendChild(downloadLabel);
                        downloadRow.appendChild(downloadLink);
                        body.appendChild(downloadRow);
                        
                        card.appendChild(body);
                        
                        pilotGrid.appendChild(card);
                        
                    } catch (error) {
                        console.error(`Error processing pilot file ${file}:`, error);
                    }
                }
                document.getElementById('pilotGrid').style.display = 'grid';
            }

            // Render Scan downloads as cards
            const scanGrid = document.getElementById('scanGrid');
            scanGrid.innerHTML = '';

            if (scanFiles.length === 0) {
                document.getElementById('scanEmpty').style.display = 'block';
            } else {
                for (const file of scanFiles) {
                    try {
                        // Use the structured data directly
                        const fileName = file.name;
                        const version = file.version || 'Unknown';
                        const platform = file.platform || 'Unknown';
                        const releaseDate = file.releaseDate ? new Date(file.releaseDate).toLocaleDateString() : '2024-03-20';
                        
                        const filePath = `scan_releases/current/${fileName}`;
                        const downloadUrl = await generateDownloadLink(filePath, user);
                        
                        // Create a card for each download
                        const card = document.createElement('div');
                        card.className = 'download-card';
                        
                        // Card header with platform as clickable title
                        const header = document.createElement('div');
                        header.className = 'download-header';
                        
                        const title = document.createElement('h4');
                        title.className = 'download-title';
                        title.textContent = `Eagle Eyes Scan - ${platform}`;
                        header.appendChild(title);
                        card.appendChild(header);
                        
                        // Card body with details
                        const body = document.createElement('div');
                        body.className = 'download-body';
                        
                        // Version
                        const versionRow = document.createElement('div');
                        versionRow.className = 'download-meta';
                        
                        const versionLabel = document.createElement('span');
                        versionLabel.className = 'download-meta-label';
                        versionLabel.textContent = 'Version:';
                        
                        const versionValue = document.createElement('span');
                        versionValue.className = 'download-meta-value';
                        versionValue.textContent = version;
                        
                        versionRow.appendChild(versionLabel);
                        versionRow.appendChild(versionValue);
                        body.appendChild(versionRow);
                        
                        // Release date
                        const dateRow = document.createElement('div');
                        dateRow.className = 'download-meta';
                        
                        const dateLabel = document.createElement('span');
                        dateLabel.className = 'download-meta-label';
                        dateLabel.textContent = 'Release Date:';
                        
                        const dateValue = document.createElement('span');
                        dateValue.className = 'download-meta-value';
                        dateValue.textContent = releaseDate;
                        
                        dateRow.appendChild(dateLabel);
                        dateRow.appendChild(dateValue);
                        body.appendChild(dateRow);
                        
                        // Add download link row showing the filename
                        const downloadRow = document.createElement('div');
                        downloadRow.className = 'download-meta';
                        downloadRow.style.marginTop = '15px';
                        downloadRow.style.display = 'flex';
                        downloadRow.style.justifyContent = 'space-between';
                        downloadRow.style.alignItems = 'center';
                        
                        const downloadLabel = document.createElement('span');
                        downloadLabel.className = 'download-meta-label';
                        downloadLabel.textContent = 'Download link:';
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.href = downloadUrl;
                        downloadLink.textContent = fileName;
                        downloadLink.className = 'download-link';
                        downloadLink.onclick = function() {
                            trackDownload('scan', fileName);
                        };
                        
                        downloadRow.appendChild(downloadLabel);
                        downloadRow.appendChild(downloadLink);
                        body.appendChild(downloadRow);
                        
                        card.appendChild(body);
                        
                        scanGrid.appendChild(card);
                        
                    } catch (error) {
                        console.error(`Error processing scan file ${file}:`, error);
                    }
                }
                document.getElementById('scanGrid').style.display = 'grid';
            }

            // Hide spinners
            document.getElementById('pilotSpinner').style.display = 'none';
            document.getElementById('scanSpinner').style.display = 'none';
            
        } catch (error) {
            console.error('Error in fetchAvailableDownloads:', error);
            
            // Show error messages and hide spinners
            document.getElementById('pilotSpinner').style.display = 'none';
            document.getElementById('scanSpinner').style.display = 'none';
            
            // Create error message elements
            const pilotError = document.createElement('div');
            pilotError.textContent = 'Error loading downloads. Please try again later.';
            pilotError.className = 'no-downloads';
            
            const scanError = document.createElement('div');
            scanError.textContent = 'Error loading downloads. Please try again later.';
            scanError.className = 'no-downloads';
            
            // Clear and show error messages
            const pilotGrid = document.getElementById('pilotGrid');
            pilotGrid.innerHTML = '';
            pilotGrid.appendChild(pilotError);
            pilotGrid.style.display = 'block';
            
            const scanGrid = document.getElementById('scanGrid');
            scanGrid.innerHTML = '';
            scanGrid.appendChild(scanError);
            scanGrid.style.display = 'block';
        }
    }

    // List available files in a directory
    async function listFilesInDirectory(directory) {
        const user = firebase.auth().currentUser;
        
        if (!user) {
            console.error('No user logged in when trying to list files');
            return [];
        }

        try {
            const idToken = await user.getIdToken(true);
            console.log(`Fetching files from directory: ${directory}`);
            
            const hostURL = window.getHostUrl();
            console.log('Using host URL:', hostURL);
            
            const response = await fetch(`${hostURL}/list_files?directory=${directory}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to list files:', response.status, response.statusText, errorText);
                throw new Error(`Failed to list files: ${errorText}`);
            }
            
            const data = await response.json();
            console.log(`Files found in ${directory}:`, data.files);
            return data.files || [];
        } catch (error) {
            console.error(`Error listing files in ${directory}:`, error);
            return [];
        }
    }

    // Generate download link for a file
    async function generateDownloadLink(filePath, user) {
        if (!user) {
            console.error('No user logged in when trying to generate download link');
            throw new Error('No user logged in');
        }

        try {
            const idToken = await user.getIdToken(true);
            console.log('Generating download link for:', filePath);
            
            const hostURL = window.getHostUrl();
            const response = await fetch(`${hostURL}/generate_download_link?filePath=${filePath}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                credentials: 'same-origin',
                body: JSON.stringify({
                    form_data: {
                        email: user.email,
                        name: user.displayName || '',
                    }
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to generate download link:', response.status, response.statusText, errorText);
                throw new Error(`Failed to generate download link: ${errorText}`);
            }
            
            const data = await response.json();
            console.log('Generated download link:', data.url);
            return data.url;
        } catch (error) {
            console.error('Error generating download link:', error);
            throw error;
        }
    }

    // Track download analytics
    function trackDownload(type, filename) {
        // Track download event
        fathom.trackEvent(`download_${type}`, {
            _value: 0,
            download: filename
        });
        hj('event', `download_${type}`);
    }

    /***********************************************
     * LICENSE MANAGEMENT
     ***********************************************/
    
    // Fetch license overview data
    async function fetchLicenseOverview() {
      try {
        // Show spinner, hide cards initially
        document.getElementById('licenseSpinner').style.display = 'block';
        document.getElementById('licenseGrid').style.display = 'none';
        document.getElementById('licenseError').style.display = 'none';
        document.getElementById('licenseEmpty').style.display = 'none';
        
        const user = firebase.auth().currentUser;
        if (!user) {
          console.error('User is not logged in.');
          return;
        }
        const idToken = await user.getIdToken(true);
        const hostURL = window.getHostUrl ? window.getHostUrl() : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
        
        const response = await fetch(`${hostURL}/get_license_overview`, {
          method: 'GET',
          mode: 'cors',
          credentials: 'same-origin',
          headers: {
            'Authorization': 'Bearer ' + idToken,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          console.error('Error fetching license overview:', response.statusText);
          document.getElementById('licenseSpinner').style.display = 'none';
          document.getElementById('licenseError').style.display = 'block';
          return;
        }
        const data = await response.json();
        
        // Log the received license data for debugging
        console.log('License overview received:', data.overview);
        if (data.overview && data.overview.length > 0) {
          console.log('Sample license data:', data.overview[0]);
        }
        
        renderLicenseCards(data.overview);
        
        // Hide spinner, show cards after data is processed
        document.getElementById('licenseSpinner').style.display = 'none';
        if (!data.overview || data.overview.length === 0) {
          document.getElementById('licenseEmpty').style.display = 'block';
            } else {
          document.getElementById('licenseGrid').style.display = 'grid';
        }
      } catch (error) {
        console.error('Error in fetchLicenseOverview:', error);
        
        // Show error message
        document.getElementById('licenseSpinner').style.display = 'none';
        document.getElementById('licenseError').style.display = 'block';
      }
    }

    // Render license cards from data
    function renderLicenseCards(overview) {
      const licenseGrid = document.getElementById('licenseGrid');
      licenseGrid.innerHTML = ''; // Clear existing cards
      
      if (!overview || overview.length === 0) {
        document.getElementById('licenseEmpty').style.display = 'block';
        document.getElementById('licenseGrid').style.display = 'none';
        return;
      }
      
      overview.forEach(license => {
        // Create license card container
        const card = document.createElement('div');
        card.className = 'license-card';
        
        // Create header with left and right sections
        const header = document.createElement('div');
        header.className = 'license-header';
        
        // Left section - Name and ID
        const headerLeft = document.createElement('div');
        headerLeft.className = 'license-header-left';
        
        const title = document.createElement('h4');
        title.className = 'license-title';
        title.textContent = license.license_name;
        
        const subtitle = document.createElement('p');
        subtitle.className = 'license-subtitle';
        subtitle.textContent = `ID: ${license.license_id}`;
        
        headerLeft.appendChild(title);
        headerLeft.appendChild(subtitle);
        
        // Right section - Expiry date and Devices
        const headerRight = document.createElement('div');
        headerRight.className = 'license-header-right';
        
        // Expiry Date
        const expiryMeta = document.createElement('div');
        expiryMeta.className = 'license-meta';
        expiryMeta.innerHTML = `Expires: <span class="license-meta-highlight">${license.expiry_date}</span>`;
        
        // Devices info
        const devicesMeta = document.createElement('div');
        devicesMeta.className = 'license-meta';
        const keysLeft = license.keys_left || 0;
        const totalKeys = license.total_keys || 'Unlimited';
        devicesMeta.innerHTML = `Devices (remaining/total): <span class="license-meta-highlight">${keysLeft}/${totalKeys}</span>`;
        
        headerRight.appendChild(expiryMeta);
        headerRight.appendChild(devicesMeta);
        
        // Assemble the header
        header.appendChild(headerLeft);
        header.appendChild(headerRight);
        card.appendChild(header);
        
        // Card body - only for device users
        const body = document.createElement('div');
        body.className = 'license-body';
        
        // Display device users if available
        if (license.keys_used_by && license.keys_used_by.length > 0) {
          const usersLabel = document.createElement('div');
          usersLabel.className = 'license-users-label';
          usersLabel.textContent = 'Device users:';
          
          const usersList = document.createElement('div');
          usersList.className = 'license-users-list';
          usersList.textContent = license.keys_used_by.join(', ');
          
          body.appendChild(usersLabel);
          body.appendChild(usersList);
        } else {
          // Show empty state message
          body.innerHTML = '<div class="license-empty">No devices are currently using this license</div>';
        }
        
        card.appendChild(body);
        licenseGrid.appendChild(card);
      });
    }

    /***********************************************
     * DEVICE TOKENS MANAGEMENT
     ***********************************************/
    
    // Fetch device tokens overview
    async function fetchLicenseTokensOverview() {
      try {
        // Show spinner, hide cards initially
        document.getElementById('tokensSpinner').style.display = 'block';
        document.getElementById('tokensGrid').style.display = 'none';
        document.getElementById('tokensError').style.display = 'none';
        document.getElementById('tokensEmpty').style.display = 'none';
        
        const user = firebase.auth().currentUser;
        if (!user) {
          console.error('User is not logged in.');
          return;
        }
        const idToken = await user.getIdToken(true);
        const hostURL = window.getHostUrl ? window.getHostUrl() : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
        
        const response = await fetch(`${hostURL}/get_license_tokens_overview`, {
          method: 'GET',
          mode: 'cors',
          credentials: 'same-origin',
                headers: {
            'Authorization': 'Bearer ' + idToken,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          console.error('Error fetching tokens overview:', response.statusText);
          document.getElementById('tokensSpinner').style.display = 'none';
          document.getElementById('tokensError').style.display = 'block';
          return;
        }
        const data = await response.json();
        
        // Log the received token data for debugging
        console.log('License tokens response:', data);
        console.log('License tokens received:', data.tokens);
        if (data.tokens && data.tokens.length > 0) {
          console.log('Sample token data:', data.tokens[0]);
          
          // Group tokens by machine_id for easier debugging
          const tokensByMachine = {};
          data.tokens.forEach(token => {
            if (!tokensByMachine[token.machine_id]) {
              tokensByMachine[token.machine_id] = [];
            }
            tokensByMachine[token.machine_id].push(token);
          });
          console.log('Tokens grouped by machine:', tokensByMachine);
        }
        
        renderTokenCards(data.tokens);
        
        // Hide spinner, show cards after data is processed
        document.getElementById('tokensSpinner').style.display = 'none';
        if (!data.tokens || data.tokens.length === 0) {
          document.getElementById('tokensEmpty').style.display = 'block';
                    } else {
          document.getElementById('tokensGrid').style.display = 'grid';
        }
      } catch (error) {
        console.error('Error in fetchLicenseTokensOverview:', error);
        
        // Show error message
        document.getElementById('tokensSpinner').style.display = 'none';
        document.getElementById('tokensError').style.display = 'block';
      }
    }
    
    // Render device token cards from data
    function renderTokenCards(tokensOverview) {
      const tokensGrid = document.getElementById('tokensGrid');
      tokensGrid.innerHTML = ''; // Clear existing cards
      
      if (!tokensOverview || tokensOverview.length === 0) {
        document.getElementById('tokensEmpty').style.display = 'block';
        document.getElementById('tokensGrid').style.display = 'none';
        return;
      }
      
      // Group tokens by machine_id
      const tokensByMachine = {};
      tokensOverview.forEach(token => {
        if (!tokensByMachine[token.machine_id]) {
          tokensByMachine[token.machine_id] = [];
        }
        tokensByMachine[token.machine_id].push(token);
      });
      
      // Counter for unnamed devices
      let unnamedDeviceCounter = 0;
      
      // Create a card for each machine_id
      Object.entries(tokensByMachine).forEach(([machineId, tokens]) => {
        // Increment the counter for each device without a name
        unnamedDeviceCounter++;
        
        // Get device name from the first token or use default
        const deviceName = tokens.length > 0 && tokens[0].device_name ? 
                           tokens[0].device_name : 
                           `Device ${unnamedDeviceCounter}`;
        
        // Create token card container
        const card = document.createElement('div');
        card.className = 'token-card';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'token-header';
        
        // Left section - Device name and Machine ID
        const headerLeft = document.createElement('div');
        headerLeft.className = 'token-header-left';
        
        const title = document.createElement('h4');
        title.className = 'token-title';
        title.textContent = deviceName;
        
        const subtitle = document.createElement('p');
        subtitle.className = 'token-subtitle';
        subtitle.textContent = `Machine ID: ${machineId}`;
        
        headerLeft.appendChild(title);
        headerLeft.appendChild(subtitle);
        
        // Assemble the header
        header.appendChild(headerLeft);
        card.appendChild(header);
        
        // Card body - list each license with its token
        const body = document.createElement('div');
        body.className = 'token-body';
        
        if (tokens.length > 0) {
          tokens.forEach(token => {
            const licenseItem = document.createElement('div');
            licenseItem.className = 'token-license-item';
            
            // License info
            const licenseInfo = document.createElement('div');
            licenseInfo.className = 'token-license-info';
            
            const licenseName = document.createElement('div');
            licenseName.className = 'token-license-id';
            licenseName.textContent = token.license_name;
            
            const licenseId = document.createElement('div');
            licenseId.className = 'token-license-expiry';
            licenseId.textContent = `License ID: ${token.license_id}`;
            
            const licenseExpiry = document.createElement('div');
            licenseExpiry.className = 'token-license-expiry';
            licenseExpiry.textContent = `Expires: ${token.expiry_date}`;
            
            licenseInfo.appendChild(licenseName);
            licenseInfo.appendChild(licenseId);
            licenseInfo.appendChild(licenseExpiry);
            
            // Copy button
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.textContent = 'Copy Key';
            copyButton.onclick = function() {
              copyToClipboard(token.token_key, copyButton);
            };
            
            licenseItem.appendChild(licenseInfo);
            licenseItem.appendChild(copyButton);
            
            body.appendChild(licenseItem);
          });
        } else {
          // Show empty state message
          body.innerHTML = '<div class="token-empty">No license tokens found for this device</div>';
        }
        
        card.appendChild(body);
        tokensGrid.appendChild(card);
      });
    }
    
    // Copy text to clipboard with visual feedback
    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(
        function() {
          // Success - show visual feedback
          button.textContent = 'Copied!';
          button.classList.add('copied');
          
          // Reset button after 2 seconds
          setTimeout(function() {
            button.textContent = 'Copy Key';
            button.classList.remove('copied');
          }, 2000);
        },
        function(err) {
          console.error('Could not copy text: ', err);
          button.textContent = 'Error';
          
          // Reset button after 2 seconds
          setTimeout(function() {
            button.textContent = 'Copy Key';
          }, 2000);
        }
      );
    }

    /***********************************************
     * UTILITY FUNCTIONS
     ***********************************************/
    
    // Get emulator mode from URL parameters
    function getIsEmulatorFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('is_emulator') === 'true';
    }

    // Add emulator parameter to URL if needed
    function getUrlWithEmulatorParam(url) {
        const isEmulator = new URLSearchParams(window.location.search).get('is_emulator') === 'true';
        if (!isEmulator) return url;
        
        // Add the parameter to the URL if it doesn't already have it
        const separator = url.includes('?') ? '&' : '?';
        return url.includes('is_emulator=true') ? url : `${url}${separator}is_emulator=true`;
    }

    // Optional function to populate account info from form data
    function populateAccountInfo(formData) {
        // Update the page with user-specific information
        if (formData.name) {
            $("#user-name").text(formData.name);
        }
        if (formData.team) {
            $("#user-team").text(formData.team);
        }
        // Add other fields as needed
    }

    /**
     * Check the user's account status by calling the backend get_user_account_info function.
     * The backend response includes:
     *   - userStatus: one of "approved", "pending", "unverified", or "no_account"
     *   - form_data: the form data attached to the account record (or null if not found)
     *
     * Returns a Promise that resolves with the parsed response.
     */
    function checkUserAccountStatus(user) {
        return new Promise((resolve, reject) => {
            if (!user) {
                reject(new Error("No user provided"));
                return;
            }

            user.getIdToken(true).then(function(idToken) {
                const hostURL = window.getHostUrl ? window.getHostUrl() : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
                const fetch_url = hostURL + '/get_user_account_info';
                
                console.log("Checking user account status at:", fetch_url);
                
                $.ajax({
                    url: fetch_url,
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + idToken
                    },
                    success: function(data) {
                        console.log("User account status response:", data);
                        // If data comes as a string, parse it; otherwise, assume it's already JSON.
                        const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                        resolve(parsedData);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("Error getting account status:", textStatus, errorThrown);
                        console.error("Response:", jqXHR.responseText);
                        reject(errorThrown);
                    }
                });
            }).catch(function(error) {
                console.error("Error getting ID token:", error);
                reject(error);
            });
        });
    }

    /**
     * Show notification banner with a message
     * @param {string} message - The message to display
     * @param {string} type - The type of notification: 'info' (blue), 'success' (green), 'warning' (orange), or 'error' (red)
     * @param {boolean} dismissible - Whether the notification can be dismissed by the user
     */
    function showNotification(message, type = 'info', dismissible = true) {
        const banner = document.getElementById('notification-banner');
        const textContainer = document.getElementById('notification-text');
        const closeButton = document.getElementById('close-notification');
        
        // Set the message
        textContainer.innerHTML = message;
        
        // Set the color based on type
        let bgColor = '#3498db'; // Default blue for 'info'
        switch(type) {
            case 'success':
                bgColor = '#2ecc71';
                break;
            case 'warning':
                bgColor = '#f39c12';
                break;
            case 'error':
                bgColor = '#e74c3c';
                break;
        }
        banner.style.backgroundColor = bgColor;
        
        // Show/hide close button based on dismissible option
        closeButton.style.display = dismissible ? 'block' : 'none';
        
        // Show the banner
        banner.style.display = 'block';
        
        // Add event listener to close button if dismissible
        if (dismissible) {
            closeButton.onclick = function() {
                hideNotification();
            };
        }
    }

    /**
     * Hide the notification banner
     */
    function hideNotification() {
        const banner = document.getElementById('notification-banner');
        banner.style.display = 'none';
    }
</script>

</body>

