---
layout: main
title: Account Management - Eagle Eyes
---
<style>
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    .table th {
        text-align: left;
        padding: 12px;
        font-weight: 500;
        color: #666;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    .table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 15px;
    }
    .table tr:last-child td {
        border-bottom: none;
    }
    .table tr:hover td {
        background-color: #f9f9f9;
    }
    .loading-spinner {
        text-align: center;
        padding: 20px;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    h4 {
        margin-bottom: 15px;
        color: #333;
    }
    .download-link {
        color: #1e90ff;
        text-decoration: none;
        font-weight: 500;
    }
    .download-link:hover {
        text-decoration: underline;
    }
    .table th:nth-child(1) { width: 40%; }  /* Platform - wider to fit text */
    .table th:nth-child(2) { width: 18%; }  /* Version - slightly narrower */
    .table th:nth-child(3) { width: 22%; }  /* Release Date - slightly narrower */
    .table th:nth-child(4) { width: 20%; }  /* Download - slightly narrower */
</style>

<div class="section-block bkg-grey-ultralight" style="padding: 120px 0 30px 0;">
    <div class="row">
        <div class="column width-12">
            <div class="centered">
                <h2 class="mb-10">Account</h2>
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
                    <div id="userEmailDisplay" style="color: #666; font-size: 16px;"></div>
                    <div id="signOutContainer" style="display: none;">
                        <a href="#" id="signOutButton" class="button small rounded" style="padding: 8px 15px; font-size: 14px;">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-block" style="padding-top: 20px;">
    <div class="row">
        <div class="column width-8 offset-2">
            <!-- Sign in button (will trigger overlay) -->
            <div id="signinButtonSection" style="display: none; text-align: center; margin-bottom: 40px;">
                <p style="margin-bottom: 20px;">Sign in to access your account, downloads, and licenses.</p>
                <button id="accountSignInButton" class="button" onclick="toggleSignIn()">Sign In or Create Account</button>
            </div>

            <!-- Account content section -->
            <div id="accountContent" style="display: none;">
                <div class="box rounded xlarge bkg-white shadow">
                    <div class="box-content">
                        <div class="row">
                            <div class="column width-12">
                                <h3 class="mb-30">Downloads</h3>
                                
                                <div class="mb-50">
                                    <h4>Eagle Eyes Pilot</h4>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Platform</th>
                                                <th>Version</th>
                                                <th>Release Date</th>
                                                <th>Download</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pilotDownloads">
                                            <tr>
                                                <td colspan="4" style="text-align: center;">Loading available downloads...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mb-50">
                                    <h4>Eagle Eyes Scan</h4>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Platform</th>
                                                <th>Version</th>
                                                <th>Release Date</th>
                                                <th>Download</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scanDownloads">
                                            <tr>
                                                <td colspan="4" style="text-align: center;">Loading available downloads...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <h3 class="mb-30">Licenses</h3>
                                <div id="licensesContent" class="mb-30">
                                    <div class="loading-spinner" style="display: none;">
                                        <div class="spinner"></div>
                                    </div>
                                    <div id="licensesList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Begin License Section -->
<section id="licenses">
    <h2>Select an Existing License</h2>
    <div class="container">
        <div class="box license-box">
            <div class="input-label">
                Use a license already connected to your account:
            </div>
            <select id="license-select">
                <!-- Options will be dynamically populated by JavaScript -->
            </select>
            <textarea id="license-info" class="license-info-box" placeholder="" readonly></textarea>
            <div class="button-container">
                <button id="selectLicenseButton" onclick="selectLicense()">Select License</button>
            </div>
            <div id="select-license-info" class="info-box" hidden></div>
        </div>
        <div class="spacer"></div>
        <div class="box">
            <div class="input-label">
                ... Or enter a License ID to connect to your account:
                <span class="tooltip">ℹ️
                    <span class="tooltiptext">If your organisation has a license available, you can attach it to your account by entering the license ID below.</span>
                </span>
            </div>
            <input type="text" id="license-id" placeholder="(e.g. jI9Y9kg8oK3w2yf2)" style="width: 100%;">
            <div class="button-group">
                <button onclick="reCheckLicense()" id="re-check-button" class="non_important_button">Re-check</button>
            </div>
        </div>
    </div>
</section>
<!-- End License Section -->

<!-- Keep this sign-in overlay in account.html -->
<div id="signin-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; width: 100%; height: 100%;">
        {% include signinwidget-main.html %}
        <button onclick="toggleSignIn()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
    </div>
</div>

<script>
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
        const signinButtonSection = document.getElementById('signinButtonSection');
        const accountContent = document.getElementById('accountContent');
        const userEmail = document.getElementById('userEmailDisplay');
        const signOutContainer = document.getElementById('signOutContainer');
        const signOutButton = document.getElementById('signOutButton');

        // Listen for auth state changes
        document.addEventListener('authStateChanged', function(e) {
            const user = e.detail.user;
            if (user) {
                
                // User is signed in
                signinButtonSection.style.display = 'none';
                userEmail.textContent = `Logged in as: ${user.email}`;
                signOutContainer.style.display = 'block';
                
                // Don't immediately check or show form - let signinwidget handle redirects
                // We'll only display forms if we know we need to stay on this page
                hangOnMessage.style.display = 'block';
                setTimeout(function() {
                    // If we're still on this page after a short delay,
                    // the user probably needs to fill this form
                    checkExistingForm(user);
                }, 200);
            } else {
                // User is signed out
                signinButtonSection.style.display = 'block';
                accountContent.style.display = 'none';
                userEmail.textContent = '';
                signOutContainer.style.display = 'none'; // Hide the sign-out button
            }
        });

        // Initial auth state check
        if (firebase.auth().currentUser) {
            const user = firebase.auth().currentUser;
            signinButtonSection.style.display = 'none';
            accountContent.style.display = 'block';
            userEmail.textContent = `Logged in as: ${user.email}`;
            signOutContainer.style.display = 'block'; // Show the sign-out button
            fetchLicenses(user.uid);
            fetchAvailableDownloads();
        }

        // Handle sign out
        if (signOutButton) {
            signOutButton.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent the default link behavior
                
                firebase.auth().signOut().then(function() {
                    // Sign-out successful - the auth state listener will handle UI updates
                    console.log('User signed out successfully');
                    
                    // Optionally reload the page for a clean state
                    window.location.reload();
                }).catch(function(error) {
                    // An error happened
                    console.error('Error signing out:', error);
                });
            });
        }

        // Keep this event handler for backward compatibility
        document.addEventListener('signInComplete', function(e) {
            const user = e.detail.user;
            toggleSignIn(); // Hide the overlay
        });
    });

    async function fetchLicenses(userId) {
        const licensesList = document.getElementById('licensesList');
        const loadingSpinner = document.querySelector('.loading-spinner');
        
        try {
            if (!firebase.firestore) {
                console.error("Firestore is not available yet. Retrying fetchLicenses...");
                setTimeout(() => fetchLicenses(userId), 100);
                return;
            }
            loadingSpinner.style.display = 'block';
            licensesList.innerHTML = '';

            const licensesRef = firebase.firestore().collection('licenses');
            const snapshot = await licensesRef.where('userId', '==', userId).get();

            if (snapshot.empty) {
                licensesList.innerHTML = '<p>No licenses found.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const license = doc.data();
                const licenseElement = document.createElement('div');
                licenseElement.className = 'license-item';
                licenseElement.innerHTML = `
                    <h4>${license.name}</h4>
                    <p>Expires: ${new Date(license.expirationDate.toDate()).toLocaleDateString()}</p>
                    <p>Devices: ${license.devices}</p>
                `;
                licensesList.appendChild(licenseElement);
            });
        } catch (error) {
            console.error('Error fetching licenses:', error);
            licensesList.innerHTML = '<p>Error loading licenses. Please try again later.</p>';
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    async function fetchAvailableDownloads() {
        try {
            const user = firebase.auth().currentUser;
            
            if (!user) {
                throw new Error('No user logged in');
            }

            console.log('Fetching available downloads...');
            console.log('User email:', user.email);

            // First, get the list of available files from Firebase Storage
            const pilotFiles = await listFilesInDirectory('pilot-releases/current');
            const scanFiles = await listFilesInDirectory('scan_releases/current');

            console.log('Available Pilot files:', pilotFiles);
            console.log('Available Scan files:', scanFiles);

            // Get Pilot downloads
            const pilotDownloads = document.getElementById('pilotDownloads');
            pilotDownloads.innerHTML = '';

            if (pilotFiles.length === 0) {
                pilotDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">No Pilot downloads available.</td></tr>';
            } else {
                for (const file of pilotFiles) {
                    try {
                        // Use the structured data directly
                        const fileName = file.name;
                        const version = file.version || 'Unknown';
                        const platform = file.platform || 'Unknown';
                        const releaseDate = file.releaseDate ? new Date(file.releaseDate).toLocaleDateString() : '2024-03-20';
                        
                        const filePath = `pilot-releases/current/${fileName}`;
                        const downloadUrl = await generateDownloadLink(filePath, user);
                        
                        pilotDownloads.innerHTML += `
                            <tr>
                                <td>${platform}</td>
                                <td>${version}</td>
                                <td>${releaseDate}</td>
                                <td><a href="${downloadUrl}" class="download-link" onclick="trackDownload('pilot', '${fileName}')">Download</a></td>
                            </tr>
                        `;
                    } catch (error) {
                        console.error(`Error processing pilot file ${file}:`, error);
                        pilotDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
                    }
                }
            }

            // Get Scan downloads
            const scanDownloads = document.getElementById('scanDownloads');
            scanDownloads.innerHTML = '';

            if (scanFiles.length === 0) {
                scanDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">No Scan downloads available.</td></tr>';
            } else {
                for (const file of scanFiles) {
                    try {
                        // Use the structured data directly
                        const fileName = file.name;
                        const version = file.version || 'Unknown';
                        const platform = file.platform || 'Unknown';
                        const releaseDate = file.releaseDate ? new Date(file.releaseDate).toLocaleDateString() : '2024-03-20';
                        
                        const filePath = `scan_releases/current/${fileName}`;
                        const downloadUrl = await generateDownloadLink(filePath, user);
                        
                        scanDownloads.innerHTML += `
                            <tr>
                                <td>${platform}</td>
                                <td>${version}</td>
                                <td>${releaseDate}</td>
                                <td><a href="${downloadUrl}" class="download-link" onclick="trackDownload('scan', '${fileName}')">Download</a></td>
                            </tr>
                        `;
                    } catch (error) {
                        console.error(`Error processing scan file ${file}:`, error);
                        scanDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
                    }
                }
            }
        } catch (error) {
            console.error('Error in fetchAvailableDownloads:', error);
            document.getElementById('pilotDownloads').innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
            document.getElementById('scanDownloads').innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
        }
    }

    async function listFilesInDirectory(directory) {
        const user = firebase.auth().currentUser;
        
        if (!user) {
            console.error('No user logged in when trying to list files');
            return [];
        }

        try {
            const idToken = await user.getIdToken(true);
            console.log(`Fetching files from directory: ${directory}`);
            
            const hostURL = window.getHostUrl();
            console.log('Using host URL:', hostURL);
            
            const response = await fetch(`${hostURL}/list_files?directory=${directory}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to list files:', response.status, response.statusText, errorText);
                throw new Error(`Failed to list files: ${errorText}`);
            }
            
            const data = await response.json();
            console.log(`Files found in ${directory}:`, data.files);
            return data.files || [];
        } catch (error) {
            console.error(`Error listing files in ${directory}:`, error);
            return [];
        }
    }

    async function generateDownloadLink(filePath, user) {
        if (!user) {
            console.error('No user logged in when trying to generate download link');
            throw new Error('No user logged in');
        }

        try {
            const idToken = await user.getIdToken(true);
            console.log('Generating download link for:', filePath);
            
            const hostURL = window.getHostUrl();
            const response = await fetch(`${hostURL}/generate_download_link?filePath=${filePath}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                credentials: 'same-origin',
                body: JSON.stringify({
                    form_data: {
                        email: user.email,
                        name: user.displayName || '',
                    }
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to generate download link:', response.status, response.statusText, errorText);
                throw new Error(`Failed to generate download link: ${errorText}`);
            }
            
            const data = await response.json();
            console.log('Generated download link:', data.url);
            return data.url;
        } catch (error) {
            console.error('Error generating download link:', error);
            throw error;
        }
    }

    function trackDownload(type, filename) {
        // Track download event
        fathom.trackEvent(`download_${type}`, {
            _value: 0,
            download: filename
        });
        hj('event', `download_${type}`);
    }

    function getIsEmulatorFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('is_emulator') === 'true';
    }

    // Function to trigger the overlay sign-in
    function triggerSignInOverlay() {
        // This should use the same mechanism that the navbar sign-in button uses
        // If there's a global function or event, call it here
        if (typeof showSignInOverlay === 'function') {
            showSignInOverlay();
        } else if (typeof openSignInModal === 'function') {
            openSignInModal();
        } else {
            // Fallback: dispatch a custom event that the navbar might be listening for
            document.dispatchEvent(new CustomEvent('openSignInOverlay'));
            
            // If all else fails, try to click the navbar sign-in button programmatically
            const navSignInButton = document.querySelector('.nav-signin-button, .signin-button, #navSignInButton');
            if (navSignInButton) {
                navSignInButton.click();
            } else {
                console.error('Could not find a way to trigger the sign-in overlay. Please check your implementation.');
            }
        }
    }

    function toggleSignIn() {
        const overlay = document.getElementById('signin-overlay');
        overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
        document.body.style.overflow = overlay.style.display === 'block' ? 'hidden' : 'auto';
    }

    // Add this script to check if user should have access to this page
    $(document).ready(function() {
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // No redirect logic here - just update the UI
                $("#signin").hide();
                $("#signinButtonSection").hide();
            } else {
                // Show sign-in widget
                $("#accountContent").hide();
                $("#licenses").hide();
                $("#signinButtonSection").show();
                $("#signin").show();
            }
        });
    });
    
    // Optional function to populate account info from form data
    function populateAccountInfo(formData) {
        // Update the page with user-specific information
        if (formData.name) {
            $("#user-name").text(formData.name);
        }
        if (formData.team) {
            $("#user-team").text(formData.team);
        }
        // Add other fields as needed
    }

    function checkExistingForm(user) {
        const hangOnMessage = document.getElementById('hang-on-message');
        
        hangOnMessage.style.display = 'block';
        
        // Get the host URL for API calls
        const hostURL = window.getHostUrl ? window.getHostUrl() : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
        const fetch_url = hostURL + '/has_user_already_filled_in_form';
        
        user.getIdToken(true).then(function(idToken) {
            $.ajax({
                url: fetch_url,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    hangOnMessage.style.display = 'none';
                    
                    console.log("Got reply from has_user_already_filled_in_form:", data);
                    
                    // Parse the response if it's a string
                    const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                    const formOrNull = parsedData.form;
                    
                    if (formOrNull === null) {
                        // User has not filled in the form yet
                        console.log('User did not fill in form yet.');
                        formContainer.style.display = 'block';
                        console.log("Redirecting to create-account.html");
                        window.location.href = 'create-account.html';
                    } else {
                        // User has already filled in the form
                        console.log("User already filled in form.");
                        //display account page
                        $("#accountContent").show();
                        $("#licenses").show();
                        // Fetch and display licenses and downloads
                        fetchLicenses(user.uid);
                        fetchAvailableDownloads();
                        // User has already filled a form - should be on account.html
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    hangOnMessage.style.display = 'none';
                    console.error("Error checking form:", textStatus, errorThrown, jqXHR.responseText);
                    
                    // Show the form anyway on error
                    formContainer.style.display = 'block';
                }
            });
        }).catch(function(error) {
            hangOnMessage.style.display = 'none';
            console.error("Error getting ID token:", error);
            
            // Show the form anyway on error
            formContainer.style.display = 'block';
        });
    }
</script>

</body>

