---
layout: main
title: Account Management - Eagle Eyes
---
<style>
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    .table th {
        text-align: left;
        padding: 12px;
        font-weight: 500;
        color: #666;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    .table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 15px;
    }
    .table tr:last-child td {
        border-bottom: none;
    }
    .table tr:hover td {
        background-color: #f9f9f9;
    }
    .loading-spinner {
        text-align: center;
        padding: 20px;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    h4 {
        margin-bottom: 15px;
        color: #333;
    }
    .download-link {
        color: #1e90ff;
        text-decoration: none;
        font-weight: 500;
    }
    .download-link:hover {
        text-decoration: underline;
    }
    .table th:nth-child(1) { width: 40%; }  /* Platform - wider to fit text */
    .table th:nth-child(2) { width: 18%; }  /* Version - slightly narrower */
    .table th:nth-child(3) { width: 22%; }  /* Release Date - slightly narrower */
    .table th:nth-child(4) { width: 20%; }  /* Download - slightly narrower */
</style>

<div class="section-block bkg-grey-ultralight" style="padding: 120px 0 30px 0;">
    <!-- Add the test user banner right at the top -->
    <div id="test-user-banner" style="display: none; position: sticky; top: 0; left: 0; width: 100%; background-color: #4CAF50; color: white; padding: 10px 0; text-align: center; z-index: 1000; margin-bottom: 20px;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <span><strong>Development Mode</strong></span>
            <button id="test-user-login" class="button small rounded" style="background-color: white; color: #4CAF50; border: none; padding: 8px 15px; font-size: 14px; cursor: pointer;">Sign in as Test User</button>
        </div>
    </div>
    
    <div class="row">
        <div class="column width-12">
            <div class="centered">
                <h2 class="mb-10">Account</h2>
                <div style="display: flex; justify-content: flex-start; align-items: center; gap: 20px;">
                    <div id="userEmailDisplay" style="color: #666; font-size: 16px;"></div>
                    <div id="signOutContainer" style="display: none;">
                        <a href="#" id="signOutButton" class="button small rounded" style="padding: 8px 15px; font-size: 14px;">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-block" style="padding-top: 20px;">
    <div class="row">
        <div class="column width-8 offset-2">
            <!-- Sign in button (will trigger overlay) -->
            <div id="signinButtonSection" style="display: block; text-align: center; margin-bottom: 40px;">
                <p style="margin-bottom: 20px;">Sign in to access your downloads.</p>
                <button id="accountSignInButton" class="button" onclick="toggleSignIn()">Sign In or Create Account</button>
            </div>

            <!-- Account content section -->
            <div id="accountContent" style="display: none;">
                <div class="box rounded xlarge bkg-white shadow">
                    <div class="box-content">
                        <div class="row">
                            <div class="column width-12">
                                <h3 class="mb-30">Downloads</h3>
                                
                                <div class="mb-50">
                                    <h4>Eagle Eyes Pilot</h4>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Platform</th>
                                                <th>Version</th>
                                                <th>Release Date</th>
                                                <th>Download</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pilotDownloads">
                                            <tr>
                                                <td colspan="4" style="text-align: center;">Loading available downloads...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mb-50">
                                    <h4>Eagle Eyes Scan</h4>
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Platform</th>
                                                <th>Version</th>
                                                <th>Release Date</th>
                                                <th>Download</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scanDownloads">
                                            <tr>
                                                <td colspan="4" style="text-align: center;">Loading available downloads...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <h3 class="mb-30">Licenses</h3>
                                <div id="licensesContent" class="mb-30">
                                {% include license-table.html %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Keep this sign-in overlay in account.html -->
<div id="signin-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; width: 100%; height: 100%;">
        {% include signinwidget-main.html %}
    </div>
</div>

<script>
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
        const signinButtonSection = document.getElementById('signinButtonSection');
        const accountContent = document.getElementById('accountContent');
        const userEmail = document.getElementById('userEmailDisplay');
        const signOutContainer = document.getElementById('signOutContainer');
        const signOutButton = document.getElementById('signOutButton');

        // Listen for auth state changes
        document.addEventListener('authStateChanged', function(e) {
            const user = e.detail.user;
            if (user) {
                // User is signed in
                signinButtonSection.style.display = 'none';
                userEmail.textContent = `Logged in as: ${user.email}`;
                signOutContainer.style.display = 'block';
                
                // Check if the user should be on this page
                checkUserStatus(user);
            } else {
                // User is signed out
                signinButtonSection.style.display = 'block';
                accountContent.style.display = 'none';
                userEmail.textContent = '';
                signOutContainer.style.display = 'none';
            }
        });

        // Initial auth state check
        if (firebase.auth().currentUser) {
            const user = firebase.auth().currentUser;
            signinButtonSection.style.display = 'none';
            userEmail.textContent = `Logged in as: ${user.email}`;
            signOutContainer.style.display = 'block'; // Show the sign-out button
            // Instead of directly showing the account content, check if the user filled the form
            checkUserStatus(user);
        }

        // Handle sign out
        if (signOutButton) {
            signOutButton.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent the default link behavior
                
                firebase.auth().signOut().then(function() {
                    // Sign-out successful - the auth state listener will handle UI updates
                    console.log('User signed out successfully');
                    
                    // Optionally reload the page for a clean state
                    window.location.reload();
                }).catch(function(error) {
                    // An error happened
                    console.error('Error signing out:', error);
                });
            });
        }

        // Keep this event handler for backward compatibility
        document.addEventListener('signInComplete', function(e) {
            const user = e.detail.user;
            toggleSignIn(); // Hide the overlay
        });
    });


    async function fetchAvailableDownloads() {
        try {
            const user = firebase.auth().currentUser;
            
            if (!user) {
                throw new Error('No user logged in');
            }

            console.log('Fetching available downloads...');
            console.log('User email:', user.email);

            // First, get the list of available files from Firebase Storage
            const pilotFiles = await listFilesInDirectory('pilot-releases/current');
            const scanFiles = await listFilesInDirectory('scan_releases/current');

            console.log('Available Pilot files:', pilotFiles);
            console.log('Available Scan files:', scanFiles);

            // Get Pilot downloads
            const pilotDownloads = document.getElementById('pilotDownloads');
            pilotDownloads.innerHTML = '';

            if (pilotFiles.length === 0) {
                pilotDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">No Pilot downloads available.</td></tr>';
            } else {
                for (const file of pilotFiles) {
                    try {
                        // Use the structured data directly
                        const fileName = file.name;
                        const version = file.version || 'Unknown';
                        const platform = file.platform || 'Unknown';
                        const releaseDate = file.releaseDate ? new Date(file.releaseDate).toLocaleDateString() : '2024-03-20';
                        
                        const filePath = `pilot-releases/current/${fileName}`;
                        const downloadUrl = await generateDownloadLink(filePath, user);
                        
                        pilotDownloads.innerHTML += `
                            <tr>
                                <td>${platform}</td>
                                <td>${version}</td>
                                <td>${releaseDate}</td>
                                <td><a href="${downloadUrl}" class="download-link" onclick="trackDownload('pilot', '${fileName}')">Download</a></td>
                            </tr>
                        `;
                    } catch (error) {
                        console.error(`Error processing pilot file ${file}:`, error);
                        pilotDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
                    }
                }
            }

            // Get Scan downloads
            const scanDownloads = document.getElementById('scanDownloads');
            scanDownloads.innerHTML = '';

            if (scanFiles.length === 0) {
                scanDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">No Scan downloads available.</td></tr>';
            } else {
                for (const file of scanFiles) {
                    try {
                        // Use the structured data directly
                        const fileName = file.name;
                        const version = file.version || 'Unknown';
                        const platform = file.platform || 'Unknown';
                        const releaseDate = file.releaseDate ? new Date(file.releaseDate).toLocaleDateString() : '2024-03-20';
                        
                        const filePath = `scan_releases/current/${fileName}`;
                        const downloadUrl = await generateDownloadLink(filePath, user);
                        
                        scanDownloads.innerHTML += `
                            <tr>
                                <td>${platform}</td>
                                <td>${version}</td>
                                <td>${releaseDate}</td>
                                <td><a href="${downloadUrl}" class="download-link" onclick="trackDownload('scan', '${fileName}')">Download</a></td>
                            </tr>
                        `;
                    } catch (error) {
                        console.error(`Error processing scan file ${file}:`, error);
                        scanDownloads.innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
                    }
                }
            }
        } catch (error) {
            console.error('Error in fetchAvailableDownloads:', error);
            document.getElementById('pilotDownloads').innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
            document.getElementById('scanDownloads').innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading downloads. Please try again later.</td></tr>';
        }
    }

    async function listFilesInDirectory(directory) {
        const user = firebase.auth().currentUser;
        
        if (!user) {
            console.error('No user logged in when trying to list files');
            return [];
        }

        try {
            const idToken = await user.getIdToken(true);
            console.log(`Fetching files from directory: ${directory}`);
            
            const hostURL = window.getHostUrl();
            console.log('Using host URL:', hostURL);
            
            const response = await fetch(`${hostURL}/list_files?directory=${directory}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to list files:', response.status, response.statusText, errorText);
                throw new Error(`Failed to list files: ${errorText}`);
            }
            
            const data = await response.json();
            console.log(`Files found in ${directory}:`, data.files);
            return data.files || [];
        } catch (error) {
            console.error(`Error listing files in ${directory}:`, error);
            return [];
        }
    }

    async function generateDownloadLink(filePath, user) {
        if (!user) {
            console.error('No user logged in when trying to generate download link');
            throw new Error('No user logged in');
        }

        try {
            const idToken = await user.getIdToken(true);
            console.log('Generating download link for:', filePath);
            
            const hostURL = window.getHostUrl();
            const response = await fetch(`${hostURL}/generate_download_link?filePath=${filePath}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                mode: 'cors',
                credentials: 'same-origin',
                body: JSON.stringify({
                    form_data: {
                        email: user.email,
                        name: user.displayName || '',
                    }
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to generate download link:', response.status, response.statusText, errorText);
                throw new Error(`Failed to generate download link: ${errorText}`);
            }
            
            const data = await response.json();
            console.log('Generated download link:', data.url);
            return data.url;
        } catch (error) {
            console.error('Error generating download link:', error);
            throw error;
        }
    }

    function trackDownload(type, filename) {
        // Track download event
        fathom.trackEvent(`download_${type}`, {
            _value: 0,
            download: filename
        });
        hj('event', `download_${type}`);
    }

    function getIsEmulatorFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('is_emulator') === 'true';
    }

    // Function to trigger the overlay sign-in
    function triggerSignInOverlay() {
        // This should use the same mechanism that the navbar sign-in button uses
        // If there's a global function or event, call it here
        if (typeof showSignInOverlay === 'function') {
            showSignInOverlay();
        } else if (typeof openSignInModal === 'function') {
            openSignInModal();
        } else {
            // Fallback: dispatch a custom event that the navbar might be listening for
            document.dispatchEvent(new CustomEvent('openSignInOverlay'));
            
            // If all else fails, try to click the navbar sign-in button programmatically
            const navSignInButton = document.querySelector('.nav-signin-button, .signin-button, #navSignInButton');
            if (navSignInButton) {
                navSignInButton.click();
            } else {
                console.error('Could not find a way to trigger the sign-in overlay. Please check your implementation.');
            }
        }
    }

    function toggleSignIn() {
        const overlay = document.getElementById('signin-overlay');
        overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
        document.body.style.overflow = overlay.style.display === 'block' ? 'hidden' : 'auto';
    }

    // Optional function to populate account info from form data
    function populateAccountInfo(formData) {
        // Update the page with user-specific information
        if (formData.name) {
            $("#user-name").text(formData.name);
        }
        if (formData.team) {
            $("#user-team").text(formData.team);
        }
        // Add other fields as needed
    }

    // Utility function to preserve the emulator parameter when redirecting
    function getUrlWithEmulatorParam(url) {
        const isEmulator = new URLSearchParams(window.location.search).get('is_emulator') === 'true';
        if (!isEmulator) return url;
        
        // Add the parameter to the URL if it doesn't already have it
        const separator = url.includes('?') ? '&' : '?';
        return url.includes('is_emulator=true') ? url : `${url}${separator}is_emulator=true`;
    }

    // Modify the checkUserStatus function
    function checkUserStatus(user) {
        // Hide account content until check is completed
        $("#accountContent").hide();
        
        const hostURL = window.getHostUrl ? window.getHostUrl() : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
        const fetch_url = hostURL + '/has_user_already_filled_in_form';
        
        user.getIdToken(true).then(function(idToken) {
            $.ajax({
                url: fetch_url,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    console.log("Got reply from has_user_already_filled_in_form:", data);
                    // Parse the response if it's a string
                    const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                    const formOrNull = parsedData.form;
                    
                    if (formOrNull === null) {
                        // User has not filled in the form yet - redirect to create-account.html
                        console.log('User did not fill in form yet, redirecting to create-account');
                        window.location.href = getUrlWithEmulatorParam('create-account.html');
                    } else {
                        // User has filled in the form - show account content and fetch downloads
                        console.log("User already filled in form, showing account page");
                        $("#accountContent").show();
                        fetchAvailableDownloads();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error checking form status:", textStatus, errorThrown);
                    // On error, default to showing the sign-in button
                    $("#signinButtonSection").show();
                }
            });
        }).catch(function(error) {
            console.error("Error getting ID token:", error);
        });
    }

    // Add the test user banner functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we're in emulator mode
        const urlParams = new URLSearchParams(window.location.search);
        const isEmulator = urlParams.get('is_emulator') === 'true';
        
        if (isEmulator) {
            // Show the test user banner
            const banner = document.getElementById('test-user-banner');
            if (banner) banner.style.display = 'block';
            
            // Set up the test user login button
            const testUserBtn = document.getElementById('test-user-login');
            if (testUserBtn) {
                testUserBtn.addEventListener('click', function() {
                    // Test user credentials
                    const testEmail = 'test@example.com';
                    const testPassword = 'password123';
                    
                    // Try to sign in first
                    firebase.auth().signInWithEmailAndPassword(testEmail, testPassword)
                        .then((userCredential) => {
                            console.log('Test user signed in successfully');
                        })
                        .catch((error) => {
                            // If sign-in fails, create the user first
                            if (error.code === 'auth/user-not-found') {
                                console.log('Test user not found, creating account...');
                                firebase.auth().createUserWithEmailAndPassword(testEmail, testPassword)
                                    .then((userCredential) => {
                                        console.log('Test user created and signed in successfully');
                                    })
                                    .catch((createError) => {
                                        console.error('Error creating test user:', createError);
                                    });
                            } else {
                                console.error('Error signing in with test user:', error);
                            }
                        });
                });
            }
        }
    });
</script>

</body>

