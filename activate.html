---
layout: main
title: Set up Eagle Eyes Pilot on this device
permalink: /activate/
---

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="{{ '/shared.js' | relative_url }}"></script>

<style>
    .activation-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 120px 20px 20px 20px;
        text-align: center;
    }
    
    .activation-header {
        background: #e8f4fd;
        border: 1px solid #b3d9f7;
        border-radius: 8px;
        padding: 15px;
        text-align: left;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .activation-header h2 {
        margin: 0 0 15px 0;
        color: #1976d2;
        font-size: 20px;
        font-weight: 600;
        text-align: center;
    }
    
    .activation-header p {
        margin: 5px 0;
        color: #333;
        font-size: 14px;
    }
    
    .login-different-user {
        background: transparent;
        color: #007bff;
        border: 1px solid #007bff;
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }
    
    .login-different-user:hover {
        background: #007bff;
        color: white;
    }
    
    .activation-form {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .activation-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin-bottom: 30px;
    }
    
    .auth-required {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
    }
    
    .auth-required h3 {
        color: #856404;
        margin-bottom: 15px;
    }
    
    .auth-required p {
        color: #856404;
        margin-bottom: 20px;
    }
    
    .sign-in-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    
    .sign-in-button:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }
    
    .code-input-container {
        margin-bottom: 30px;
    }
    
    .code-input {
        width: 100%;
        max-width: 300px;
        padding: 15px;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        letter-spacing: 8px;
        text-transform: uppercase;
        font-family: 'Courier New', monospace;
        margin-bottom: 20px;
    }
    
    .code-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    .code-input.error {
        border-color: #dc3545;
        background-color: #fff5f5;
    }
    
    .activate-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 18px;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
        min-width: 150px;
    }
    
    .activate-button:hover {
        background: #0056b3;
    }
    
    .activate-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .forgot-link {
        display: block;
        margin-top: 30px;
        color: #666;
        font-size: 16px;
        text-decoration: none;
    }
    
    .forgot-link:hover {
        text-decoration: underline;
    }
    
    .error-message {
        color: #dc3545;
        font-size: 16px;
        margin-top: 15px;
        padding: 10px;
        background: #f8d7da;
        border-radius: 4px;
        display: none;
    }
    
    .loading-spinner {
        display: none;
        margin: 20px 0;
    }
    
    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .device-info {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: left;
    }
    
    .device-info h4 {
        color: #1976d2;
        margin-bottom: 10px;
        font-size: 18px;
    }
    
    .device-info p {
        margin: 5px 0;
        color: #333;
    }
    
    .license-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .license-card {
        border: 1px solid #eee;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        background: white;
        cursor: pointer;
    }
    
    .license-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .license-card.selected {
        border-color: #007bff;
        background: #f0f7ff;
    }
    
    .license-header {
        background-color: #e6f2ff;
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        flex-direction: column;
    }
    
    .license-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .license-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .license-badge {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .license-id {
        font-size: 14px;
        color: #666;
        font-family: monospace;
        margin: 0;
    }
    
    .license-body {
        padding: 15px;
    }
    
    .license-detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .license-detail-item {
        font-size: 14px;
    }
    
    .license-detail-label {
        color: #666;
        font-weight: 500;
    }
    
    .license-detail-value {
        color: #333;
        font-weight: 400;
    }
    
    .license-actions {
        text-align: center;
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-top: 15px;
    }
    
    .btn-select-license {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
    }
    
    .btn-select-license:hover {
        background: #0056b3;
    }
    
    .btn-reactivate-license {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
    }
    
    .btn-reactivate-license:hover {
        background: #218838;
    }
    
    .license-card-activated {
        border-color: #28a745;
        background: #f8fff9;
    }
    
    .license-card-activated .license-header {
        background-color: #e6f7e6;
    }
    
    .license-status {
        color: #28a745;
        font-weight: 500;
        font-size: 13px;
        margin: 5px 0 0 0;
        font-style: italic;
    }
    
    .license-card-disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .license-card-disabled:hover {
        transform: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .license-card-disabled .license-header {
        background-color: #f5f5f5;
    }
    
    .license-card-disabled .license-status {
        color: #6c757d;
    }
    
    .btn-select-license.disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }
    
    .btn-select-license.disabled:hover {
        background: #6c757d;
    }
    
    .manual-license-entry {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .manual-license-entry h4 {
        color: #333;
        margin-bottom: 10px;
        font-size: 16px;
    }
    
    .manual-license-entry p {
        color: #6c757d;
        margin-bottom: 15px;
        font-size: 14px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    
    .form-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s ease;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    #device-info-section,
    #license-selection-section,
    #activation-confirmation-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
    }
    
    #license-selection-section .activation-form {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .confirmation-summary {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .confirmation-summary h3 {
        color: #333;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: 600;
    }
    
    .confirmation-details {
        background: white;
        border-radius: 6px;
        padding: 15px;
        border: 1px solid #dee2e6;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }
    
    .detail-value {
        color: #333;
        font-size: 14px;
        font-family: monospace;
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }
    
    .confirmation-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
    }
    
    .confirmation-actions .btn-reactivate-license {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .confirmation-actions .btn-reactivate-license:hover {
        background: #218838;
    }
    
    .key-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
    }
    
    .key-warning p {
        margin: 0;
        font-size: 14px;
        line-height: 1.4;
    }
    
    .key-warning strong {
        color: #d39e00;
    }
    
    .success-message {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        text-align: center;
    }
    
    .error-message-inline {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        text-align: center;
    }

    @media (max-width: 768px) {
        .activation-container {
            padding: 100px 15px 15px 15px;
        }
        
        .activation-header {
            padding: 12px;
        }
        
        .activation-header h2 {
            font-size: 18px;
        }
        
        .activation-header p {
            font-size: 13px;
        }
        
        .activation-form {
            padding: 30px 20px;
        }
        
        .activation-title {
            font-size: 24px;
        }
        
        .code-input {
            font-size: 20px;
            letter-spacing: 4px;
        }
        
        .license-grid {
            grid-template-columns: 1fr;
        }
        
        .license-detail-grid {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .confirmation-actions {
            flex-direction: column;
            align-items: center;
        }
        
        .confirmation-actions button {
            width: 100%;
            max-width: 300px;
        }
        
        .detail-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        .detail-value {
            width: 100%;
            word-break: break-all;
        }
        
        .activation-header div:first-child {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 8px;
        }
        
        .login-different-user {
            align-self: flex-end;
            font-size: 11px;
            padding: 3px 6px;
        }
    }
</style>

<div class="activation-container">
    <!-- Authentication Required Message -->
    <div id="auth-required" class="auth-required" style="display: none;">
        <h3>Sign In Required</h3>
        <p>Please sign in to activate Eagle Eyes Pilot on this device.</p>
        <button id="show-signin" class="sign-in-button" onclick="showSignIn()">Sign In</button>
    </div>

    <!-- Sign In Widget Container -->
    <div id="signin-widget-container" style="display: none;">
        {% include signinwidget-main.html %}
    </div>

    <!-- Main Activation Content -->
    <div id="activation-content" style="display: none;">
        <div class="activation-form">
            <h1 class="activation-title">Set up Eagle Eyes Pilot on this device</h1>
            
            <div class="code-input-container">
                <input type="text" 
                       id="activationCode" 
                       class="code-input" 
                       placeholder="ABC-123" 
                       maxlength="7" 
                       autocomplete="off">
                <div>
                    <button id="activateButton" class="activate-button" onclick="handleActivation()">
                        Start Activation
                    </button>
                </div>
            </div>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Verifying activation code...</p>
            </div>
            
            <div class="error-message" id="errorMessage"></div>

        </div>
    </div>

    <!-- Device Information Display -->
    <div id="device-info-section" style="display: none;">
        <div class="activation-form">
            <h1 class="activation-title">Device Information</h1>
            
            <!-- User info header -->
            <div class="activation-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>Logged in as:</strong> <span id="device-section-user-email"></span></span>
                    <button class="login-different-user" onclick="loginAsDifferentUser()">Login as a different user</button>
                </div>
            </div>
            
            <div class="device-info">
                <h4>Detected Device</h4>
                <p><strong>Device:</strong> <span id="deviceName"></span></p>
                <p><strong>Machine ID:</strong> <span id="machineId"></span></p>
            </div>
            
            <p style="text-align: center; color: #6c757d; margin: 20px 0;">
                Please select a license to use with this device.
            </p>
        </div>
    </div>

    <!-- License Selection Section -->
    <div id="license-selection-section" style="display: none;">
        <div class="activation-form">
            <h1 class="activation-title">Select Your License</h1>
            
            <div class="loading-spinner" id="licensesLoading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading your licenses...</p>
            </div>
            
            <div id="licensesContainer" style="display: none;">
                <h3>Your Active Licenses</h3>
                <div class="license-grid" id="licenseGrid"></div>
                
                <div class="manual-license-entry">
                    <h4>Don't see your license?</h4>
                    <p>If you have a license ID that's not showing above, you can add it to your account:</p>
                    <div class="form-group">
                        <label for="manualLicenseId">License ID:</label>
                        <input type="text" id="manualLicenseId" placeholder="Enter your license ID">
                    </div>
                    <button id="addLicenseBtn" class="btn-select-license">Add License to Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Activation Confirmation Section -->
    <div id="activation-confirmation-section" style="display: none;">
        <div class="activation-form">
            <h1 class="activation-title">Confirm Activation</h1>
            
            <div class="confirmation-summary">
                <h3>Please review the following details:</h3>
                
                <div id="key-warning-message" class="key-warning" style="display: none;">
                    <p><strong>⚠️ Important:</strong> Before proceeding, please be aware that issued keys are specific to a device. The process of issuing a key is irreversible; once a key is issued, it cannot be revoked or transferred to another device.</p>
                </div>
                
                <div class="confirmation-details">
                    <div class="detail-row">
                        <span class="detail-label">Device:</span>
                        <span class="detail-value" id="confirm-device-name"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Machine ID:</span>
                        <span class="detail-value" id="confirm-machine-id"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Selected License:</span>
                        <span class="detail-value" id="confirm-license-name"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">License ID:</span>
                        <span class="detail-value" id="confirm-license-id"></span>
                    </div>
                    <div class="detail-row" id="current-devices-row" style="display: none;">
                        <span class="detail-label">Current available devices on license:</span>
                        <span class="detail-value" id="confirm-current-devices"></span>
                    </div>
                    <div class="detail-row" id="after-activation-devices-row" style="display: none;">
                        <span class="detail-label">Available devices after activation:</span>
                        <span class="detail-value" id="confirm-after-activation-devices"></span>
                    </div>
                </div>
            </div>
            
            <div class="confirmation-actions">
                <button id="confirmActivationBtn" class="activate-button" onclick="confirmActivation()">
                    Activate device on this license
                </button>
                <button id="backToLicensesBtn" class="btn-secondary" onclick="cancelActivation()">
                    Back to licenses
                </button>
            </div>
            
            <div class="loading-spinner" id="activationLoading" style="display: none;">
                <div class="spinner"></div>
                <p>Activating your device...</p>
            </div>
            
            <div id="activationResult" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
    var useLocalFirebaseEmulator = getIsEmulatorFromURL();
    var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
    
    // Global variable to store URL activation code
    let urlActivationCode = null;
    
    // Global variable to store session ID for backend requests
    let globalSessionId = null;
    
    function getUrlActivationCode() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Check for various parameter names (in order of preference)
        const paramNames = ['session_id', 'code', 'nonce', 'activation_code'];
        
        for (const paramName of paramNames) {
            const paramValue = urlParams.get(paramName);
            if (paramValue) {
                // Clean and validate the parameter value
                const cleanValue = paramValue.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                // Validate format (should be exactly 6 alphanumeric characters)
                if (cleanValue.length === 6 && /^[A-Z0-9]{6}$/.test(cleanValue)) {
                    console.log(`Found valid activation code in URL parameter '${paramName}':`, cleanValue);
                    return cleanValue;
                } else {
                    console.warn(`Invalid activation code format in URL parameter '${paramName}':`, paramValue, 'Expected 6 alphanumeric characters');
                    
                    // Show warning about invalid URL parameter
                    if (cleanValue.length > 0) {
                        setTimeout(() => {
                            showUrlParameterWarning(paramName, paramValue);
                        }, 1000);
                    }
                }
            }
        }
        
        return null;
    }
    
    function showUrlParameterWarning(paramName, paramValue) {
        const warningHtml = `
            <div id="url-param-warning" style="background-color: #ffeaa7; border: 1px solid #fdcb6e; color: #2d3436; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <strong>⚠️ Invalid URL Parameter</strong><br>
                The activation code in URL parameter '${paramName}' is invalid: <code>${paramValue}</code><br>
                <small>Expected format: 6 letters and numbers (e.g., ABC123)</small>
                <button onclick="$('#url-param-warning').remove()" style="margin-left: 10px; background: #fdcb6e; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Dismiss</button>
            </div>
        `;
        $('.activation-container').prepend(warningHtml);
    }
    
    function clearUrlParameters() {
        // Clear URL parameters after successful activation
        if (window.history && window.history.replaceState) {
            const url = new URL(window.location);
            url.search = '';
            window.history.replaceState({}, document.title, url.pathname);
            console.log('URL parameters cleared after successful activation');
        }
    }
    
    $(document).ready(function() {
        // Check for URL activation code on page load
        urlActivationCode = getUrlActivationCode();
        
        // Store session ID globally for backend requests
        if (urlActivationCode) {
            globalSessionId = urlActivationCode;
        }
        
        // Show emulator banner if in emulator mode
        if (useLocalFirebaseEmulator) {
            const emulatorBanner = $(`
                <div style="background-color: #ff9800; color: black; padding: 10px; text-align: center; font-weight: bold; margin-bottom: 20px;">
                    🧪 Emulator Mode: Using local Firebase emulator database
                </div>
            `);
            $('.activation-container').prepend(emulatorBanner);
        }
        
        // Check authentication state
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                showActivationContent();
            } else {
                showAuthRequired();
            }
        });
        
        // Listen for sign-in completion
        document.addEventListener('signInComplete', function(event) {
            showActivationContent();
        });
        
        // Auto-format input as user types
        $('#activationCode').on('input', function() {
            let value = $(this).val().toUpperCase().replace(/[^A-Z0-9-]/g, '');
            
            // Remove existing dashes and format as ABC-123
            let cleanValue = value.replace(/-/g, '');
            if (cleanValue.length > 3) {
                value = cleanValue.substring(0, 3) + '-' + cleanValue.substring(3, 6);
            } else {
                value = cleanValue;
            }
            
            $(this).val(value);
            $(this).removeClass('error');
            $('#errorMessage').hide();
        });
        
        // Handle Enter key
        $('#activationCode').on('keypress', function(e) {
            if (e.which === 13) {
                handleActivation();
            }
        });
        
        // Manual license addition
        $(document).on('click', '#addLicenseBtn', function() {
            const licenseId = $('#manualLicenseId').val().trim();
            if (!licenseId) {
                // Show error message inline instead of alert
                const errorMsg = $('<div class="error-message-inline" style="margin-top: 10px;">Please enter a license ID</div>');
                $('#addLicenseBtn').after(errorMsg);
                setTimeout(() => errorMsg.fadeOut(), 3000);
                return;
            }
            
            // Remove any previous messages
            $('#addLicenseBtn').siblings('.success-message, .error-message-inline').remove();
            
            addLicenseToAccount(licenseId);
        });
    });
    
    function showAuthRequired() {
        // Update auth required message based on whether we have URL parameter
        if (urlActivationCode) {
            const displayCode = urlActivationCode.substring(0, 3) + '-' + urlActivationCode.substring(3);
            $('#auth-required h3').text('Sign In Required');
            $('#auth-required p').html(`Please sign in to activate Eagle Eyes Pilot with code <strong>${displayCode}</strong>.`);
        } else {
            $('#auth-required h3').text('Sign In Required');
            $('#auth-required p').text('Please sign in to activate Eagle Eyes Pilot on this device.');
        }
        
        $('#auth-required').show();
        $('#signin-widget-container').hide();
        $('#activation-content').hide();
    }
    
    function showSignIn() {
        $('#auth-required').hide();
        $('#signin-widget-container').show();
        $('#activation-content').hide();
    }
    
    function showActivationContent() {
        $('#auth-required').hide();
        $('#signin-widget-container').hide();
        
        // Check if we have a URL activation code
        if (urlActivationCode) {
            // Auto-activate with URL parameter
            autoActivateWithUrlCode(urlActivationCode);
        } else {
            // Show manual input form
            $('#activation-content').show();
            
            // Update title for manual activation
            $('#activation-content .activation-title').text('Set up Eagle Eyes Pilot on this device');
            
            // Focus on input field when showing activation content
            setTimeout(() => {
                $('#activationCode').focus();
            }, 100);
        }
    }
    
    function autoActivateWithUrlCode(activationCode) {
        console.log('Auto-activating with URL code:', activationCode);
        
        // Format code for display (ABC-123)
        const displayCode = activationCode.substring(0, 3) + '-' + activationCode.substring(3);
        
        // Show a different UI for auto-activation
        $('#activation-content').hide();
        showAutoActivationProgress(displayCode);
        
        // Call the activation API directly
        getActivationRequest(activationCode)
            .then(function(result) {
                console.log('Auto-activation successful:', result);
                
                // Clear URL parameters to prevent re-activation on refresh
                clearUrlParameters();
                
                // Show device information and proceed to license selection
                showDeviceInfo(result.device_identifier, result.machine_id);
                showLicenseSelection();
            })
            .catch(function(error) {
                console.error('Auto-activation failed:', error);
                
                // Show error and fall back to manual input
                showAutoActivationError(error.message, displayCode);
            });
    }
    
    function showAutoActivationProgress(displayCode) {
        const user = firebase.auth().currentUser;
        const userEmail = user ? user.email : 'Unknown';
        
        // Create header with activation info at the top
        const headerHtml = `
            <div id="activation-header" class="activation-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span><strong>Logged in as:</strong> ${userEmail}</span>
                    <button class="login-different-user" onclick="loginAsDifferentUser()">Login as a different user</button>
                </div>
                <p><strong>Using activation code:</strong> ${displayCode}</p>
                <div id="device-info-placeholder" style="display: none;">
                    <p><strong>Device:</strong> <span id="temp-device-name"></span></p>
                    <p><strong>Machine ID:</strong> <span id="temp-machine-id"></span></p>
                </div>
            </div>
        `;
        
        // Create progress content below header
        const progressHtml = `
            <div id="auto-activation-progress" class="activation-form">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Verifying activation code...</p>
                </div>
            </div>
        `;
        
        // Add header first, then progress content to container
        $('.activation-container').prepend(headerHtml).append(progressHtml);
    }
    
    function showAutoActivationError(errorMessage, displayCode) {
        $('#auto-activation-progress').html(`
            <div class="activation-form">
                <h1 class="activation-title">Activation Failed</h1>
                <p style="color: #6c757d; margin-bottom: 20px;">Could not activate with code: <strong>${displayCode}</strong></p>
                
                <div class="error-message" style="display: block; margin-bottom: 20px;">
                    ${errorMessage}
                </div>
                
                <button class="activate-button" onclick="fallbackToManualInput('${displayCode}')">
                    Enter Code Manually
                </button>
            </div>
        `);
    }
    
    function fallbackToManualInput(displayCode) {
        // Hide auto-activation progress and show manual input
        $('#auto-activation-progress').remove();
        $('#activation-content').show();
        
        // Pre-fill the input with the failed code
        $('#activationCode').val(displayCode);
        $('#activationCode').focus();
    }
    
    function handleActivation() {
        const code = $('#activationCode').val().trim();
        
        // Validate input
        if (!code) {
            showError('Please enter your 6-digit activation code');
            return;
        }
        
        if (code.length !== 7) {
            showError('Activation code must be in format ABC-123');
            return;
        }
        
        if (!/^[A-Z0-9]{3}-[A-Z0-9]{3}$/.test(code)) {
            showError('Activation code must be in format ABC-123 (letters and numbers only)');
            return;
        }
        
        // Show loading
        $('#loadingSpinner').show();
        $('#activateButton').prop('disabled', true);
        $('#errorMessage').hide();
        
        // Call API (remove dash for backend)
        const sessionId = code.replace('-', '');
        
        // Store session ID globally for later use in license activation
        globalSessionId = sessionId;
        
        getActivationRequest(sessionId)
            .then(function(result) {
                console.log('Activation successful:', result);
                
                // Show device information and proceed to license selection
                showDeviceInfo(result.device_identifier, result.machine_id);
                showLicenseSelection();
            })
            .catch(function(error) {
                console.error('Activation failed:', error);
                showError(error.message);
                $('#loadingSpinner').hide();
                $('#activateButton').prop('disabled', false);
                $('#activationCode').addClass('error');
            });
    }
    
    async function getActivationRequest(sessionId) {
        try {
            // Get authentication token
            const user = firebase.auth().currentUser;
            if (!user) {
                throw new Error('Authentication required');
            }
            
            const idToken = await user.getIdToken(true);
            
            // Make request using GET method with session_id parameter
            const response = await fetch(`${hostURL}/get_activation_request?session_id=${encodeURIComponent(sessionId.toUpperCase())}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                return {
                    success: true,
                    device_identifier: data.device_identifier,
                    machine_id: data.machine_id
                };
            } else {
                // Handle specific error cases
                switch (response.status) {
                    case 404:
                        throw new Error('Activation code not found. Please check the code and try again.');
                    case 410:
                        throw new Error('Activation code has expired. Please request a new code.');
                    case 429:
                        throw new Error('Too many requests. Please wait a minute before trying again.');
                    case 401:
                        throw new Error('Authentication required. Please sign in and try again.');
                    default:
                        throw new Error(data.error || 'Failed to retrieve activation request');
                }
            }
        } catch (error) {
            console.error('Error retrieving activation request:', error);
            throw error;
        }
    }
    
    function showDeviceInfo(deviceIdentifier, machineId) {
        // Populate device information in both locations
        $('#deviceName').text(deviceIdentifier);
        $('#machineId').text(machineId);
        
        // Update the persistent header with device info if it exists
        if ($('#activation-header').length > 0) {
            $('#temp-device-name').text(deviceIdentifier);
            $('#temp-machine-id').text(machineId);
            $('#device-info-placeholder').show();
            
            // Update the loading message
            $('#auto-activation-progress .loading-spinner p').text('Device detected. Loading your licenses...');
        } else {
            // Get current user and populate user info in device section
            const user = firebase.auth().currentUser;
            const userEmail = user ? user.email : 'Unknown';
            $('#device-section-user-email').text(userEmail);
            
            // Hide activation form and show device info section
            $('#activation-content').hide();
            $('#device-info-section').show();
            
            // Scroll to device info section
            setTimeout(() => {
                $('#device-info-section')[0].scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
        
        // Hide loading spinner
        $('#loadingSpinner').hide();
        $('#activateButton').prop('disabled', false);
    }
    
    function showLicenseSelection() {
        // If we have the persistent header, just update it and show licenses below
        if ($('#activation-header').length > 0) {
            // Hide the loading spinner
            $('#auto-activation-progress .loading-spinner').hide();
            
            // Show license selection section but keep the header
            $('#license-selection-section').show();
            
            // Load user licenses
            loadUserLicenses();
        } else {
            // Standard flow - show license selection section
            $('#license-selection-section').show();
            
            // Load user licenses
            loadUserLicenses();
            
            // Scroll to license selection section
            setTimeout(() => {
                $('#license-selection-section')[0].scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
    }
    
    // Global variables for license management
    let userLicenses = [];
    let selectedLicense = null;
    
    function loadUserLicenses() {
        console.log('loadUserLicenses called');
        $('#licensesLoading').show();
        $('#licensesContainer').hide();
        
        const globalUser = firebase.auth().currentUser;
        if (!globalUser) {
            console.error('No user authenticated in loadUserLicenses');
            $('#licensesLoading').hide();
            $('#licensesContainer').show();
            $('#licenseGrid').html('<p>Please sign in to view your licenses.</p>');
            return;
        }
        
        console.log('User authenticated, getting ID token for:', globalUser.email);
        
        globalUser.getIdToken(true).then(function(idToken) {
            var fetch_url = hostURL + '/check_available_licenses_and_tokens?machine_id=' + $('#machineId').text();
            $.ajax({
                url: fetch_url,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(response) {
                    console.log('Raw licenses response:', response);
                    console.log('Response type:', typeof response);
                    
                    try {
                        let licenseData;
                        if (typeof response === 'string') {
                            licenseData = JSON.parse(response);
                        } else {
                            licenseData = response;
                        }
                        
                        console.log('Parsed licenses data:', licenseData);
                        
                        if (licenseData && licenseData.licenses_and_dispensed) {
                            // Get existing keys for this machine for the current user only
                            const existingKeysForMachine = [];
                            if (licenseData.tokens_and_codes) {
                                const currentUserEmail = globalUser?.email;
                                for (const tokenId in licenseData.tokens_and_codes) {
                                    const tokenAndCode = licenseData.tokens_and_codes[tokenId];
                                    // Only include tokens that belong to the current user
                                    if (tokenAndCode && tokenAndCode.token && tokenAndCode.token.email === currentUserEmail) {
                                        existingKeysForMachine.push(tokenAndCode.token.license_id);
                                    }
                                }
                            }
                            
                            // Transform licenses_and_dispensed object to array format
                            userLicenses = [];
                            for (const licenseId in licenseData.licenses_and_dispensed) {
                                const licenseInfo = licenseData.licenses_and_dispensed[licenseId];
                                if (licenseInfo && licenseInfo.license) {
                                    const license = licenseInfo.license;
                                    // Add license_id and calculate remaining tokens
                                    license.license_id = licenseId;
                                    const totalTokens = license.n_tokens || 0;
                                    const dispensedTokens = licenseInfo.n_tokens_dispensed || 0;
                                    license.remaining_keys = Math.max(0, totalTokens - dispensedTokens);
                                    
                                    // Check if this license already has a key for this machine
                                    license.has_existing_key = existingKeysForMachine.includes(licenseId);
                                    
                                    // Include all active licenses (even if no remaining keys)
                                    // This allows users to see all their licenses, including those that are fully utilized
                                    userLicenses.push(license);
                                }
                            }
                            console.log('Loaded', userLicenses.length, 'licenses for user');
                        } else {
                            console.log('No licenses_and_dispensed found in response');
                            userLicenses = [];
                        }
                        
                        $('#licensesLoading').hide();
                        $('#licensesContainer').show();
                        displayLicenses();
                        
                    } catch (parseError) {
                        console.error('Error parsing licenses response:', parseError);
                        $('#licensesLoading').hide();
                        $('#licensesContainer').show();
                        $('#licenseGrid').html('<p>Error parsing license data. Please try again.</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading licenses:', error);
                    $('#licensesLoading').hide();
                    $('#licensesContainer').show();
                    $('#licenseGrid').html('<p>Error loading licenses. Please try again.</p>');
                }
            });
        });
    }
    
    function displayLicenses() {
        console.log('displayLicenses called with:', userLicenses);
        const licenseGrid = $('#licenseGrid');
        licenseGrid.empty();
        
        if (userLicenses.length === 0) {
            console.log('No licenses to display');
            licenseGrid.html('<p>No active licenses found. Please add a license using the form below.</p>');
            return;
        }
        
        console.log('Creating license cards for', userLicenses.length, 'licenses');
        
        userLicenses.forEach(function(license) {
            const expiryDate = license.expiry_timestamp ? 
                new Date(license.expiry_timestamp * 1000).toLocaleDateString() : 
                'No expiry';
            
            // Determine if this license already has a key for this device
            const hasExistingKey = license.has_existing_key;
            const hasAvailableKeys = license.remaining_keys > 0;
            
            // Determine button and status based on license state
            let buttonClass, buttonText, statusText, cardClass;
            
            if (hasExistingKey) {
                buttonClass = 'btn-reactivate-license';
                buttonText = 'Reactivate your device using this license';
                statusText = 'License already activated for this device';
                cardClass = 'license-card license-card-activated';
            } else if (!hasAvailableKeys) {
                buttonClass = 'btn-select-license disabled';
                buttonText = 'No Devices Available';
                statusText = 'All devices have been used for this license';
                cardClass = 'license-card license-card-disabled';
            } else {
                buttonClass = 'btn-select-license';
                buttonText = 'Use This License for Setup';
                statusText = '';
                cardClass = 'license-card';
            }
            
            const onClickHandler = (!hasExistingKey && !hasAvailableKeys) ? '' : `onclick="selectLicense('${license.license_id}')"`;
            const licenseCard = $(`
                <div class="${cardClass}" data-license-id="${license.license_id}" data-has-existing-key="${hasExistingKey}" ${onClickHandler}>
                    <div class="license-header">
                        <div class="license-title-row">
                            <h3 class="license-title">${license.license_name || 'Eagle Eyes License'}</h3>
                        </div>
                        <p class="license-id">License ID: ${license.license_id}</p>
                        ${statusText ? `<p class="license-status">${statusText}</p>` : ''}
                    </div>
                    <div class="license-body">
                        <div class="license-detail-grid">
                            <div class="license-detail-item">
                                <div class="license-detail-label">Expires: <span class="license-detail-value">${expiryDate}</span></div>
                            </div>
                            <div class="license-detail-item">
                                <div class="license-detail-label">Remaining Devices: <span class="license-detail-value">${license.remaining_keys || 'Unlimited'}</span></div>
                            </div>
                        </div>
                        <div class="license-actions">
                            <button class="${buttonClass}" ${(!hasExistingKey && !hasAvailableKeys) ? 'disabled' : `onclick="event.stopPropagation(); selectLicense('${license.license_id}')"`}>
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            licenseGrid.append(licenseCard);
        });
    }
    
    function selectLicense(licenseId) {
        $('.license-card').removeClass('selected');
        $(`.license-card[data-license-id="${licenseId}"]`).addClass('selected');
        selectedLicense = licenseId;
        
        console.log('License selected:', licenseId);
        
        // Show activation confirmation instead of immediate activation
        showActivationConfirmation();
    }
    
    function showActivationConfirmation() {
        // Get device information
        const deviceName = $('#deviceName').text();
        const machineId = $('#machineId').text();
        
        // Get selected license information
        const selectedLicenseCard = $(`.license-card[data-license-id="${selectedLicense}"]`);
        const licenseName = selectedLicenseCard.find('.license-title').text();
        const hasExistingKey = selectedLicenseCard.attr('data-has-existing-key') === 'true';
        
        // Find the selected license object to get device counts
        const selectedLicenseObj = userLicenses.find(license => license.license_id === selectedLicense);
        
        // Populate confirmation details
        $('#confirm-device-name').text(deviceName);
        $('#confirm-machine-id').text(machineId);
        $('#confirm-license-name').text(licenseName);
        $('#confirm-license-id').text(selectedLicense);
        
        // Show/hide device count information based on whether it's a new activation
        if (!hasExistingKey && selectedLicenseObj) {
            const currentDevices = selectedLicenseObj.remaining_keys || 0;
            const afterActivationDevices = Math.max(0, currentDevices - 1);
            
            $('#confirm-current-devices').text(currentDevices);
            $('#confirm-after-activation-devices').text(afterActivationDevices);
            $('#current-devices-row').show();
            $('#after-activation-devices-row').show();
        } else {
            $('#current-devices-row').hide();
            $('#after-activation-devices-row').hide();
        }
        
        // Update confirmation text and button based on whether it's a re-activation
        if (hasExistingKey) {
            $('#activation-confirmation-section .activation-title').text('Confirm Re-activation');
            $('#activation-confirmation-section .confirmation-summary h3').text('Re-activating this license on your device will not impact the available devices on this license. Continue to re-sync this license to your device.');
            $('#confirmActivationBtn').text('Re-sync activation to device').removeClass('activate-button').addClass('btn-reactivate-license');
            $('#key-warning-message').hide();
        } else {
            $('#activation-confirmation-section .activation-title').text('Confirm Activation');
            $('#activation-confirmation-section .confirmation-summary h3').text('Please review the following details:');
            $('#confirmActivationBtn').text('Activate device on this license').removeClass('btn-reactivate-license').addClass('activate-button');
            $('#key-warning-message').show();
        }
        
        // Reset confirmation section state
        $('#activationLoading').hide();
        $('#activationResult').hide();
        $('#confirmActivationBtn').prop('disabled', false);
        $('#backToLicensesBtn').prop('disabled', false);
        
        // Show confirmation section
        $('#activation-confirmation-section').show();
        
        // Scroll to confirmation section
        setTimeout(() => {
            $('#activation-confirmation-section')[0].scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }
    
    function cancelActivation() {
        // Hide confirmation section
        $('#activation-confirmation-section').hide();
        
        // Clear license selection
        $('.license-card').removeClass('selected');
        selectedLicense = null;
        
        // Scroll back to license selection
        setTimeout(() => {
            $('#license-selection-section')[0].scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }
    
    function addLicenseToAccount(licenseId) {
        const globalUser = firebase.auth().currentUser;
        if (!globalUser) {
            console.error('No user authenticated');
            return;
        }
        
        $('#addLicenseBtn').text('Adding...').prop('disabled', true);
        
        // Remove any previous messages
        $('#addLicenseBtn').siblings('.success-message, .error-message-inline').remove();
        
        globalUser.getIdToken(true).then(function(idToken) {
            var fetch_url = hostURL + '/check_available_licenses_and_tokens?machine_id=' + $('#machineId').text() + '&license_id=' + licenseId;
            $.ajax({
                url: fetch_url,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(response) {
                    console.log('Add license response:', response);
                    console.log('Response type:', typeof response);
                    
                    // Parse response if needed
                    let responseData;
                    try {
                        if (typeof response === 'string') {
                            responseData = JSON.parse(response);
                        } else {
                            responseData = response;
                        }
                        console.log('Parsed add license response:', responseData);
                    } catch (e) {
                        console.error('Error parsing add license response:', e);
                    }
                    
                    $('#manualLicenseId').val('');
                    $('#addLicenseBtn').text('Add License to Account').prop('disabled', false);
                    
                    // Process the response directly instead of reloading (like get-license.js does)
                    console.log('Processing add license response directly...');
                    processLicenseResponse(responseData);
                    
                    // Show success message inline instead of alert
                    const successMsg = $('<div class="success-message" style="margin-top: 10px;">License added successfully to your account!</div>');
                    $('#addLicenseBtn').after(successMsg);
                    setTimeout(() => successMsg.fadeOut(), 3000);
                },
                error: function(xhr, status, error) {
                    console.error('Error adding license:', error);
                    $('#addLicenseBtn').text('Add License to Account').prop('disabled', false);
                    
                    let errorMessage = 'Failed to add license. ';
                    if (xhr.status === 500 && xhr.responseText && xhr.responseText.includes("'NoneType' object has no attribute 'expiry_timestamp'")) {
                        errorMessage = `License ID "${licenseId}" was not found in our database. Please check that you entered the license ID correctly.`;
                    } else if (xhr.responseText) {
                        errorMessage += xhr.responseText;
                    } else {
                        errorMessage += 'Please check the license ID and try again.';
                    }
                    
                    // Show error message inline instead of alert
                    const errorMsg = $(`<div class="error-message-inline" style="margin-top: 10px;">${errorMessage}</div>`);
                    $('#addLicenseBtn').after(errorMsg);
                    setTimeout(() => errorMsg.fadeOut(), 5000);
                }
            });
        });
    }
    
    function confirmActivation() {
        // Get selected license information to determine if it's a re-activation
        const selectedLicenseCard = $(`.license-card[data-license-id="${selectedLicense}"]`);
        const hasExistingKey = selectedLicenseCard.attr('data-has-existing-key') === 'true';
        const deviceName = $('#deviceName').text();
        const machineId = $('#machineId').text();
        
        // Show loading state with different text for re-activation
        $('#activationLoading').show();
        if (hasExistingKey) {
            $('#confirmActivationBtn').prop('disabled', true).text('Re-syncing...');
            $('#activationLoading .loading-spinner p').text('Re-syncing your device...');
        } else {
            $('#confirmActivationBtn').prop('disabled', true).text('Activating...');
            $('#activationLoading .loading-spinner p').text('Activating your device...');
        }
        $('#backToLicensesBtn').prop('disabled', true);
        $('#activationResult').hide();
        
        // Make the actual backend API call to activate the device
        const user = firebase.auth().currentUser;
        if (!user) {
            showActivationError('Authentication required. Please sign in and try again.', hasExistingKey);
            return;
        }
        
        user.getIdToken(true).then(function(idToken) {
            // Build the URL with session ID if available
            let fetch_url = hostURL + '/request_token_from_license?machine_id=' + machineId + '&license_id=' + selectedLicense;
            if (globalSessionId) {
                fetch_url += '&session_id=' + encodeURIComponent(globalSessionId);
            }
            
            console.log('Requesting activation for license:', selectedLicense, 'machine:', machineId, 'session:', globalSessionId || 'none');
            
            $.ajax({
                url: fetch_url,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(response) {
                    handleActivationSuccess(response, hasExistingKey, deviceName);
                },
                error: function(xhr, status, error) {
                    handleActivationError(xhr, status, error, hasExistingKey);
                }
            });
        }).catch(function(error) {
            console.error('Error getting ID token:', error);
            showActivationError('Authentication error. Please try again.', hasExistingKey);
        });
    }
    
    function handleActivationSuccess(response, hasExistingKey, deviceName) {
        try {
            console.log('Activation API response:', response);
            
            // Parse the response (similar to onNewKeyReceived in get-license.js)
            let tokenAndCode;
            if (typeof response === 'string') {
                tokenAndCode = JSON.parse(response);
            } else {
                tokenAndCode = response;
            }
            
            const licenseKey = tokenAndCode.code;
            const token = tokenAndCode.token;
            
            console.log('Activation successful, license key generated:', licenseKey ? licenseKey.substring(0, 10) + '...' : 'undefined');
            
            $('#activationLoading').hide();
            
            let successHtml;
            if (hasExistingKey) {
                successHtml = `
                    <div class="success-message">
                        <h3>✅ Re-sync Completed Successfully!</h3>
                        <p>Your device "${deviceName}" has been re-synchronized with Eagle Eyes Pilot.</p>
                        <p><strong>Next step:</strong> Go back to your device and verify that the activation is successful. This can take a couple of seconds.</p>
                        <button class="btn-reactivate-license" onclick="window.location.href='{{ '/account/' | relative_url }}'">
                            Go to Account Page
                        </button>
                    </div>
                `;
            } else {
                successHtml = `
                    <div class="success-message">
                        <h3>✅ Activation Completed Successfully!</h3>
                        <p>Your device "${deviceName}" is now activated with Eagle Eyes Pilot.</p>
                        <p><strong>Next step:</strong> Go back to your device and verify that the activation is successful. This can take a couple of seconds.</p>
                        <button class="activate-button" onclick="window.location.href='{{ '/account/' | relative_url }}'">
                            Go to Account Page
                        </button>
                    </div>
                `;
            }
            
            $('#activationResult').html(successHtml).show();
            
            // Scroll to result
            setTimeout(() => {
                $('#activationResult')[0].scrollIntoView({ behavior: 'smooth' });
            }, 100);
            
        } catch (parseError) {
            console.error('Error parsing activation response:', parseError);
            showActivationError('Invalid response from server. Please try again.', hasExistingKey);
        }
    }
    
    function handleActivationError(xhr, status, error, hasExistingKey) {
        console.error('Activation API error:', {xhr, status, error});
        
        let errorMessage = 'Failed to activate device. ';
        
        if (xhr.status === 500) {
            // Check for specific error patterns similar to get-license.js
            const responseText = xhr.responseText || '';
            if (responseText.includes("'NoneType' object has no attribute")) {
                errorMessage = 'License not found or invalid. Please check your license and try again.';
            } else if (responseText.includes('insufficient')) {
                errorMessage = 'No available device slots remaining on this license.';
            } else {
                errorMessage += 'Server error occurred. Please try again or contact support.';
            }
        } else if (xhr.status === 401) {
            errorMessage = 'Authentication failed. Please sign out and sign in again.';
        } else if (xhr.status === 429) {
            errorMessage = 'Too many requests. Please wait a moment and try again.';
        } else if (!xhr.status) {
            errorMessage = 'Network error. Please check your internet connection and try again.';
        } else {
            errorMessage += `Error ${xhr.status}: ${xhr.responseText || error}`;
        }
        
        showActivationError(errorMessage, hasExistingKey);
    }
    
    function showActivationError(message, hasExistingKey) {
        $('#activationLoading').hide();
        const buttonText = hasExistingKey ? 'Re-sync activation to device' : 'Activate device on this license';
        $('#confirmActivationBtn').prop('disabled', false).text(buttonText);
        $('#backToLicensesBtn').prop('disabled', false);
        
        const actionType = hasExistingKey ? 're-syncing' : 'activating';
        const errorHtml = `
            <div class="error-message-inline">
                <h3>❌ ${hasExistingKey ? 'Re-sync' : 'Activation'} Failed</h3>
                <p>There was an error ${actionType} your device.</p>
                <p><strong>Error:</strong> ${message}</p>
                <p>Please try again or contact support if the problem persists.</p>
            </div>
        `;
        
        $('#activationResult').html(errorHtml).show();
        
        // Scroll to result
        setTimeout(() => {
            $('#activationResult')[0].scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }
    
    function loginAsDifferentUser() {
        // Sign out current user
        firebase.auth().signOut().then(function() {
            console.log('User signed out successfully');
            
            // Clear any stored activation data
            urlActivationCode = null;
            globalSessionId = null;
            selectedLicense = null;
            userLicenses = [];
            
            // Hide all sections except auth required
            $('#activation-header').remove();
            $('#auto-activation-progress').remove();
            $('#device-info-section').hide();
            $('#license-selection-section').hide();
            $('#activation-confirmation-section').hide();
            $('#activation-content').hide();
            
            // Show auth required message
            showAuthRequired();
            
        }).catch(function(error) {
            console.error('Error signing out:', error);
            showError('Error signing out. Please try again.');
        });
    }
    
    function showError(message) {
        $('#errorMessage').text(message).show();
    }
    
    function processLicenseResponse(responseData) {
        console.log('Processing license response:', responseData);
        
        // Get current user for filtering tokens
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
            console.error('No user authenticated in processLicenseResponse');
            return;
        }
        
        // Parse response if needed (similar to get-license.js)
        let licenseData;
        try {
            if (typeof responseData === 'string') {
                licenseData = JSON.parse(responseData);
            } else {
                licenseData = responseData;
            }
        } catch (e) {
            console.error('Error parsing license response:', e);
            return;
        }
        
        if (licenseData && licenseData.licenses_and_dispensed) {
            // Get existing keys for this machine for the current user only
            const existingKeysForMachine = [];
            if (licenseData.tokens_and_codes) {
                const currentUserEmail = currentUser.email;
                for (const tokenId in licenseData.tokens_and_codes) {
                    const tokenAndCode = licenseData.tokens_and_codes[tokenId];
                    // Only include tokens that belong to the current user
                    if (tokenAndCode && tokenAndCode.token && tokenAndCode.token.email === currentUserEmail) {
                        existingKeysForMachine.push(tokenAndCode.token.license_id);
                    }
                }
            }
            
            // Transform licenses_and_dispensed object to array format (same as loadUserLicenses)
            userLicenses = [];
            console.log('Processing licenses_and_dispensed from add response:', licenseData.licenses_and_dispensed);
            
            for (const licenseId in licenseData.licenses_and_dispensed) {
                console.log('Processing license ID from add response:', licenseId);
                const licenseInfo = licenseData.licenses_and_dispensed[licenseId];
                
                if (licenseInfo && licenseInfo.license) {
                    const license = licenseInfo.license;
                    // Add license_id and calculate remaining tokens
                    license.license_id = licenseId;
                    const totalTokens = license.n_tokens || 0;
                    const dispensedTokens = licenseInfo.n_tokens_dispensed || 0;
                    license.remaining_keys = Math.max(0, totalTokens - dispensedTokens);
                    
                    // Check if this license already has a key for this machine
                    license.has_existing_key = existingKeysForMachine.includes(licenseId);
                    
                    console.log('Adding license to array from add response:', {
                        id: licenseId,
                        name: license.license_name,
                        remaining_keys: license.remaining_keys,
                        has_existing_key: license.has_existing_key
                    });
                    
                    userLicenses.push(license);
                }
            }
            
            console.log('Final userLicenses array from add response:', userLicenses);
            
            // Show the licenses container and display the licenses
            $('#licensesLoading').hide();
            $('#licensesContainer').show();
            displayLicenses();
        } else {
            console.log('No licenses_and_dispensed found in add response');
            userLicenses = [];
            $('#licensesLoading').hide();
            $('#licensesContainer').show();
            displayLicenses();
        }
    }
</script>