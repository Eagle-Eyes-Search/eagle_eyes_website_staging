---
layout: ee_page_layout
title: Add Eagle Eyes License (Admin)
permalink: /add_license/
---

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Prompt</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Import JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/form_buttons_and_boxes.css">

    <!-- The moment library is used to handle dates and times -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>


</head>

<body>

    <style>
        .radio-container {
            display: block; /* Ensures each radio option is on a new line */
        }
        .radio-container input, .radio-container label {
            display: inline-block; /* Keeps the input and label on the same line */
        }
    </style>

    <script>

        const LicenseOptions = {
            TWO_WEEK_SAR: 'two_weeks',
            ONE_MONTH_SAR: 'one_month',
            THREE_MONTH_SAR: 'three_months',
            ONE_YEAR_SAR: 'one_year',
            ETERNAL_LIVE: 'live'
        }
    
        
        var statusSpan = $('#creationStatus');


        function addDeltaToDate(date, deltaNum, deltaUnit) {
            return moment(date).add(deltaNum, deltaUnit).toDate();
        }


        function handleForm() {
            console.log("handling form");
            const form = document.querySelector('form');
            // form.addEventListener('submit', function(event) {
                // Prevent default form submission
            event.preventDefault();

            // Capture form data
            const licenseName = document.querySelector('[name="license_name"]').value;
            const emails = document.querySelector('[name="emails"]').value.split(/,\s*/);
            const domains = document.querySelector('[name="domains"]').value.split(/,\s*/);
            const userType = document.querySelector('input[name="userType"]:checked').value;
            const licenseDurationInput = document.querySelector('input[name="license_duration"]:checked');
            const licenseDuration = licenseDurationInput ? licenseDurationInput.value : null;
            const keysInputId = licenseDuration + '_keys';
            const nTokens = document.getElementById(keysInputId) ? parseInt(document.getElementById(keysInputId).value, 10) : 0;

            // Calculate expiry timestamp based on license duration
            function getNewExpiryDate(currentDate, licenseDuration) {
                
                switch (licenseDuration) {
                    case 'one_week':
                        return addDeltaToDate(currentDate, 7, 'days');
                    case 'two_weeks':
                        return addDeltaToDate(currentDate, 14, 'days');
                    case 'one_month':
                        return addDeltaToDate(currentDate, 1, 'months');
                    case 'three_months':
                        return addDeltaToDate(currentDate, 3, 'months');
                    case 'one_year':
                        return addDeltaToDate(currentDate, 12, 'months'); // Equivalent to 1 year
                    default:
                        console.log('UNSPECIFIED DURATION '+licenseDuration);
                        return null;
                }
            }
            
            const currentDatetime = new Date();
            const expiryDatetime = getNewExpiryDate(currentDatetime, licenseDuration);
            console.log('Current date: ' + currentDatetime + ' License duration: ' + licenseDuration + ' Expiry date: ' + expiryDatetime);

            var expiryTimestamp;
            if (!expiryDatetime) {
                console.log('Expiry not set - taking duration to be eternal');
                expiryTimestamp = null
            } else {
                console.log("Expiry date: " + expiryDatetime);
                expiryTimestamp = expiryDatetime.getTime() / 1000;  // Convert to seconds
            }

            // Determine tier based on license duration
            // CAREFUL - these must match the values in LicenseTier enum on the server
            const tier = {
                'one_week': 'SAR',
                'two_weeks': 'SAR',
                'one_month': 'SAR',
                'three_months': 'SAR',
                'one_year': 'SAR',
                'live': 'Live'
            }[licenseDuration];

            // Prepare AJAX data
            const data = {
                license_name: licenseName,
                emails: emails,
                domains: domains,
                user_type: userType,
                expiry_timestamp: expiryTimestamp,
                tier: tier,
                n_tokens: nTokens,
                extra_security_password: document.querySelector('[name="extra_security_password"]').value
            };

            // Send AJAX request to the server
            sendLicenseData(data);
            // });
        };

        function sendLicenseData(data) {
            if (!globalUser) {
                alert('User not authenticated');
                return; // Exit the function if there is no user
            }

        // Retrieve the ID token from Firebase Auth
            globalUser.getIdToken(true).then(function (idToken) {
                var requestURL = hostURL + '/add_new_license';
                console.log("Sending request to " + requestURL + " with data: " + JSON.stringify(data));

                // First... change the text of the Create License button to "Creating License..."
                // document.querySelector('.createLicenseButton').textContent = 'Creating License...';
                statusSpan = $('#creationStatus');
                statusSpan.text('Creating...').addClass('info-box');
                // Scroll to bottom of page
                window.scrollTo(0, document.body.scrollHeight);
                // statusSpan.classList.add('error-box');
                // Disable the button to prevent multiple submissions
                // $('.createLicenseButton').prop('disabled', true);

                $.ajax({
                    url: requestURL,
                    data: JSON.stringify(data),
                    type: 'POST', // Changed from 'method' to 'type' for clarity, though both are acceptable. Use 'POST' since you're sending a body.
                    contentType: 'application/json', // This sets the Content-Type header to application/json
                    headers: {
                        'Authorization': 'Bearer ' + idToken
                    },
                    success: function (data) {
                        licenseData = JSON.parse(data);
                        console.log("Success: " + licenseData);

                        // Show user message with link and ask them if they want to download
                        // If yes, then redirect to the link
                        // If no, then do nothing
                        license_id = licenseData[0];
                        var expiryDateStr;
                        if (licenseData[1].expiry_timestamp === null) {
                            expiryDateStr = 'Eternal';
                        } else {
                            expiryDateStr = new Date(licenseData[1].expiry_timestamp * 1000).toLocaleString();
                        }
                        licenseDataDisplay = 'License created successfully:\n' + JSON.stringify(licenseData, null, 2) + '\nExpiry: ' + expiryDateStr;
                        statusSpan.html('<pre>' + licenseDataDisplay + '</pre>').removeClass('error-box').addClass('info-box');
                        if (useLocalFirebaseEmulator){
                            linkToViewFirestore = 'http://localhost:4000/firestore/default/data/licenses/'+license_id;
                        } else {
                            linkToViewFirestore = 'https://console.firebase.google.com/u/0/project/eagleeyessearch/firestore/databases/-default-/data/~2Flicenses~2F' + license_id;
                        }
                        statusSpan.append('<a href="' + linkToViewFirestore + '" target="_blank">View license in Firestore</a>');
                        // Scroll to bottom
                        window.scrollTo(0, document.body.scrollHeight);
                    },
                    error: function (xhr, status, error) {
                        console.log("Error: " + xhr.statusText);
                        console.log("Status: " + xhr.status);
                        console.log("Response: " + xhr.responseText);
                        statusSpan.text('Error creating license: ' + xhr.responseText);
                        alert('Error creating license: ' + xhr.responseText);
                    },
                });
        });
        }

        function updateKeyInput(selectedDuration) {
            // Disable all key inputs first
            document.querySelectorAll('[id$="_keys"]').forEach(function(input) {
                input.disabled = true;
            });

            // Enable the selected one
            const selectedInputId = selectedDuration + "_keys";
            const selectedInput = document.getElementById(selectedInputId);
            if (selectedInput) {
                selectedInput.disabled = false;
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            const licenseDurationSelect = document.getElementById('licenseDurationSelect');

            // Define the license options
            const licenseOptions = [
                { value: 'no_license', text: 'No License' },
                { value: 'two_weeks', text: 'Intro License: Pro - 2 Weeks' },
                { value: 'one_month', text: 'Pro - 1 Month' },
                { value: 'three_months', text: 'Pro - 3 Months' },
                { value: 'one_year', text: 'Pro - 1 Year' },
                { value: 'live', text: 'Live' }
            ];

            // Populate the select element with options
            licenseOptions.forEach(option => {
                const newOption = document.createElement('option');
                newOption.value = option.value;
                newOption.textContent = option.text;
                licenseDurationSelect.appendChild(newOption);
            });
        });

    </script>

    <style>
        input[type=text],
        input[type=password] {
            width: 80%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
    </style>

    <br />


    <section id="signin">

        <div class="info-box" id="using-emulator-info" style="display: none;">Using local Firebase emulator</div>

        <h1>Add a License</h1>

        Eagle Eyes Scan is a desktop app, available for MacOS and Windows.

        <h3> Step 1: Sign in </h3>

        {% include signinWidget.html %}
        <script>

            var globalUser = null;
            document.addEventListener('signInComplete', function (e) {
                /* Handle the event:
                CustomEvent('signInComplete', { detail: { user: user } })
                Generated by the signinWidget.html inclusion
                */

                // Use is_logged_in_user_admin to check if the user is an admin
                // TODO: Make a check to server to see 
                requestUrl = hostURL + '/is_logged_in_user_admin';
                
                console.log('signInComplete event received: ' + e.detail.user);
                e.detail.user.getIdToken(true).then(function (idToken){
                    console.log("Making request to "+hostURL+" for admin status with token "+idToken)
                    
                    statusSpan = $('#creationStatus');
                    statusSpan.text('Checking if user is admin...');

                    $.ajax({
                        url: requestUrl,
                        data: JSON.stringify({}),
                        type: 'POST', // Changed from 'method' to 'type' for clarity, though both are acceptable. Use 'POST' since you're sending a body.
                        contentType: 'application/json', // This sets the Content-Type header to application/json
                        headers: {
                            'Authorization': 'Bearer ' + idToken
                        },
                        success: function (data) {
                            data = JSON.parse(data);
                            console.log("Success: " + data);

                            isUserAdmin = data.is_admin;

                            if (isUserAdmin) {
                                globalUser = e.detail.user;
                                console.log('signInComplete event received: ' + globalUser);
                                statusSpan.text('');
                                $("#form").show(); // Show the form only if the user is an allowed admin
                            } else {
                                $("#form").hide(); // Hide the form or take any other appropriate action
                                // Optionally, display an error message or redirect non-admin users
                                statusSpan.text('Access denied. Only specific admin users can sign in. You won\'t be able to add a license with this account').addClass('error-box');

                                // alert("Access denied. Only specific admin users can sign in.  You won't be able to add a license with this account");
                                // window.location.href = 'access-denied-page.html'; // Redirect to another page
                            }
                        },
                        error: function (xhr, status, error) {
                            console.log("Status: " + xhr.status);
                            console.log("Response: " + xhr.responseText);
                            alert('Error checking if user is admin: ' + xhr.stresponseTextatusText);
                        },
                    });
                })
            });

            var useLocalFirebaseEmulator = getIsEmulatorFromURL();  // When running local emulator with "firebase emulators:start", set this to "true
            var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
            console.log('useLocalFirebaseEmulator: ' + useLocalFirebaseEmulator);
            var fireStoreLink;
            if (useLocalFirebaseEmulator){
                fireStoreLink = 'http://localhost:4000/firestore/data/licenses/';
            } else {
                fireStoreLink = 'https://console.firebase.google.com/u/0/project/eagleeyessearch/firestore/databases/-default-/data/~2Flicenses~2F';
            }


            // When document is loaded...
            $(document).ready(function() {
                console.log('Document ready');
                if (useLocalFirebaseEmulator) {
                    $('#using-emulator-info').show();
                }

                $('#place_to_view').html('<a href="' + fireStoreLink + '" target="_blank">View licenses in Firestore</a>');
            });

        </script>



    </section>

    <section id="form" hidden>

        <h3> Welcome admin. Enter Licensing details below</h3>

        <span id="place_to_view"></span>

        <form onsubmit="event.preventDefault(); handleForm();">
            <div class="container">
        
                <label for="extra_security_password"><b>Admin Password: </b></label>
                Input the admin password for extra security
                <br />
                <input type="password" placeholder="Enter Admin Password" id="extra_security_password" name="extra_security_password" required>
                <br />
        
                <label for="license_name"><b>License Name: (optional)</b></label>
                What to call this license
                <br />
                <input type="text" placeholder="Enter License Name" id="license_name" name="license_name">
                <br />
                <br />
        
                <label for="emails"><b>Emails: (required)</b></label>
                Comma-separated list of emails to add to this license
                <br />
                <input type="text" placeholder="joe@example.com,bob@example.com" id="emails" name="emails" required>
                <br />
                <br />
        
                <label for="domains"><b>Domains: (optional)</b></label>
                Comma-separated list of domains to add to this license
                <br />
                <input type="text" placeholder="examplecountysar.org,someotherdomain.com" id="domains" name="domains">
                <br />
                <br />
        
                <fieldset>
                    <legend><b>User Type:</b></legend>
                    <div class="radio-container">
                        <input type="radio" id="volunteer" name="userType" value="volunteer" required>
                        <label for="volunteer">Volunteer</label>
                    </div>
                    <div class="radio-container">
                        <input type="radio" id="general" name="userType" value="general" required>
                        <label for="general">General</label>
                    </div>
                    <div class="radio-container">
                        <input type="radio" id="special" name="userType" value="special" required>
                        <label for="special">Special</label>
                    </div>
                </fieldset>
        
                <fieldset>
                    <legend><b>License Duration:</b> Please select the license duration and specify the number of license keys:</legend>
                    <div class="license-options">
                        <!-- Radio Buttons with JavaScript calls removed for better practices, to be implemented externally -->
                    </div>
                </fieldset>
        
                <button type="submit" class="createLicenseButton">Create license</button>
                <!-- Status field -->
                <br />
        
            </div>
        </form>
        
        <br />
    </section>
    <div id="creationStatus"></div>
</body>
