---
layout: ee_page_layout
title: Add Eagle Eyes License (Admin)
permalink: /add_license/
---

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Prompt</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Import JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/form_buttons_and_boxes.css?t=[timestamp]">

</head>

<body>
    <script>

        var useLocalFirebaseEmulator = true;  // When running local emulator with "firebase emulators:start", set this to "true
        var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';

        function handleForm() {
            console.log("handling form");
            const form = document.querySelector('form');
            form.addEventListener('submit', function(event) {
                // Prevent default form submission
                event.preventDefault();

                // Capture form data
                const licenseName = document.querySelector('[name="license_name"]').value;
                const emails = document.querySelector('[name="emails"]').value.split(/,\s*/);
                const domains = document.querySelector('[name="domains"]').value.split(/,\s*/);
                const licenseDurationInput = document.querySelector('input[name="license_duration"]:checked');
                const licenseDuration = licenseDurationInput ? licenseDurationInput.value : null;
                const keysInputId = licenseDuration + '_keys';
                const nTokens = document.getElementById(keysInputId) ? parseInt(document.getElementById(keysInputId).value, 10) : 0;

                // Calculate expiry timestamp based on license duration
                const expiryDatetime = new Date();
                switch (licenseDuration) {
                    case 'one_week':
                        expiryDatetime.setDate(expiryDatetime.getDate() + 7);
                        break;
                    case 'one_weeks':
                        expiryDatetime.setDate(expiryDatetime.getDate() + 14);
                        break;
                    case 'one_month':
                        expiryDatetime.setMonth(expiryDatetime.getMonth() + 1);
                        break;
                    case 'three_months':
                        expiryDatetime.setMonth(expiryDatetime.getMonth() + 3);
                        break;
                    case 'one_year':
                        expiryDatetime.setFullYear(expiryDatetime.getFullYear() + 1);
                        break;
                }
                const expiryTimestamp = expiryDatetime.getTime() / 1000;  // Convert to seconds

                // Determine tier based on license duration
                const tier = {
                    'one_week': 'one_week',
                    'two_weeks': 'two_weeks',
                    'one_month': 'one_month',
                    'three_months': 'three_months',
                    'one_year': 'one_year',
                    'live': 'live'
                }[licenseDuration];

                // Prepare AJAX data
                const data = {
                    license_name: licenseName,
                    emails: emails,
                    domains: domains,
                    expiry_timestamp: expiryTimestamp,
                    tier: tier,
                    n_tokens: nTokens
                };

                // Send AJAX request to the server
                sendLicenseData(data);
            });
        };

        function sendLicenseData(data) {
            if (!globalUser) {
                alert('User not authenticated');
                return; // Exit the function if there is no user
            }

        // Retrieve the ID token from Firebase Auth
            globalUser.getIdToken(true).then(function (idToken) {
                var requestURL = hostURL + '/add_new_license';

                const xhr = new XMLHttpRequest();
                xhr.open('POST', requestURL, true);
                xhr.setRequestHeader('Content-Type', 'application/json');  // setting up the response to the request to be sent!
                xhr.setRequestHeader('Authorization', 'Bearer ' + idToken);  // Set the Authorization header with the token
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {  // Check if the request has completed
                        if (xhr.status === 200) {
                            alert('License successfully created');
                            document.getElementById("signin").style.display = 'none';
                            document.getElementById("form").style.display = 'none';
                            document.getElementById("post-download").style.display = 'block';
                        } else {
                            // Handle different types of HTTP errors
                            console.log("Error: " + xhr.statusText);
                            console.log("Status: " + xhr.status);
                            console.log("Response: " + xhr.responseText);
                            alert('Error creating license: ' + xhr.statusText);
                        }
                    }
                };
                xhr.onerror = function() {  // Handle network errors (e.g., problem reaching the server)
                    console.log("Network Error");
                    alert('Network Error: Could not connect to server');
                };

                xhr.send(JSON.stringify(data)); // submitting the actual request 
            }).catch(function(error) {
                console.log('Error getting ID token:', error);
                alert('Failed to authenticate user. Please try again.');
            });
        }

        function updateKeyInput(selectedDuration) {
            // Disable all key inputs first
            document.querySelectorAll('[id$="_keys"]').forEach(function(input) {
                input.disabled = true;
            });

            // Enable the selected one
            const selectedInputId = selectedDuration + "_keys";
            const selectedInput = document.getElementById(selectedInputId);
            if (selectedInput) {
                selectedInput.disabled = false;
            }
        }


        // function addLicense() {
        //     var requestURL = hostURL + '/add_new_license' 
            
        //     // Pack the form data into an object
        //     var formInputs = document.querySelectorAll('input[type=text], input[type=radio], input[type=number]');
        //     var formData = {};
        //     for (var i = 0; i < formInputs.length; i++) {
        //         var input = formInputs[i];
        //         if (input.type === 'radio') {
        //             formData[input.name] = input.checked;
        //         } else {
        //             formData[input.name] = input.value;
        //         }
        //     }

        //     console.log("Request URL: " + requestURL);
        //     globalUser.getIdToken(true).then(function (idToken) {

        //         $.ajax({
        //             url: requestUrl,
        //             data: JSON.stringify(formData),
        //             type: 'POST', // Changed from 'method' to 'type' for clarity, though both are acceptable. Use 'POST' since you're sending a body.
        //             contentType: 'application/json', // This sets the Content-Type header to application/json
        //             headers: {
        //                 'Authorization': 'Bearer ' + idToken
        //             },
        //             success: function (data) {
        //                 data = JSON.parse(data);
        //                 console.log("Success: " + data);
        //                 var downloadLink = data.url;
        //                 console.log("Download link: " + downloadLink);

        //                 // Show user message with link and ask them if they want to download
        //                 // If yes, then redirect to the link
        //                 // If no, then do nothing

        //                 window.location.href = downloadLink;
        //                 $("#signin").hide();
        //                 $("#form").hide();
        //                 $("#post-download").show();
        //                 $("#download-link").attr("href", downloadLink);


        //             },
        //             error: requestErrorHandler,
        //         });
        //     });

        // }

    </script>

    <style>
        input[type=text],
        input[type=password] {
            width: 80%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
    </style>

    <!-- <button onclick="getDownloadLink()">Get Download Link</button> -->


    <!-- <form onsubmit="decryptAndRedirect(event)">
    <label for="password">Password:</label>
    <input type="password" id="password" name="password" required>
    <button type="submit">Submit</button>
</form> -->


    <br />

    <section id="signin">
        <h1>Add a License</h1>

        Eagle Eyes Scan is a desktop app, available for MacOS and Windows.

        <h3> Step 1: Sign in </h3>

        {% include signinWidget.html %}
        <script>

            var globalUser = null;
            // List of admin emails allowed to sign in
            var allowedAdmins = ['joep@eagleeyessearch.com', 'peter@eagleeyessearch.com'];

            document.addEventListener('signInComplete', function (e) {
                /* Handle the event:
                CustomEvent('signInComplete', { detail: { user: user } })
                Generated by the signinWidget.html inclusion
                */
                globalUser = e.detail.user;
                console.log('signInComplete event received: ' + globalUser);
                if (allowedAdmins.includes(globalUser.email)) {
                    $("#form").show(); // Show the form only if the user is an allowed admin
                } else {
                    $("#form").hide(); // Hide the form or take any other appropriate action
                    // Optionally, display an error message or redirect non-admin users
                    alert("Access denied. Only specific admin users can sign in.");
                    // window.location.href = 'access-denied-page.html'; // Redirect to another page
                }
            });

        </script>



    </section>

    <section id="form" hidden>

        <h3> Welcome admin. Enter Licensing details below</h3>
        <form onsubmit="event.preventDefault(); handleForm();">
            <div class="container">

                <label for="license_name"><b>License Name: (optional)</b></label>
                What to call this license
                <br />
                <input type="text" placeholder="Example County SAR Trial " name="license_name">
                <br />
                <label for="emails"><b>Emails: (required)</b></label>
                Comma-separated list of emails to add to this license
                <br />
                <input type="text" placeholder="joe@example.com,bob@example.com" name="emails" required>
                <br />
                <label for="domains"><b>Domains: (optional)</b></label>
                Comma-separated list of domains to add to this license
                <br />
                <input type="text" placeholder="examplecountysar.org,someotherdomain.com" name="domains">
                <br />

                <label for="licenseDuration"><b>License Duration:</b> Please select the license duration and specify the number of license keys:</label>
                <div class="license-options">
                    <div class="radio-container">
                        <input type="radio" id="one_week" name="license_duration" value="one_week" required onclick="updateKeyInput('one_week')">
                        <label for="one_week">Pro - 1 Week, with <input type="number" id="one_week_keys" name="one_week_keys" value="1" min="1" disabled> keys</label>                       
                    </div>

                    <div class="radio-container">
                        <input type="radio" id="two_weeks" name="license_duration" value="two_weeks" required onclick="updateKeyInput('two_weeks')">
                        <label for="two_weeks">Pro - 2 Weeks, with <input type="number" id="two_weeks_keys" name="two_weeks_keys" value="1" min="1" disabled> keys</label>                       
                    </div>

                    <div class="radio-container">
                        <input type="radio" id="one_month" name="license_duration" value="one_month" required onclick="updateKeyInput('one_month')">
                        <label for="one_month">Pro - 1 Month, with <input type="number" id="one_month_keys" name="one_month_keys" value="2" min="1" disabled> keys</label>                        
                    </div>
                    <div class="radio-container">
                        <input type="radio" id="three_months" name="license_duration" value="three_months" required onclick="updateKeyInput('three_months')">
                        <label for="three_months">Pro - 3 Months, with <input type="number" id="three_months_keys" name="three_months_keys" value="2" min="1" disabled> keys</label>                        
                    </div>

                    <div class="radio-container">
                        <input type="radio" id="one_year" name="license_duration" value="one_year" required onclick="updateKeyInput('one_year')">
                        <label for="one_year">Pro - 1 Year, with <input type="number" id="one_year_keys" name="one_year_keys" value="3" min="1" disabled> keys</label>
                    </div>
                    <div class="radio-container">
                        <input type="radio" id="live" name="license_duration" value="live" required onclick="updateKeyInput('live')">
                        <label for="live">Live, with <input type="number" id="live_keys" name="live_keys" value="2" min="1" disabled> keys</label>
                    </div>
                </div>
                <button type="submit" class="createLicenseButton">Create license</button>
                <br />
            </div>
        </form>
    </section>

    <section id="post-download" class="info-box" hidden>
        The following licenses were added:
        (still need to add this part)
        <!-- Add button to return to home page -->
        <br />
        <button onclick="location.href='/'" class="non_important_button">Return to home page</button>
    </section>
</body>