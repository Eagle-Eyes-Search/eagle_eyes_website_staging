<script>
// Global variables for drone data
let selectedDrone = null;
let droneModelsData = [];
let filteredDroneModels = [];
let currentHighlightIndex = -1;

// Host URL setup (same as download page)
var hostURL = 'https://us-central1-eagleeyessearch.cloudfunctions.net';

// Load drone models when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadDroneModels();
});

async function loadDroneModels() {
    try {
        const response = await fetch(`${hostURL}/get_drone_models`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) throw new Error('Failed to fetch drone models');

        const data = await response.json();
        const all = data.drones || [];

        // Keep only drones whose compatibility includes "Pilot" (case-insensitive, supports both keys)
        const pilotOnly = all.filter(d => {
            const compat =
                Array.isArray(d.compatibility) ? d.compatibility :
                Array.isArray(d.Compatibility) ? d.Compatibility : [];
            return compat.map(x => String(x).toLowerCase()).includes('pilot');
        });

        droneModelsData = pilotOnly;
        displayDroneModels(droneModelsData);

    } catch (error) {
        console.error('Error loading drone models:', error);
        // Fallback to basic list (DJI examples only; no Autel-as-Pilot here)
        populateBasicDroneList();
    }
}

function displayDroneModels(drones) {
    const dropdown = document.getElementById('drone-dropdown');
    if (!dropdown) {
        console.error('Drone dropdown element not found');
        return;
    }

    dropdown.innerHTML = '<option value="">-- Select a drone model --</option>';

    if (!drones || drones.length === 0) {
        dropdown.innerHTML = '<option value="">No drone models available</option>';
        return;
    }

    // Defensive: ensure Pilot-only again here, then sort A→Z
    const pilotCompatibleDrones = drones.filter(drone => {
        const compat =
            Array.isArray(drone.compatibility) ? drone.compatibility :
            Array.isArray(drone.Compatibility) ? drone.Compatibility : [];
        return compat.map(x => String(x).toLowerCase()).includes('pilot');
    });

    const sortedDrones = pilotCompatibleDrones.slice().sort((a, b) => {
        const nameA = `${a.brand} ${a.name}`.toLowerCase();
        const nameB = `${b.brand} ${b.name}`.toLowerCase();
        return nameA.localeCompare(nameB);
    });

    // Populate dropdown with Pilot-compatible drones
    sortedDrones.forEach((drone, index) => {
        const option = document.createElement('option');
        const displayName = `${drone.brand} ${drone.name}`;
        option.value = index; // index in the sorted list
        option.textContent = displayName;
        option.setAttribute('data-drone-data', JSON.stringify(drone));
        dropdown.appendChild(option);
    });

    // === Keep injecting "Autel" (Scan-oriented placeholder), regardless of Pilot support ===
    const autelOption = document.createElement('option');
    autelOption.value = 'autel';
    autelOption.textContent = 'Autel';
    autelOption.setAttribute('data-drone-data', JSON.stringify({
        name: 'Autel',
        brand: 'Autel',
        status: 'autel-compatible',
        footnotes: 'Several Autel models can output a clean HDMI feed for live streaming into Eagle Eyes Scan. Eagle Eyes Scan can also read the .ASS files Autel generates with mp4 recordings to reconstruct the drone\'s GPS track, display it on the map, and enable easy <a href="https://streamable.com/qzfqvu" target="_blank" style="color: #007bff; text-decoration: underline;">export of detections as geolocated photo points for import into CalTopo</a>. Development is ongoing to further improve compatibility with Autel and other drone makes and models.'
    }));

    // Insert Autel in alphabetical order among current options
    let inserted = false;
    for (let i = 0; i < dropdown.options.length; i++) {
        if (dropdown.options[i].textContent.localeCompare('Autel') > 0) {
            dropdown.insertBefore(autelOption, dropdown.options[i]);
            inserted = true;
            break;
        }
    }
    if (!inserted) dropdown.appendChild(autelOption);

    // Add "Other drone make or model" option at the end
    const otherOption = document.createElement('option');
    otherOption.value = 'other';
    otherOption.textContent = 'Other drone make or model';
    otherOption.setAttribute('data-drone-data', JSON.stringify({
        name: 'Other drone make or model',
        brand: '',
        controllers_internally_tested: [],
        controllers_user_tested: [],
        controllers_not_tested: [],
        controllers_incompatible: [],
        footnotes: 'Compatible with Eagle Eyes Scan (optimized if your drone allows for a clean HDMI live stream without on-screen overlays). For Eagle Eyes Pilot (our piloting app), we currently support only the models shown in the list above.'
    }));
    dropdown.appendChild(otherOption);

    // Store sorted list for autocomplete/search (Autel is intentionally NOT added here)
    droneModelsData = sortedDrones;
}

function populateBasicDroneList() {
    const dropdown = document.getElementById('drone-dropdown');
    if (!dropdown) return;

    dropdown.innerHTML = '<option value="">-- Select a drone model --</option>';

    // Minimal DJI-only fallback marked Pilot-compatible
    const basicDrones = [
        { brand: 'DJI', name: 'Mini 3 Pro', compatibility: ['Pilot'] },
        { brand: 'DJI', name: 'Mavic 3', compatibility: ['Pilot'] },
        { brand: 'DJI', name: 'Air 2S', compatibility: ['Pilot'] },
        { brand: 'DJI', name: 'M3T', compatibility: ['Pilot'] },
        { brand: 'DJI', name: 'M30T', compatibility: ['Pilot'] }
    ];

    basicDrones.forEach((drone, index) => {
        const option = document.createElement('option');
        const displayName = `${drone.brand} ${drone.name}`;
        option.value = index;
        option.textContent = displayName;
        option.setAttribute('data-drone-data', JSON.stringify(drone));
        dropdown.appendChild(option);
    });

    // Inject Autel here as well (fallback page should still advertise Scan path)
    const autelOption = document.createElement('option');
    autelOption.value = 'autel';
    autelOption.textContent = 'Autel';
    autelOption.setAttribute('data-drone-data', JSON.stringify({
        name: 'Autel',
        brand: 'Autel',
        status: 'autel-compatible',
        footnotes: 'Several Autel models can output a clean HDMI feed for live streaming into Eagle Eyes Scan…'
    }));
    dropdown.appendChild(autelOption);

    // "Other…" at end
    const otherOption = document.createElement('option');
    otherOption.value = 'other';
    otherOption.textContent = 'Other drone make or model';
    otherOption.setAttribute('data-drone-data', JSON.stringify({
        name: 'Other drone make or model',
        brand: '',
        footnotes: 'Compatible with Eagle Eyes Scan. For Eagle Eyes Pilot, we currently support only the models listed above.'
    }));
    dropdown.appendChild(otherOption);

    droneModelsData = basicDrones;
}

function selectDroneFromDropdown() {
    const dropdown = document.getElementById('drone-dropdown');
    const selectedValue = dropdown.value;

    if (!selectedValue || selectedValue === '') {
        document.getElementById('drone-info-container').innerHTML = '';
        return;
    }

    const selectedOption = dropdown.options[dropdown.selectedIndex];
    const droneDataAttr = selectedOption.getAttribute('data-drone-data');

    if (!droneDataAttr) {
        console.error('No drone data found for selected option');
        return;
    }

    try {
        const droneData = JSON.parse(droneDataAttr);
        displayDroneInfo(droneData);
    } catch (error) {
        console.error('Error parsing drone data:', error);
    }
}

function displayDroneInfo(droneData) {
    const container = document.getElementById('drone-info-container');

    // Special card: "Other…"
    if (droneData.name === 'Other drone make or model') {
        let html = `
            <div style="background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 12px; padding: 25px; margin-top: 20px;">
                <h4 style="margin-bottom: 15px; color: #333; font-size: 20px; font-weight: 600;">${droneData.name}</h4>
                <div style="margin-bottom: 20px;">
                    <p style="color: #856404; line-height: 1.6; margin-bottom: 15px;">
                        Compatible with <strong>Eagle Eyes Scan</strong> via clean HDMI or file ingest. For <strong>Eagle Eyes Pilot</strong>, we currently support only the models listed in the dropdown above.
                    </p>
                </div>
                <div class="green-info-box">
                    <p><strong>Eagle Eyes Pilot</strong> can be installed on Android and offers several free features. See the Android Devices section below for details.</p>
                </div>
            </div>`;
        container.innerHTML = html;
        return;
    }

    // Special card: injected "Autel" placeholder (Scan info)
    if (droneData.brand === 'Autel' && droneData.name === 'Autel') {
        let html = `
            <div style="background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 12px; padding: 25px; margin-top: 20px;">
                <h4 style="margin-bottom: 15px; color: #333; font-size: 20px; font-weight: 600;">Autel</h4>
                <div style="margin-bottom: 20px;">
                    <p style="color: #856404; line-height: 1.6; margin-bottom: 15px;">
                        Several Autel models can output a clean HDMI feed for <a href="https://youtu.be/cwZ4tvBRdjA" target="_blank" style="color: #007bff; text-decoration: underline;">live streaming into Eagle Eyes Scan</a>. Eagle Eyes Scan can also read the .ASS files Autel generates with mp4 recordings to reconstruct the drone’s GPS track, display it on the map, and enable easy <a href="https://streamable.com/qzfqvu" target="_blank" style="color: #007bff; text-decoration: underline;">export of detections as geolocated photo points for CalTopo</a>. Development is ongoing to improve compatibility.
                    </p>
                </div>
            </div>
        `;
        container.innerHTML = html;
        return;
    }

    // Regular drone details
    let html = `
        <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 25px; margin-top: 20px;">
            <h4 style="margin-bottom: 15px; color: #333; font-size: 20px; font-weight: 600;">${droneData.brand || ''} ${droneData.name || ''}</h4>

            <h5 style="margin: 20px 0 15px 0; color: #555; font-size: 16px; font-weight: 600;">
                <img src="{{ '/images/djicontroller.png' | relative_url }}" alt="Controller Icon" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;">
                Compatible Controllers:
            </h5>
            <div style="display: grid; gap: 12px;">
    `;

    const allControllers = [
        ...(droneData.controllers_internally_tested || []).map(name => ({ name, status: 'supported', category: 'internally_tested' })),
        ...(droneData.controllers_user_tested || []).map(name => ({ name, status: 'supported', category: 'user_tested' })),
        ...(droneData.controllers_not_tested || []).map(name => ({ name, status: 'untested', category: 'not_tested' })),
        ...(droneData.controllers_incompatible || []).map(name => ({ name, status: 'incompatible', category: 'incompatible' })),
        { name: 'Android Device', status: 'supported', category: 'general' },
        { name: 'Android Tablet', status: 'supported', category: 'general' }
    ];

    if (allControllers.length === 0) {
        html += '<p style="color: #6c757d; font-style: italic;">No controllers available for this drone.</p>';
    } else {
        allControllers.forEach(controller => {
            let iconSrc, iconAlt;
            if (controller.name === 'Android Device') {
                iconSrc = '{{ "/images/android_smartphone_icon.png" | relative_url }}';
                iconAlt = 'Android Device';
            } else if (controller.name === 'Android Tablet') {
                iconSrc = '{{ "/images/android_tablet.png" | relative_url }}';
                iconAlt = 'Android Tablet';
            } else {
                iconSrc = '{{ "/images/djicontroller.png" | relative_url }}';
                iconAlt = 'Controller';
            }

            const statusText = controller.status === 'supported' ? '✅ Fully Supported'
                              : controller.status === 'untested'  ? '⚠️ May Work'
                              : '❌ Not Supported';

            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border: 1px solid #e9ecef; border-radius: 8px;">
                    <div style="display: flex; align-items: center;">
                        <img src="${iconSrc}" alt="${iconAlt}" style="width: 20px; height: 20px; margin-right: 10px;">
                        <span style="font-weight: 500; color: #333;">${controller.name}</span>
                    </div>
                    <span class="compatibility-status status-${controller.status}">
                        ${statusText}
                    </span>
                </div>
            `;
        });
    }

    if (droneData.footnotes) {
        html += `
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; font-style: italic; color: #856404; font-size: 13px; line-height: 1.4;">
                ${droneData.footnotes}
            </div>
        `;
    }

    html += `
        <div style="margin-top: 20px; text-align: center;">
            <button class="download-button" onclick="window.location.href=getDownloadUrl('#step3&platform=mobile')">
                <i class="download-icon">⬇</i> Download Eagle Eyes Pilot Now
            </button>
        </div>
    `;

    html += '</div>';
    container.innerHTML = html;
}

function selectDesktopPlatform(platform) {
    // Remove any existing download buttons
    const platformCards = document.querySelectorAll('.platform-card');
    platformCards.forEach(card => {
        const existingButton = card.querySelector('.download-button');
        if (existingButton) existingButton.remove();
    });

    // Add download button to the selected platform card
    const selectedCard = event.currentTarget;
    const downloadButton = document.createElement('button');
    downloadButton.className = 'download-button';
    downloadButton.innerHTML = '<i class="download-icon">⬇</i> Download Scan Now';
    downloadButton.onclick = function(e) {
        e.stopPropagation();
        window.location.href = getDownloadUrl('?step=3&platform=desktop&os=windows');
    };
    selectedCard.appendChild(downloadButton);
}

// URL helper function for download links
function getDownloadUrl(hash) {
    const baseUrl = '{{ "/download/" | relative_url }}';
    return baseUrl + hash;
}

// ===== Search / Autocomplete =====
function handleSearchInput() {
    const searchInput = document.getElementById('drone-search');
    const searchTerm = searchInput.value.toLowerCase().trim();
    currentHighlightIndex = -1;

    if (searchTerm.length === 0) {
        hideAutocomplete();
        return;
    }

    // Filter *already Pilot-only* list by name
    filteredDroneModels = droneModelsData.filter(drone => {
        const displayName = `${drone.brand} ${drone.name}`.toLowerCase();
        return displayName.includes(searchTerm);
    });

    updateAutocompleteDropdown();
    showAutocomplete();
}

function updateAutocompleteDropdown() {
    const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
    autocompleteDropdown.innerHTML = '';

    filteredDroneModels.forEach(drone => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.textContent = `${drone.brand} ${drone.name}`;
        item.setAttribute('data-drone-data', JSON.stringify(drone));
        item.onclick = () => selectDroneFromAutocomplete(drone);
        autocompleteDropdown.appendChild(item);
    });
}

function showAutocomplete() {
    const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
    if (filteredDroneModels.length > 0) {
        autocompleteDropdown.style.display = 'block';
    } else {
        hideAutocomplete();
    }
}

function hideAutocomplete() {
    setTimeout(() => {
        const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
        autocompleteDropdown.style.display = 'none';
    }, 200);
}

function handleSearchKeydown(event) {
    const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');

    if (event.key === 'ArrowDown') {
        event.preventDefault();
        const currentIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));
        const nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;

        items.forEach(item => item.classList.remove('selected'));
        if (items[nextIndex]) items[nextIndex].classList.add('selected');

    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        const currentIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));
        const prevIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;

        items.forEach(item => item.classList.remove('selected'));
        if (items[prevIndex]) items[prevIndex].classList.add('selected');

    } else if (event.key === 'Enter') {
        event.preventDefault();
        const selectedItem = autocompleteDropdown.querySelector('.autocomplete-item.selected');
        if (selectedItem) {
            const droneData = JSON.parse(selectedItem.getAttribute('data-drone-data'));
            selectDroneFromAutocomplete(droneData);
        }
    }
}

function selectDroneFromAutocomplete(droneData) {
    const searchInput = document.getElementById('drone-search');
    const dropdown = document.getElementById('drone-dropdown');

    searchInput.value = `${droneData.brand} ${droneData.name}`;
    hideAutocomplete();

    // Find and select the corresponding dropdown option
    const displayName = `${droneData.brand} ${droneData.name}`;
    for (let i = 0; i < dropdown.options.length; i++) {
        if (dropdown.options[i].textContent === displayName) {
            dropdown.selectedIndex = i;
            break;
        }
    }

    // Display drone info
    displayDroneInfo(droneData);
}

function toggleCompatibilityDetails() {
    const content = document.getElementById('compatibility-details-content');
    const toggleText = document.getElementById('toggle-text');
    const toggleIcon = document.getElementById('toggle-icon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggleText.textContent = 'Hide details';
        toggleIcon.textContent = '▲';
    } else {
        content.style.display = 'none';
        toggleText.textContent = 'Click here for more info';
        toggleIcon.textContent = '▼';
    }
}
</script>
