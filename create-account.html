---
layout: main
title: Create an Account - Eagle Eyes
---

<div class="section-block bkg-grey-ultralight" style="padding: 120px 0 30px 0;">
    <!-- Add the test user banner right at the top -->
    <div id="test-user-banner" style="display: none; position: sticky; top: 0; left: 0; width: 100%; background-color: #4CAF50; color: white; padding: 10px 0; text-align: center; z-index: 1000; margin-bottom: 20px;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <span><strong>Development Mode</strong></span>
            <button id="test-user-login" class="button small rounded" style="background-color: white; color: #4CAF50; border: none; padding: 8px 15px; font-size: 14px; cursor: pointer;">Sign in as Test User</button>
        </div>
    </div>
    
    <div class="row">
        <div class="column width-12">
            <div class="centered">
                <h2 class="mb-10">Create an Account</h2>
                <div style="display: flex; justify-content: flex-start; align-items: center; gap: 20px;">
                    <div id="userEmailDisplay" style="color: #666; font-size: 16px;"></div>
                    <div id="signOutContainer" style="display: none;">
                        <a href="#" id="signOutButton" class="button small rounded" style="padding: 8px 15px; font-size: 14px;">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-block" style="padding-top: 20px;">
    <div class="row">
        <div class="column width-8 offset-2">
            <!-- Sign in button (will trigger overlay) -->
            <div id="signinButtonSection" style="display: block; text-align: center; margin-bottom: 40px;">
                <p style="margin-bottom: 20px;">Sign in to get started. Don't have an account? No worries, you'll be able to create one.</p>
                <button id="accountSignInButton" class="button" onclick="toggleSignIn()">Sign In or Create Account</button>
            </div>

            <!-- Trial form content section -->
            <div id="form-container" class="box rounded xlarge bkg-white shadow" style="display: none;">
                <div class="box-content">
                    <div class="row">
                        <div class="column width-12">
                            <h3 class="mb-30"></h3>
                            <p style="text-align: center;">Please take a minute to share a few details and create your account.</p>
                            
                            {% include account-questions.html %}
                            
                            
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div id="hang-on-message" class="info-box" style="display: none; margin-top: 20px; text-align: center; padding: 20px;">
                Hang on a moment while we get everything ready for you...
            </div>
            
            <div id="post-form" class="info-box" style="display: none; margin-top: 20px; text-align: center; padding: 20px;">
                <div id="checking-licenses-box">Your 30-day trial request was submitted successfully. We will contact you soon. Please reach out to info@eagleeyessearch.com if you have any questions.</div>
            </div>
        </div>
    </div>
</div>

<!-- Sign in overlay -->
<div id="signin-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; width: 100%; height: 100%;">
        {% include signinwidget-main.html %}
    </div>
</div>

<style>
    /* Radio button styles */
    .radio-group {
        margin-bottom: 20px;
    }
    
    .radio-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .radio-container input[type="radio"] {
        margin-right: 10px;
        /* Ensure visibility */
        opacity: 1;
        visibility: visible;
        position: static;
        width: auto;
        height: auto;
    }
    
    /* Fix for labels */
    .radio-container label {
        display: inline-block;
        cursor: pointer;
    }
    
    /* Fix for checkbox containers too */
    .checkbox-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .checkbox-container input[type="checkbox"] {
        margin-right: 10px;
        /* Ensure visibility */
        opacity: 1;
        visibility: visible;
        position: static;
        width: auto;
        height: auto;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the form component
        if (typeof initFormComponent === 'function') {
            initFormComponent({
                defaultFormType: 'trial' // Default to trial form
            });
        }
        
        const signinButtonSection = document.getElementById('signinButtonSection');
        const formContainer = document.getElementById('form-container');
        const userEmail = document.getElementById('userEmailDisplay');
        const signOutContainer = document.getElementById('signOutContainer');
        const signOutButton = document.getElementById('signOutButton');
        const hangOnMessage = document.getElementById('hang-on-message');
        const postForm = document.getElementById('post-form');
        const submitButton = document.getElementById('submitButton');
        
        // If we have a submit button, attach the handler
        if (submitButton) {
            submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                submitForm();
            });
        }
        
        // Listen for auth state changes
        document.addEventListener('authStateChanged', function(e) {
            const user = e.detail.user;
            if (user) {
                // User is signed in
                signinButtonSection.style.display = 'none';
                userEmail.textContent = `Logged in as: ${user.email}`;
                signOutContainer.style.display = 'block';
                
                // Don't immediately check or show form - let signinwidget handle redirects
                // We'll only display forms if we know we need to stay on this page
                hangOnMessage.style.display = 'block';
                setTimeout(function() {
                    // If we're still on this page after a short delay,
                    // the user probably needs to fill this form
                    checkExistingForm(user);
                }, 200);
            } else {
                // User is signed out
                signinButtonSection.style.display = 'block';
                formContainer.style.display = 'none';
                hangOnMessage.style.display = 'none';
                postForm.style.display = 'none';
                userEmail.textContent = '';
                signOutContainer.style.display = 'none';
            }
        });
        
        // Handle the signInComplete event
        document.addEventListener('signInComplete', function(e) {
            const user = e.detail.user;
            toggleSignIn(); // Hide the overlay
        });
        
        // Handle sign out
        if (signOutButton) {
            signOutButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                firebase.auth().signOut().then(function() {
                    // Sign-out successful
                    console.log('User signed out successfully');
                    
                    // Reload preserving the emulator parameter
                    const currentUrl = new URL(window.location.href);
                    window.location.href = currentUrl.toString();
                }).catch(function(error) {
                    console.error('Error signing out:', error);
                });
            });
        }
        
        // Set up test user functionality if in emulator mode
        setupTestUserBanner();
    });
    
    // Form submission handler
    function submitForm() {
        // Get form validation result and data
        const result = validateFormAndGetData();
        
        if (!result.valid) {
            return false; // Form validation failed
        }
        
        // Show processing state
        $("#submitButton").addClass('processing');
        
        // Get form type from the component
        const formType = currentFormType;
        console.log('Form type when submitting:', formType);
        
        // Submit to server based on form type
        if (formType === 'purchase' || formType === 'trial') {
            submitRegisterForm(result.data);
        } else if (formType === 'download') {
            submitSignupForm(result.data);
        } else {
            console.log("Unknown form type:", formType);
            $("#submitButton").removeClass('processing');
        }
    }
    
    // Server submission for registration
    function submitRegisterForm(formData) {
        // Get the host URL
        const hostURL = window.getHostUrl ? window.getHostUrl() : 
                       (useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 
                        'https://us-central1-eagleeyessearch.cloudfunctions.net');
        
        const fetch_url = hostURL + '/submit_register_form';
        console.log("Fetch URL:", fetch_url);
        
        // Get auth token and submit
        firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
            $.ajax({
                url: fetch_url,
                data: JSON.stringify(formData),
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    console.log("Success", data);
                    $("#submitButton").removeClass('processing');
                    
                    // Show success UI
                    $("#form-container").hide();
                    $("#signin").hide();
                    $("#post-form").show();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $("#submitButton").removeClass('processing');
                    requestErrorHandler(jqXHR, textStatus, errorThrown);
                }
            });
        }).catch(function(error) {
            console.error("Error getting auth token:", error);
            $("#submitButton").removeClass('processing');
        });
    }
    
    // Server submission for signup
    function submitSignupForm(formData) {
        // Same pattern as submitRegisterForm but with appropriate endpoint
        // ... implementation similar to submitRegisterForm ...
    }
    
    // Function to check if user has already filled in form
    function checkExistingForm(user) {
        const formContainer = document.getElementById('form-container');
        const hangOnMessage = document.getElementById('hang-on-message');
        const postForm = document.getElementById('post-form');

        // Ensure the form is hidden until we get a result.
        formContainer.style.display = 'none';
        hangOnMessage.style.display = 'block';

        // Get the host URL for API calls
        const hostURL = window.getHostUrl ? window.getHostUrl() : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
        const fetch_url = hostURL + '/has_user_already_filled_in_form';

        user.getIdToken(true).then(function(idToken) {
            $.ajax({
                url: fetch_url,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    hangOnMessage.style.display = 'none';
                    
                    console.log("Got reply from has_user_already_filled_in_form:", data);
                    // Parse the response if it's a string
                    const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                    const formOrNull = parsedData.form;
                    
                    if (formOrNull === null) {
                        // User has not filled in the form yet: show the form now.
                        console.log('User did not fill in form yet.');
                        formContainer.style.display = 'block';
                    } else {
                        // User has already filled in the form: redirect to account.html.
                        console.log("User already filled in form. Redirecting to account.html");
                        window.location.href = 'account.html';
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    hangOnMessage.style.display = 'none';
                    console.error("Error checking form:", textStatus, errorThrown, jqXHR.responseText);
                    
                    // On error, show the form anyway.
                    formContainer.style.display = 'block';
                }
            });
        }).catch(function(error) {
            hangOnMessage.style.display = 'none';
            console.error("Error getting ID token:", error);
            // On error, show the form anyway.
            formContainer.style.display = 'block';
        });
    }
    
    // Toggle the sign in overlay
    function toggleSignIn() {
        const overlay = document.getElementById('signin-overlay');
        overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
        document.body.style.overflow = overlay.style.display === 'block' ? 'hidden' : 'auto';
    }
    
    // Utility function to preserve the emulator parameter when redirecting
    function getUrlWithEmulatorParam(url) {
        const isEmulator = new URLSearchParams(window.location.search).get('is_emulator') === 'true';
        if (!isEmulator) return url;
        
        // Add the parameter to the URL if it doesn't already have it
        const separator = url.includes('?') ? '&' : '?';
        return url.includes('is_emulator=true') ? url : `${url}${separator}is_emulator=true`;
    }
    
    // Setup test user banner
    function setupTestUserBanner() {
        // Check if we're in emulator mode
        const urlParams = new URLSearchParams(window.location.search);
        const isEmulator = urlParams.get('is_emulator') === 'true';
        
        if (isEmulator) {
            // Show the test user banner
            const banner = document.getElementById('test-user-banner');
            if (banner) banner.style.display = 'block';
            
            // Set up the test user login button
            const testUserBtn = document.getElementById('test-user-login');
            if (testUserBtn) {
                testUserBtn.addEventListener('click', function() {
                    // Test user credentials
                    const testEmail = 'test@example.com';
                    const testPassword = 'password123';
                    
                    // Store current URL with parameters before sign-in
                    const currentUrl = window.location.href;
                    
                    // Try to sign in first
                    firebase.auth().signInWithEmailAndPassword(testEmail, testPassword)
                        .then((userCredential) => {
                            console.log('Test user signed in successfully');
                            // If the page reloads, ensure we come back to a URL with the emulator param
                            window.history.replaceState(null, document.title, currentUrl);
                        })
                        .catch((error) => {
                            // If sign-in fails, create the user first
                            if (error.code === 'auth/user-not-found') {
                                console.log('Test user not found, creating account...');
                                firebase.auth().createUserWithEmailAndPassword(testEmail, testPassword)
                                    .then((userCredential) => {
                                        console.log('Test user created and signed in successfully');
                                        // If the page reloads, ensure we come back to a URL with the emulator param
                                        window.history.replaceState(null, document.title, currentUrl);
                                    })
                                    .catch((createError) => {
                                        console.error('Error creating test user:', createError);
                                    });
                    } else {
                                console.error('Error signing in with test user:', error);
                            }
                        });
                });
            }
        }
    }
    
    // Error handler function
    function requestErrorHandler(jqXHR, textStatus, errorThrown) {
        // ... existing code ...
    }
</script>