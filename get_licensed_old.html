---
layout: ee_page_layout
title: Eagle Eyes - Licensing Plans
permalink: /get_licensed_old/
---

<head>

    <title>Eagle Eyes - Get a License token</title>

    To run Eagle Eyes Scan - you need to enter a license-token into the app.
    You can enter it by pressing the "ðŸ”‘" button. The license token is a
    unique code that lets you use the app on a specific machine for a specific
    amount of time.
    <br />
    <br />
    You can get a license token by purchasing a license, then requesting a token
    from that license. You can do that all from this webpage.


    <!-- Include Firebase SDK -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <style>
        .info-box {
            background-color: #e0f7fa;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .error-box {
            background-color: #ffcccb;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .expandable-menu {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .expandable-menu .menu-title {
            cursor: pointer;
            position: relative;
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .expandable-menu .menu-title::before {
            content: 'â–¼';
            /* dropdown arrow */
            font-size: 12px;
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s ease;
        }

        .expandable-menu .menu-title.collapsed::before {
            transform: translateY(-50%) rotate(-90deg);
            /* arrow pointing right when collapsed */
        }


        button {
            background-color: #4499cc;
            /* Faded blue */
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        .non_important_button {
            background-color: #6c6c6c;
        }

        button:hover {
            background-color: #3e8ebe;
            /* Darker blue */
        }

        .menu-title {
            display: flex;
            /* Use flexbox for layout */
            align-items: center;
            /* Align items vertically */
            justify-content: space-between;
            /* Space between title and button */
            cursor: pointer;
            /* Optional: indicates the title is clickable */
        }

        .menu-title button {
            cursor: pointer;
            /* Indicates the button is clickable */
            margin: 0;
            /* Adjusts margin to better align with the text */
            padding: 0 8px;
            /* Adjust padding to your liking */
            background: none;
            /* Removes default background */
            border: none;
            /* Removes default border */
            font-size: 1em;
            /* Adjust the font size to match your title */
        }


        .menu-content {
            display: none;
            padding-top: 10px;
            display: flex;
            /* Enables flexbox */
            align-items: stretch;
            /* Stretch items to fill the container vertically */
        }

        .left-column {
            flex-grow: 1;
            /* Allows the column to take up the available space */
            display: flex;
            /* Enables flexbox for the column */
            flex-direction: column;
            /* Stack children vertically */
            justify-content: space-around;
            /* Distributes space around items */
            margin-right: 10px;
            /* Optional: Adds some space between the column and the button */
        }

        #copy-btn {
            height: 100%;
            /* Fill the full vertical space */
            flex-grow: 0;
            /* Do not allow the button to grow */
            flex-shrink: 0;
            /* Prevent the button from shrinking */
            align-self: stretch;
            /* Stretch the button to fill the container */
        }
    </style>

    <script>
        // Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyAL9w9qClktCNFM1XSfo_HB59nU6zHI0bk",
            authDomain: "eagleeyessearch.firebaseapp.com",
            projectId: "eagleeyessearch",
            storageBucket: "eagleeyessearch.appspot.com",
            messagingSenderId: "983592831720",
            appId: "1:983592831720:web:57b3880d0185ea3110575d",
            measurementId: "G-J057SPR81M"
        };

        var machineId = getMachineIdFromURL();

        var user = null;

        console.log("Machine ID: " + machineId);

        thisURLwithJustMachineIDArg = window.location.origin + '/get_licensed/?machine_id=' + machineId;

        // Wait for the HTML to load
        document.addEventListener("DOMContentLoaded", function () {
            // Display the machine ID in the HTML
            document.getElementById('machine-id').textContent = machineId;
        });

        function getMachineIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('machine_id');
        }

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        function signInWithGoogle() {
            var provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            firebase.auth().signInWithPopup(provider).then(function (result) {
                user = result.user;
                updateUserDisplay(user);
                checkLicence(user); // Call checklicence after successful login
            }).catch(function (error) {
                console.error('Error during Google sign in: ', error);
            });
        }

        // function signInWithEmailPassword() {
        //     var email = document.getElementById('email').value;
        //     var password = document.getElementById('password').value;

        //     firebase.auth().signInWithEmailAndPassword(email, password)
        //         .then((userCredential) => {
        //             user = userCredential.user;
        //             updateUserDisplay(user);
        //             checkLicence(user); // Call checklicence after successful login
        //         })
        //         .catch((error) => {
        //             console.error('Error during Email sign in: ', error);
        //         });
        // }

        function signInWithEmailLink() {
            var email = document.getElementById('email').value;
            var baseURL = window.location.origin;
            var actionCodeSettings = {
                // Make sure this URL is the URL of the page where you will handle the sign-in link
                // url: 'https://www.eagleeyessearch.com/get_licensed/?machine_id=LFXRYD6HOYA',
                //url: 'http://localhost:4001/get_licensed/?machine_id=LFXRYD6HOYA',
                url: `${baseURL}/get_licensed/?machine_id=${machineId}`,
                handleCodeInApp: true
            };

            firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);

                    // Now, replace sign-in-div with an info box telling the user to check their email
                    var signInDiv = document.getElementById('sign-in-div');
                    signInDiv.innerHTML = 'Sign-in link sent to ' + email +
                        ".  Be sure to check your spam folder if you don't see it in your inbox." +
                        "<br/><br/>You can now close this tab.";

                    // And give it a light-blue background to draw attention
                    signInDiv.classList.add('info-box');

                    console.log('Sign-in email sent to ' + email);
                    // alert('Sign-in email sent to ' + email + ".  Be sure to check your spam folder if you don't see it in your inbox.");
                })
                .catch((error) => {
                    console.error('Error sending sign-in email: ', error);
                });
        }

        // Call this function on the page where users are redirected after clicking the sign-in link
        function completeSignInWithEmailLinkIfApplicable() {
            if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
                // Get the email if it's saved in local storage
                var email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    // User opened the link on a different device. You will need to prompt them for their email
                    email = window.prompt('Please provide your email for confirmation');
                }

                firebase.auth().signInWithEmailLink(email, window.location.href)
                    .then((result) => {
                        window.localStorage.removeItem('emailForSignIn'); // Clear the email from local storage

                        // User is signed in
                        var user = result.user;
                        console.log('User signed in: ', user);
                        updateUserDisplay(user);
                        checkLicence(user); // Call checkLicence after successful login

                        // Optional: Redirect to another page after successful sign in
                    })
                    .catch((error) => {
                        console.error('Error during Email Link sign in: ', error);

                        // Make the sign-in div an error class and display the error
                        var signInDiv = document.getElementById('sign-in-div');
                        signInDiv.innerHTML = 'Error during Email Link sign in.  Most likely, the link has been used already or is expired.  Please try again, and contact info@eagleeyessearch.com if you continue to have trouble.';
                        signInDiv.classList.add('error-box');
                        // And add a button to reload the page with just the machine_id (ie thisURLwithJustMachineIDArg)
                        signInDiv.innerHTML += '<br/><button onclick="location.href = \'' + thisURLwithJustMachineIDArg + '\'">Reload</button>';

                    });
            }
        }

        // Make sure to call completeSignInWithEmailLink() on the page load of your /get_licensed/ URL
        // window.onload = function () {
        //     completeSignInWithEmailLinkIfApplicable();
        // };


        function updateUserDisplay(user) {

            document.getElementById('user-info').innerHTML = 'Signed in as: ' + user.email + ' ( ' + user.displayName + ' )';
            // Give it that nice blue background by turning it into a .info-box
            document.getElementById('user-info').classList.add('info-box')
                ;
            document.getElementById('sign-in-div').style.display = 'none';
            // document.getElementById('email-sign-in-form').style.display = 'none';
            // Add a button to "change user" which just reloads this page from scratch - with the machine ID
            document.getElementById('user-info').innerHTML += '<br/><button onclick="location.reload()"  class="non_important_button">Change user</button>';
        }

        function reCheckLicence() {
            // First, temporarily hide the licenses section
            document.getElementById('licenses').hidden = true;
            // Wait 1/4 second so the user sees the section disappear
            setTimeout(function () {
                // Then, re-check the licence
                checkLicence(user);
            }, 250);
            // Then, re-check the licence
            checkLicence(user);
        }

        function checkLicence(user) {
            user.getIdToken().then(function (idToken) {
                //   var fetch_url = 'http://127.0.0.1:5001/eagleeyessearch/us-central1/check_available_licenses_and_tokens?machine_id=' + machineId;
                var fetch_url = 'http://127.0.0.1:5001/eagleeyessearch/us-central1/check_available_licenses_and_tokens?machine_id=' + machineId;
                console.log("Fetch URL: " + fetch_url);

                $.ajax({
                    url: fetch_url,
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + idToken
                    },
                    success: function (data) {

                        // Un-hide the licenses section
                        document.getElementById('licenses').hidden = false;

                        console.log('Data: ', data);

                        // Data has to be deserialized from JSON
                        data = JSON.parse(data);

                        // Empty the existing select elements
                        $('#licenses-container').empty();
                        $('#license-tokens-container').empty();

                        // Create licenses select element and append options

                        licensesSelect = $("#licenses-select");
                        console.log('Licenses: ', data.licenses);

                        // Add each license to the select element
                        if (!data.licenses) {
                            console.error('data.licenses is null or undefined');
                        } else {
                            Object.keys(data.licenses).forEach(function (licenseId) {
                                var license = data.licenses[licenseId];
                                console.log('License: ', license);
                                var option = $('<option></option>')
                                    .text(`Tier: ${license.tier}, Email: ${license.email}, Expiry: ${license.expiry_date}, ID: ${licenseId}`)
                                    .val(licenseId);  // Set the value attribute to licenseId
                                console.log('Option: ', option);
                                console.log("licensesSelect: ", licensesSelect);
                                console.log("Container: ", $('#licenses-container'));
                                licensesSelect.append(option);
                            });
                            //   $('#licenses-container').appeznd(licensesSelect);
                            var n_licenses = Object.keys(data.licenses).length;
                            $('#license .menu-title').text('Your Licenses (' + n_licenses + ' available)');

                        }

                        // Create license tokens select element and append options
                        var licenseTokensSelect = $('#license-tokens-select');
                        console.log('License tokens: ', data.license_tokens);
                        if (!data.license_tokens) {
                            console.error('data.license_tokens is null or undefined');
                        } else {
                            Object.keys(data.license_tokens).forEach(function (tokenId) {

                                var tokenAndCode = data.license_tokens[tokenId];
                                var token = data.license_tokens[tokenId].token;

                                console.log('Setting option value to ' + data.license_tokens[tokenId]);
                                console.log('And token: ', token)

                                tokenAndCodeSerialized = JSON.stringify(tokenAndCode);

                                var option = $('<option></option>')
                                    .text(`Tier: ${token.tier}, Email: ${token.email}, Machine ID: ${token.machine_id}, Expiry: ${token.expiry_date}, Code: ${token.code}`)
                                    .val(tokenAndCodeSerialized);  // Set the value attribute to tokenId

                                licenseTokensSelect.append(option);
                            });
                        }
                        var n_tokens = Object.keys(data.license_tokens).length;
                        $('#tokens .menu-title').text('Your License Tokens (' + n_tokens + ' available)');

                        if (n_tokens > 0) {
                            onSelectLicenceToken();
                        }


                        // Ok, now decide what divs are going to be open by default.
                        isATokenAvailable = n_tokens > 0;
                        toggleMenu('tokens', isATokenAvailable);
                        isALicenseAvailableWithIdNotInTokens = n_licenses > 0 && !Object.keys(data.license_tokens).includes(licensesSelect.val());
                        toggleMenu('license', isALicenseAvailableWithIdNotInTokens);
                        isNothingAvailable = n_licenses === 0 && n_tokens === 0;
                        toggleMenu('purchase', isNothingAvailable);

                        // Scroll to the bottom!
                        window.scrollTo(0, document.body.scrollHeight);
                    },
                    error: function (error) {
                        console.error('Error during license check: ', error);
                    }
                });
            });
        }

        function onSelectLicenceToken() {
            var licenseTokensSelect = document.getElementById('license-tokens-select');
            console.log('Index: ', licenseTokensSelect.selectedIndex);
            if (licenseTokensSelect.selectedIndex === -1) {
                return;  // Means no token is selected
            }
            var selectedTokenAndCodeSerialized = licenseTokensSelect.options[licenseTokensSelect.selectedIndex].value;
            var selectedTokenAndCode = JSON.parse(selectedTokenAndCodeSerialized); // Parse the JSON string back to an object

            var selectedToken = selectedTokenAndCode.token;
            // var selectedCode = selectedTokenAndCode.code;
            console.log('Selected token and code: ', selectedTokenAndCode);
            console.log('Selected token: ', selectedTokenAndCode.token);
            console.log('Selected code: ', selectedTokenAndCode.code);

            // var selectedToken = JSON.parse(selectedTokenAndCode.token); // Parse the JSON string back to an object

            // var selectedToken = licenseTokensSelect.options[licenseTokensSelect.selectedIndex].value;
            console.log('Selected token: ', selectedToken, "Fields: ", selectedToken.tier, selectedToken.email, selectedToken.machine_id, selectedToken.expiry_date, selectedToken.code);

            // Now update the license token info textarea (newline separated)
            var licenseTokenInfo = document.getElementById('license-token-info');
            licenseTokenInfo.value = `Tier: ${selectedToken.tier}\nEmail: ${selectedToken.email}\nMachine ID: ${selectedToken.machine_id}\nExpiry: ${selectedToken.expiry_date}\nCode: ${selectedToken.code}`;

            // Now update the license key textarea
            var licenseKey = document.getElementById('license-key');
            licenseKey.value = selectedTokenAndCode.code;

        }

        function copyLicenseKey() {
            var licenseKey = document.getElementById("license-key");
            licenseKey.select();
            document.execCommand("copy");
            var licenceCode = licenseKey.value;
            // Notify user that key has been copied, and can be pasted into eagle-eyes app



            // alert("License key has been copied to clipboard. You can now paste it into the Eagle Eyes app.");
            // Add an info box to the bottom of the licenses div to notify the user that the key has been copied.  Include the key

            var infoBox = document.createElement('div');
            infoBox.classList.add('info-box');
            infoBox.textContent = "Token has been copied to clipboard. You can now paste it into the Eagle Eyes app (click 'ðŸ”‘' button in app).";
            document.getElementById('licenses').appendChild(infoBox);
            // Scroll down to bottom to make sure the user sees the info box
            window.scrollTo(0, document.body.scrollHeight);

        }

        function toggleMenu(expandableMenuDivId, makeVisible = null) {
            // Use jQuery to select the menu and title elements within the specified div
            var $menu = $('#' + expandableMenuDivId + ' .menu-content').first();
            var $title = $('#' + expandableMenuDivId + ' .menu-title').first();

            if (makeVisible === null){
                makeVisible = ($menu.css('display') === 'none' || $menu.css('display') === '')
            }

            // Toggle the display of the menu
            if (makeVisible) {
                $menu.css('display', 'block');
                $title.removeClass('collapsed');
            } else {
                $menu.css('display', 'none');
                $title.addClass('collapsed');
            }
        }


        document.addEventListener("DOMContentLoaded", function () {
            // Initialize menus to be hidden
            var menus = document.getElementsByClassName('menu-content');
            for (var i = 0; i < menus.length; i++) {
                menus[i].style.display = "none";
            }
            onSelectLicenceToken();
            completeSignInWithEmailLinkIfApplicable();
        });


    </script>
</head>


<body>
    <h1>Eagle Eyes Login / Sign up</h1>

    <!-- Show the machine ID -->
    <p>Machine ID: <span id="machine-id"></span>

        <button onclick="openMachineIdDialog()" , class="non_important_button">Change</button>

        <dialog id="machine-id-dialog">
            <h3>Enter Machine ID</h3>
            <input type="text" id="new-machine-id" placeholder="Enter new Machine ID">
            <button onclick="updateMachineId()"
                style="display: inline-block; padding: 5px 10px; font-size: 12px;">Change</button>
            <button onclick="closeMachineIdDialog()"
                style="display: inline-block; padding: 5px 10px; font-size: 12px;">Cancel</button>
        </dialog>

        <script>
            function openMachineIdDialog() {
                var dialog = document.getElementById("machine-id-dialog");
                dialog.showModal();
            }

            function closeMachineIdDialog() {
                var dialog = document.getElementById("machine-id-dialog");
                dialog.close();
            }

            function updateMachineId() {
                var newMachineId = document.getElementById("new-machine-id").value;
                document.getElementById("machine-id").textContent = newMachineId;
                closeMachineIdDialog();
            }
        </script>

    <h2> Step 1: Sign in </h2>
    <div id="sign-in-div">


        <button id="google-sign-in-btn" onclick="signInWithGoogle()">Sign in with Google</button>
        or

        <div id="email-sign-in-form" style="display:none;">
            <input type="email" id="email" placeholder="Email" style="display:none;">
            <button id="sendSignInLinkBtn">Send Sign in Link</button>
        </div>
        <button id="showEmailInputBtn">Sign In With Email</button>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Event listener for the button to show email input
                document.getElementById('showEmailInputBtn').addEventListener('click', function () {
                    // Show the email sign-in form
                    document.getElementById('email-sign-in-form').style.display = 'block';
                    // Hide the initial button
                    this.style.display = 'none';
                    // And the google-sign-in button
                    document.getElementById('google-sign-in-btn').style.display = 'none';
                    // Focus on the email input for user convenience
                    document.getElementById('email').style.display = 'block'; // Make sure email input is visible
                    document.getElementById('email').focus();
                });

                // Attach the signInWithEmailLink function to the Send SignIn Link button
                document.getElementById('sendSignInLinkBtn').addEventListener('click', function () {
                    signInWithEmailLink();
                });
            });

        </script>


    </div>
    <!-- <button onclick="checkLicence()">Check again for available licenses and tokens</button> -->
    <br />

    <p id="user-info"></p> <!-- User info will be displayed here -->

    <section id="licenses" hidden>

        <h2>Step 2: Choose a Licence Token</h2>

        <div id="purchase" class="expandable-menu">
            <!-- <div> -->
            <div class="menu-title" onclick="toggleMenu('purchase')">Purchase License</div>
            <div class="menu-content">
                <button onclick="purchaseWithStripe()">Purchase with Stripe</button>
            </div>
        </div>

        <div id='license' class="expandable-menu">
            <!-- <div> -->
            <div class="menu-title" onclick="toggleMenu('license')">
                Your Licenses

            </div>
            <!-- A little "refresh" button on the right -->
            <!-- <button onclick="checkLicence()" style="float: right; margin-top: 10px;">â†»</button> -->
            <!-- No inline with title text please -->
            <div class="menu-content">
                <select id="licenses-select"></select>
                <button onclick="reCheckLicence(user)" class="non_important_button">â†»</button>
                <button onclick="requestTokenFromSelectedLicense()">Request token from selected license</button>
            </div>
        </div>

        <div id="tokens" class="expandable-menu">
            <div class="menu-title" onclick="toggleMenu('tokens')">Your
                License Tokens</div><span id="tokens-count"></span>
            <div class="menu-content">
                <!-- Wrap select and textareas in a div -->
                <div class="left-column">
                    <select id="license-tokens-select" onchange="onSelectLicenceToken()"></select>
                    <textarea id="license-token-info" rows="4" cols="50"></textarea>
                    <textarea id="license-key" rows="4" cols="50"></textarea>
                </div>
                <button onclick="reCheckLicence(user)" class="non_important_button">â†»</button>
                <!-- Button on the right -->
                <button id="copy-btn" onclick="copyLicenseKey()" title="Copy Token, then paste into Eagle Eyes App">Copy
                    token to clipboard</button>
            </div>
        </div>

    </section>

</body>