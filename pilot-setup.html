---
layout: main
title: Eagle Eyes Pilot Setup Assistant
permalink: /pilot-setup/
---

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="stylesheet" href="{{ '/css/form_buttons_and_boxes.css' | relative_url }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="{{ '/shared.js' | relative_url }}"></script>

<style>
    .setup-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 120px 20px 20px 20px;
    }
    
    .setup-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .setup-section.disabled {
        opacity: 0.5;
        pointer-events: none;
    }
    
    .step-header {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .step-number {
        background: #007bff;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        font-size: 18px;
    }
    
    .step-number.completed {
        background: #28a745;
    }
    
    .step-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .device-selection-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    
    .device-list-container {
        flex: 1;
        min-width: 0;
    }
    
    .device-list-container h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 18px;
    }
    
    .device-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
    }
    
    .device-tile {
        background: white;
        border: none;
        border-bottom: 1px solid #dee2e6;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .device-tile:last-child {
        border-bottom: none;
    }
    
    .device-tile:hover {
        background: #f8f9fa;
    }
    
    .device-tile.selected {
        background: #f0f7ff;
        border-left: 4px solid #007bff;
    }
    
    .device-tile.incompatible {
        background: #fff5f5;
        border-left: 4px solid #dc3545;
    }
    
    .device-tile.untested {
        background: #fffdf5;
        border-left: 4px solid #ffc107;
    }
    
    .device-image {
        width: 40px;
        height: 40px;
        background: #f8f9fa;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }
    
    .device-info {
        flex: 1;
        min-width: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .device-name {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    @media (max-width: 768px) {
        .device-selection-container {
            flex-direction: column;
        }
        
        .device-list {
            max-height: 200px;
        }
    }
    
    .compatibility-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        white-space: nowrap;
    }
    
    .status-supported {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-untested {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-incompatible {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .license-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .license-card {
        border: 1px solid #eee;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        background: white;
        cursor: pointer;
    }
    
    .license-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .license-card.selected {
        border-color: #007bff;
        background: #f0f7ff;
    }
    
    .license-header {
        background-color: #e6f2ff;
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        flex-direction: column;
    }
    
    .license-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .license-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
        color: #333;
    }
    
    .license-type-badge {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .license-id {
        font-size: 14px;
        color: #666;
        font-family: monospace;
        margin: 0;
    }
    
    .license-body {
        padding: 15px;
    }
    
    .license-detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .license-detail-item {
        font-size: 14px;
    }
    
    .license-detail-label {
        color: #666;
        font-weight: 500;
    }
    
    .license-detail-value {
        color: #333;
        font-weight: 400;
    }
    
    @media (max-width: 480px) {
        .license-detail-grid {
            grid-template-columns: 1fr;
            gap: 8px;
        }
    }
    
    .license-actions {
        text-align: center;
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-top: 15px;
    }
    
    .btn-select-license {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
    }
    
    .btn-select-license:hover {
        background: #0056b3;
    }
    
    .manual-license-entry {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .manual-license-entry h4 {
        margin-bottom: 15px;
        color: #333;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
    }
    
    .form-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .activation-code {
        font-family: 'Courier New', monospace;
        font-size: 32px;
        font-weight: bold;
        color: #007bff;
        text-align: center;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #007bff;
        margin: 20px 0;
        letter-spacing: 3px;
    }
    
    .activation-instructions {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .activation-instructions h4 {
        color: #1976d2;
        margin-bottom: 15px;
    }
    
    .activation-instructions p {
        margin-bottom: 10px;
        line-height: 1.6;
    }
    
    .computer-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .computer-warning .warning-icon {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 20px;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .hidden {
        display: none !important;
    }
</style>

<div class="setup-container">
    <div class="computer-warning">
        <div class="warning-icon">💻</div>
        <p>For the best experience, please access this setup assistant from a laptop or desktop computer.</p>
    </div>

    <h1>Eagle Eyes Pilot Setup Assistant</h1>
    <p class="lead">This assistant will help you set up Eagle Eyes Pilot on your drone controller. Follow the steps below to get started.</p>

    <!-- Sign In Section -->
    <section id="signin-section" class="setup-section">
        <div class="step-header">
            <div class="step-number">1</div>
            <h2 class="step-title">Sign In to Your Account</h2>
        </div>
        
        <!-- Sign in button (will trigger overlay) -->
        <div id="signinButtonSection" style="display: block; text-align: center; margin-bottom: 40px;">
            <p style="margin-bottom: 20px;">Sign in to access the setup assistant.</p>
            <button id="pilotSignInButton" class="button" onclick="showSignInOverlay()">Sign In or Create Account</button>
        </div>

        <!-- User info display (shown after sign-in) -->
        <div id="userInfoDisplay" style="display: none; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>Signed in as: <span id="userEmailDisplay"></span></div>
                <button id="signOutButton" class="button small" onclick="signOut()">Sign Out</button>
            </div>
        </div>
    </section>

    <!-- Step 1: Drone and Controller Selection -->
    <section id="step1" class="setup-section disabled">
        <div class="step-header">
            <div class="step-number">2</div>
            <h2 class="step-title">Select Your Drone and Controller</h2>
        </div>
        
        <div class="device-selection-container">
            <div class="device-list-container">
                <h3>Choose Your Drone</h3>
                <div class="device-list" id="droneList">
                    <div class="device-tile" data-device="mavic-3" data-compatibility="supported">
                        <div class="device-image">🚁</div>
                        <div class="device-info">
                            <div class="device-name">DJI Mavic 3</div>
                            <div class="compatibility-status status-supported">✅ Fully Supported</div>
                        </div>
                    </div>
                    <div class="device-tile" data-device="air-2s" data-compatibility="untested">
                        <div class="device-image">🚁</div>
                        <div class="device-info">
                            <div class="device-name">DJI Air 2S</div>
                            <div class="compatibility-status status-untested">⚠️ Likely Compatible</div>
                        </div>
                    </div>
                    <div class="device-tile" data-device="mini-3" data-compatibility="incompatible">
                        <div class="device-image">🚁</div>
                        <div class="device-info">
                            <div class="device-name">DJI Mini 3</div>
                            <div class="compatibility-status status-incompatible">❌ Not Supported</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="device-list-container" id="controllerContainer">
                <h3>Choose Your Controller</h3>
                <div class="device-list" id="controllerList">
                    <div class="device-tile" data-device="rc-n1" data-compatibility="supported">
                        <div class="device-image">🎮</div>
                        <div class="device-info">
                            <div class="device-name">DJI RC-N1</div>
                            <div class="compatibility-status status-supported">✅ Fully Supported</div>
                        </div>
                    </div>
                    <div class="device-tile" data-device="rc-pro" data-compatibility="untested">
                        <div class="device-image">🎮</div>
                        <div class="device-info">
                            <div class="device-name">DJI RC Pro</div>
                            <div class="compatibility-status status-untested">⚠️ Likely Compatible</div>
                        </div>
                    </div>
                    <div class="device-tile" data-device="rc-2" data-compatibility="incompatible">
                        <div class="device-image">🎮</div>
                        <div class="device-info">
                            <div class="device-name">DJI RC 2</div>
                            <div class="compatibility-status status-incompatible">❌ Not Supported</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="compatibilityMessage" class="compatibility-message" style="display: none; margin-top: 20px; padding: 15px; border-radius: 8px;"></div>
    </section>

    <!-- Step 2: License Selection -->
    <section id="step2" class="setup-section disabled hidden">
        <div class="step-header">
            <div class="step-number">3</div>
            <h2 class="step-title">Select Your License</h2>
        </div>
        
        <div class="loading-spinner" id="licensesLoading">
            <div class="spinner"></div>
            <p>Loading your licenses...</p>
        </div>
        
        <div id="licensesContainer" class="hidden">
            <h3>Your Active Licenses</h3>
            <div class="license-grid" id="licenseGrid"></div>
            
            <div class="manual-license-entry">
                <h4>Don't see your license?</h4>
                <p>If you have a license ID that's not showing above, you can add it to your account:</p>
                <div class="form-group">
                    <label for="manualLicenseId">License ID:</label>
                    <input type="text" id="manualLicenseId" placeholder="Enter your license ID">
                </div>
                <button id="addLicenseBtn" class="btn-select-license">Add License to Account</button>
            </div>
        </div>
    </section>

    <!-- Step 3: Activation Code -->
    <section id="step3" class="setup-section disabled hidden">
        <div class="step-header">
            <div class="step-number">4</div>
            <h2 class="step-title">Setup Eagle Eyes Pilot</h2>
        </div>
        
        <div class="loading-spinner" id="activationLoading">
            <div class="spinner"></div>
            <p>Generating activation code...</p>
        </div>
        
        <div id="activationContainer" class="hidden">
            <h3>Your Activation Code</h3>
            <div class="activation-code" id="activationCode"></div>
            
            <div class="activation-instructions">
                <h4>Setup Instructions</h4>
                <p><strong>Step 1:</strong> On your drone controller, open a web browser and navigate to:</p>
                <p><strong>eagleeyessearch.com/activate</strong></p>
                <p><strong>Step 2:</strong> Enter the activation code shown above</p>
                <p><strong>Step 3:</strong> Follow the on-screen instructions to complete the setup</p>
                <p><strong>Note:</strong> This activation code is valid for 24 hours and can only be used once.</p>
            </div>
        </div>
    </section>
</div>

<!-- Sign-in overlay -->
<div id="signin-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; width: 100%; height: 100%;">
        {% include signinwidget-main.html %}
    </div>
</div>

<script>
    let selectedDrone = null;
    let selectedController = null;
    let selectedLicense = null;
    let userLicenses = [];
    
    var useLocalFirebaseEmulator = getIsEmulatorFromURL();
    var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
    
    $(document).ready(function() {
        // Show emulator info if in emulator mode
        if (useLocalFirebaseEmulator) {
            console.log('Running in emulator mode');
            // Add emulator banner
            const emulatorBanner = $(`
                <div id="emulator-banner" style="background-color: #ff9800; color: black; padding: 10px; text-align: center; font-weight: bold; margin-bottom: 20px;">
                    🧪 Emulator Mode: Use test account 
                    <button id="test-user-login" style="cursor: pointer; background-color: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 10px;">Sign in as test@example.com</button>
                </div>
            `);
            $('.setup-container').prepend(emulatorBanner);
            
            // Set up test user login
            $('#test-user-login').click(function() {
                const testEmail = 'test@example.com';
                const testPassword = 'password123';
                
                // Try to sign in first
                firebase.auth().signInWithEmailAndPassword(testEmail, testPassword)
                    .then((userCredential) => {
                        console.log('Test user signed in successfully');
                    })
                    .catch((error) => {
                        // If sign-in fails, create the user first
                        if (error.code === 'auth/user-not-found') {
                            console.log('Test user not found, creating account...');
                            firebase.auth().createUserWithEmailAndPassword(testEmail, testPassword)
                                .then((userCredential) => {
                                    console.log('Test user created and signed in successfully');
                                })
                                .catch((createError) => {
                                    console.error('Error creating test user:', createError);
                                });
                        } else {
                            console.error('Error signing in with test user:', error);
                        }
                    });
            });
            
            // Auto-sign in for development convenience
            console.log('Auto-signing in as joep@eagleeyessearch.com for development');
            firebase.auth().signInWithEmailAndPassword('joep@eagleeyessearch.com', 'test-password-for-emulator')
                .then(function(userCredential) {
                    console.log('Auto-signed in for local development');
                })
                .catch(function(error) {
                    console.error('Auto-sign in failed:', error);
                });
        }
        
        // Use Firebase's built-in auth state observer for automatic sign-in detection
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                console.log('User is already signed in:', user.email);
                // User is signed in - hide signin section and show user info
                document.getElementById('signinButtonSection').style.display = 'none';
                document.getElementById('userEmailDisplay').textContent = user.email;
                document.getElementById('userInfoDisplay').style.display = 'block';
                
                // Hide the signin overlay if it's showing
                document.getElementById('signin-overlay').style.display = 'none';
                
                // Enable step 1
                enableStep1();
            } else {
                console.log('User is not signed in');
                // User is not signed in - show signin section
                document.getElementById('signinButtonSection').style.display = 'block';
                document.getElementById('userInfoDisplay').style.display = 'none';
            }
        });
        
        // Listen for successful sign-in from overlay
        document.addEventListener('signInComplete', function(e) {
            console.log('User signed in via overlay, enabling step 1');
            const user = e.detail.user;
            document.getElementById('signin-overlay').style.display = 'none';
            enableStep1();
        });
        
        // Drone selection
        $('#droneList .device-tile').click(function() {
            const device = $(this).data('device');
            const compatibility = $(this).data('compatibility');
            
            console.log('Drone selected:', device, 'compatibility:', compatibility);
            
            if (compatibility === 'incompatible') {
                showCompatibilityMessage('This drone is not supported by Eagle Eyes Pilot. DJI has not released the necessary developer tools to enable compatibility with this setup.', 'error');
                return;
            }
            
            $('#droneList .device-tile').removeClass('selected');
            $(this).addClass('selected');
            selectedDrone = device;
            
            console.log('selectedDrone set to:', selectedDrone);
            showCompatibilityMessage('', '');
        });
        
        // Controller selection
        $('#controllerList .device-tile').click(function() {
            const device = $(this).data('device');
            const compatibility = $(this).data('compatibility');
            
            console.log('Controller selected:', device, 'compatibility:', compatibility);
            
            if (compatibility === 'incompatible') {
                showCompatibilityMessage('This controller is not supported by Eagle Eyes Pilot. DJI has not released the necessary developer tools to enable compatibility with this setup.', 'error');
                return;
            }
            
            $('#controllerList .device-tile').removeClass('selected');
            $(this).addClass('selected');
            selectedController = device;
            
            console.log('selectedController set to:', selectedController);
            showFinalCompatibilityMessage();
            
            // Enable step 2 if both devices are selected and compatible
            console.log('Checking if both devices selected:', selectedDrone, selectedController);
            if (selectedDrone && selectedController) {
                console.log('Both devices selected, enabling step 2 in 1 second');
                setTimeout(() => {
                    enableStep2();
                }, 1000);
            }
        });
        
        // Manual license addition
        $('#addLicenseBtn').click(function() {
            const licenseId = $('#manualLicenseId').val().trim();
            if (!licenseId) {
                alert('Please enter a license ID');
                return;
            }
            
            addLicenseToAccount(licenseId);
        });
    });
    
    function showSignInOverlay() {
        document.getElementById('signin-overlay').style.display = 'block';
    }
    
    function signOut() {
        firebase.auth().signOut().then(function() {
            console.log('User signed out successfully');
            // Reset the setup process
            selectedDrone = null;
            selectedController = null;
            selectedLicense = null;
            userLicenses = [];
            
            // Reset UI
            $('#step1').addClass('disabled');
            $('#step2').addClass('disabled').addClass('hidden');
            $('#step3').addClass('disabled').addClass('hidden');
            $('#step1 .step-number').removeClass('completed');
            $('#step2 .step-number').removeClass('completed');
            $('#step3 .step-number').removeClass('completed');
            
            // Clear selections
            $('.device-tile').removeClass('selected');
            $('.license-card').removeClass('selected');
            $('#compatibilityMessage').hide();
            
        }).catch(function(error) {
            console.error('Error signing out:', error);
        });
    }
    
    function enableStep1() {
        $('#step1').removeClass('disabled');
        $('#signin-section .step-number').addClass('completed');
    }
    
    function enableStep2() {
        console.log('enableStep2 called');
        $('#step2').removeClass('disabled').removeClass('hidden');
        $('#step1 .step-number').addClass('completed');
        loadUserLicenses();
    }
    
    function enableStep3() {
        $('#step3').removeClass('disabled').removeClass('hidden');
        $('#step2 .step-number').addClass('completed');
        generateActivationCode();
    }
    
    function showCompatibilityMessage(message, type) {
        const messageDiv = $('#compatibilityMessage');
        if (!message) {
            messageDiv.hide();
            return;
        }
        
        messageDiv.removeClass('status-supported status-untested status-incompatible');
        
        if (type === 'error') {
            messageDiv.addClass('status-incompatible');
        } else if (type === 'warning') {
            messageDiv.addClass('status-untested');
        } else {
            messageDiv.addClass('status-supported');
        }
        
        messageDiv.text(message).show();
    }
    
    function showFinalCompatibilityMessage() {
        const droneCompatibility = $('#droneList .device-tile.selected').data('compatibility');
        const controllerCompatibility = $('#controllerList .device-tile.selected').data('compatibility');
        
        if (droneCompatibility === 'supported' && controllerCompatibility === 'supported') {
            showCompatibilityMessage('✅ This drone and controller combination is fully supported. We\'ve tested this setup with Eagle Eyes Pilot and confirmed it works as expected.', 'success');
        } else if (droneCompatibility === 'untested' || controllerCompatibility === 'untested') {
            showCompatibilityMessage('⚠️ This setup is likely compatible, but untested. According to DJI documentation, this drone and controller support the SDK (v4) used by Eagle Eyes Pilot. However, we haven\'t tested this combination ourselves, so we can\'t guarantee full compatibility.', 'warning');
        }
    }
    
    function loadUserLicenses() {
        console.log('loadUserLicenses called');
        $('#licensesLoading').show();
        $('#licensesContainer').addClass('hidden');
        
        const globalUser = firebase.auth().currentUser;
        if (!globalUser) {
            console.error('No user authenticated in loadUserLicenses');
            $('#licensesLoading').hide();
            $('#licensesContainer').removeClass('hidden');
            $('#licenseGrid').html('<p>Please sign in to view your licenses.</p>');
            return;
        }
        
        console.log('User authenticated, getting ID token for:', globalUser.email);
        
        globalUser.getIdToken(true).then(function(idToken) {
            var fetch_url = hostURL + '/check_available_licenses_and_tokens?machine_id=pilot-setup';
            $.ajax({
                url: fetch_url,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(response) {
                    console.log('Raw licenses response:', response);
                    console.log('Response type:', typeof response);
                    
                    let data;
                    try {
                        data = typeof response === 'string' ? JSON.parse(response) : response;
                        console.log('Parsed data:', data);
                    } catch (e) {
                        console.error('Failed to parse license response:', e);
                        $('#licensesLoading').hide();
                        $('#licensesContainer').removeClass('hidden');
                        $('#licenseGrid').html('<p>Error parsing license data. Please try again.</p>');
                        return;
                    }
                    
                    // Extract licenses from the response structure
                    userLicenses = [];
                    console.log('Checking for licenses_and_dispensed:', data.licenses_and_dispensed);
                    
                    if (data.licenses_and_dispensed) {
                        for (const licenseId in data.licenses_and_dispensed) {
                            const licenseData = data.licenses_and_dispensed[licenseId];
                            console.log('Processing license:', licenseId, licenseData);
                            
                            if (licenseData.license) {
                                const licenseInfo = {
                                    license_id: licenseId,
                                    license_name: licenseData.license.license_name || 'Eagle Eyes License',
                                    license_type: licenseData.license.license_type || 'Standard',
                                    expiry_timestamp: licenseData.license.expiry_timestamp,
                                    remaining_keys: licenseData.license.n_tokens - (licenseData.dispensed_tokens ? licenseData.dispensed_tokens.length : 0)
                                };
                                console.log('Adding license:', licenseInfo);
                                userLicenses.push(licenseInfo);
                            }
                        }
                    }
                    
                    console.log('Final userLicenses array:', userLicenses);
                    displayLicenses();
                    $('#licensesLoading').hide();
                    $('#licensesContainer').removeClass('hidden');
                },
                error: function(xhr, status, error) {
                    console.error('Error loading licenses:', error);
                    $('#licensesLoading').hide();
                    $('#licensesContainer').removeClass('hidden');
                    $('#licenseGrid').html('<p>Error loading licenses. Please try again.</p>');
                }
            });
        });
    }
    
    function displayLicenses() {
        console.log('displayLicenses called with:', userLicenses);
        const licenseGrid = $('#licenseGrid');
        licenseGrid.empty();
        
        if (userLicenses.length === 0) {
            console.log('No licenses to display');
            licenseGrid.html('<p>No active licenses found. Please add a license using the form below.</p>');
            return;
        }
        
        console.log('Creating license cards for', userLicenses.length, 'licenses');
        
        userLicenses.forEach(function(license) {
            const expiryDate = license.expiry_timestamp ? 
                new Date(license.expiry_timestamp * 1000).toLocaleDateString() : 
                'No expiry';
            
            const licenseCard = $(`
                <div class="license-card" data-license-id="${license.license_id}" onclick="selectLicense('${license.license_id}')">
                    <div class="license-header">
                        <div class="license-title-row">
                            <h3 class="license-title">${license.license_name || 'Eagle Eyes License'}</h3>
                        </div>
                        <p class="license-id">License ID: ${license.license_id}</p>
                    </div>
                    <div class="license-body">
                        <div class="license-detail-grid">
                            <div class="license-detail-item">
                                <div class="license-detail-label">Expires: <span class="license-detail-value">${expiryDate}</span></div>
                            </div>
                            <div class="license-detail-item">
                                <div class="license-detail-label">Remaining Keys: <span class="license-detail-value">${license.remaining_keys || 'Unlimited'}</span></div>
                            </div>
                        </div>
                        <div class="license-actions">
                            <button class="btn-select-license" onclick="event.stopPropagation(); selectLicense('${license.license_id}')">
                                Use This License for Setup
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            licenseGrid.append(licenseCard);
        });
    }
    
    function selectLicense(licenseId) {
        $('.license-card').removeClass('selected');
        $(`.license-card[data-license-id="${licenseId}"]`).addClass('selected');
        selectedLicense = licenseId;
        
        // Enable step 3 after a short delay
        setTimeout(() => {
            enableStep3();
            // Scroll to the bottom of the page after step 3 is enabled
            setTimeout(() => {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }, 500);
    }
    
    function addLicenseToAccount(licenseId) {
        const globalUser = firebase.auth().currentUser;
        if (!globalUser) {
            console.error('No user authenticated');
            return;
        }
        
        $('#addLicenseBtn').text('Adding...').prop('disabled', true);
        
        globalUser.getIdToken(true).then(function(idToken) {
            var fetch_url = hostURL + '/check_available_licenses_and_tokens?machine_id=pilot-setup&license_id=' + licenseId;
            $.ajax({
                url: fetch_url,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(response) {
                    console.log('License added successfully:', response);
                    $('#manualLicenseId').val('');
                    $('#addLicenseBtn').text('Add License to Account').prop('disabled', false);
                    
                    // Reload licenses to show the newly added one
                    loadUserLicenses();
                    
                    alert('License added successfully to your account!');
                },
                error: function(xhr, status, error) {
                    console.error('Error adding license:', error);
                    $('#addLicenseBtn').text('Add License to Account').prop('disabled', false);
                    
                    let errorMessage = 'Failed to add license. ';
                    if (xhr.status === 500 && xhr.responseText && xhr.responseText.includes("'NoneType' object has no attribute 'expiry_timestamp'")) {
                        errorMessage = `License ID "${licenseId}" was not found in our database. Please check that you entered the license ID correctly.`;
                    } else if (xhr.responseText) {
                        errorMessage += xhr.responseText;
                    } else {
                        errorMessage += 'Please check the license ID and try again.';
                    }
                    
                    alert(errorMessage);
                }
            });
        });
    }
    
    function generateActivationCode() {
        $('#activationLoading').show();
        $('#activationContainer').addClass('hidden');
        
        const globalUser = firebase.auth().currentUser;
        if (!globalUser) {
            console.error('No user authenticated');
            return;
        }
        
        globalUser.getIdToken(true).then(function(idToken) {
            // Mock function call - in real implementation, this would call the backend
            // For now, we'll simulate the API call
            $.ajax({
                url: hostURL + '/create_activation_request',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                data: JSON.stringify({
                    license_id: selectedLicense,
                    user_email: globalUser.email,
                    device_info: {
                        drone: selectedDrone,
                        controller: selectedController
                    }
                }),
                success: function(response) {
                    console.log('Activation code generated:', response);
                    const responseData = JSON.parse(response);
                    displayActivationCode(responseData.activation_code);
                },
                error: function(xhr, status, error) {
                    console.error('Error generating activation code:', error);
                    // For demo purposes, generate a mock code
                    const mockCode = generateMockActivationCode();
                    displayActivationCode(mockCode);
                }
            });
        });
    }
    
    function displayActivationCode(code) {
        $('#activationCode').text(code);
        $('#activationLoading').hide();
        $('#activationContainer').removeClass('hidden');
        $('#step3 .step-number').addClass('completed');
    }
    
    function generateMockActivationCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 6; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }
</script>